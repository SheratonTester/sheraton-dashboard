<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheraton Niagara Falls – Ops Dashboard</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --brand:#2563eb;

      /* status colors (easy to see) */
      --green:#0f5132;  /* dark green */
      --red:#7a1f28;    /* dark red */

      --shadow: 0 10px 25px rgba(2,6,23,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans";
      background: var(--bg);
      color: var(--ink);
    }
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    .topbar{
      position: sticky; top:0; z-index: 20;
      background: rgba(246,248,255,.82);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 16px;
      max-width:1200px; margin:0 auto;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title h1{font-size:16px; margin:0; font-weight:800; letter-spacing:.2px}
    .title .sub{font-size:12px; color:var(--muted)}
    .pills{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:12px; color:#0b1220;
      background:#ffffff;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      box-shadow: 0 2px 10px rgba(2,6,23,.04);
      white-space:nowrap;
    }
    .nav{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background: #fff;
      color: var(--ink);
      padding:9px 12px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(2,6,23,.06);
    }
    .btn.primary{
      background: var(--brand);
      border-color: transparent;
      color: #fff;
    }
    .btn.danger{
      background:#ef4444;
      border-color:transparent;
      color:#fff;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .grid{display:grid; gap:14px}
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card-h{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      padding:14px 16px 0 16px;
    }
    .card-h h2{margin:0; font-size:14px; letter-spacing:.2px}
    .card-h .hint{font-size:12px; color:var(--muted); margin-top:2px}
    .card-b{padding:14px 16px 16px 16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field{
      display:flex; gap:8px; align-items:center;
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
    }
    .field label{font-size:12px; color:var(--muted)}
    input[type="date"], input[type="number"], input[type="text"], input[type="time"], select, textarea{
      font: inherit;
      border:none;
      outline:none;
      background:transparent;
      color:var(--ink);
    }
    textarea{
      width:100%;
      min-height:120px;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px;
      background:#fff;
    }
    .msg{
      margin-top:10px;
      font-size:12px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
    }
    .msg.err{border-color:#fecaca; background:#fff1f2; color:#7f1d1d}
    .msg.ok{border-color:#bbf7d0; background:#ecfdf5; color:#064e3b}

    /* Occupancy cards */
    .occ-wrap{
      display:flex; gap:10px;
      overflow:auto;
      padding-bottom:6px;
      scroll-snap-type: x mandatory;
    }
    .occ{
      min-width: 170px;
      scroll-snap-align: start;
      border:1px solid var(--line);
      border-radius: 14px;
      padding:12px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .occ .d1{font-weight:800; font-size:12px}
    .occ .d2{font-size:11px; color:var(--muted); margin-top:2px}
    .occ .pct{font-size:22px; font-weight:900; margin-top:8px}
    .occ .meta{font-size:11px; color:var(--muted); margin-top:8px; line-height:1.25}
    .occ.disabled{opacity:.6; cursor:not-allowed}

    /* Matrix */
    .matrix-wrap{
      overflow:auto;
      border-radius: 14px;
      border:1px solid var(--line);
    }
    table.matrix{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 860px;
      background:#fff;
    }
    .matrix th, .matrix td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:10px;
      vertical-align:middle;
      font-size:12px;
    }
    .matrix th{
      position:sticky; top:0; z-index:2;
      background:#f1f5ff;
      font-weight:900;
      text-align:center;
    }
    .matrix th:first-child{
      left:0; z-index:3; text-align:left;
    }
    .matrix td:first-child, .matrix th:first-child{
      position:sticky; left:0;
      background:#fff;
      min-width: 280px;
      max-width: 280px;
      border-right:1px solid var(--line);
      z-index:1;
    }
    .section-row td{
      background:#0b1220;
      color:#fff;
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size:12px;
      padding:9px 10px;
    }
    .section-row td:first-child{background:#0b1220}
    .svc-name{
      font-weight:900;
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .tag{
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:#fff;
    }
    .cell{
      height:44px;
      border-radius:10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      border:1px solid rgba(0,0,0,.05);
    }
    .cell.red{background: var(--red)}
    .cell.green{background: var(--green)}
    .cell.disabled{opacity:.55; cursor:not-allowed}

    /* Outlet grid */
    .outlet-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .outlet-row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fff;
    }
    .outlet-name{font-weight:900; min-width:140px}
    .outlet-mini{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      overflow:auto;
      padding-bottom:4px;
      max-width:100%;
    }
    .mini{
      min-width: 150px;
      border-radius: 12px;
      border:1px solid var(--line);
      padding:10px;
      background:#fff;
    }
    .mini .d{font-weight:900; font-size:12px}
    .mini .s{margin-top:8px; font-weight:900}
    .mini.open .s{color: var(--green)}
    .mini.closed .s{color: var(--red)}
    .mini .m{margin-top:6px; font-size:11px; color:var(--muted); line-height:1.25}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.58);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000;
      padding:16px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(820px, 100%);
      max-height: 92vh;
      overflow:auto;
      background:#fff;
      border-radius: 18px;
      border:1px solid var(--line);
      box-shadow: 0 30px 80px rgba(2,6,23,.35);
    }
    .modal-h{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position: sticky; top:0; background:#fff; z-index:2;
    }
    .modal-h strong{font-size:14px}
    .modal-b{padding:14px 16px 16px}
    .formgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .fbox{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 12px;
      background:#fff;
    }
    .fbox label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .fbox input, .fbox select{width:100%}
    .formgrid.one{grid-template-columns: 1fr}

    /* Login */
    .login{
      min-height: calc(100vh - 64px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .loginbox{
      width:min(520px,100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .loginbox h2{margin:0 0 6px; font-size:16px}
    .loginbox p{margin:0 0 14px; font-size:12px; color:var(--muted)}
    .loginbox .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .smalllink{font-size:12px; color:var(--brand); cursor:pointer; font-weight:800}

    /* PRINT SNAPSHOT MODE */
    body.printing #appView{display:none !important;}
    body.printing #printArea{display:block !important;}
    #printArea{display:none;}
    @media print{
      body{background:#fff !important;}
      #printArea{display:block !important;}
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="title">
        <h1>Sheraton Niagara Falls – Ops Dashboard</h1>
        <div class="sub">Times always shown in America/Toronto</div>
      </div>

      <div class="pills" id="whoPills" style="display:none;">
        <div class="pill" id="pillRole"></div>
        <div class="pill" id="pillDept"></div>
        <div class="pill" id="pillUser"></div>
      </div>

      <div class="nav" id="navBtns" style="display:none;">
        <button class="btn" id="btnDashboard">Dashboard</button>
        <button class="btn primary" id="btnUsers" style="display:none;">Users</button>
        <button class="btn danger" id="btnLogout">Logout</button>
      </div>
    </div>
  </div>

  <!-- App view -->
  <div id="appView">
    <div class="wrap">

      <!-- library status -->
      <div id="libMsg" class="msg" style="display:none;"></div>

      <!-- LOGIN -->
      <div id="loginView" class="login" style="display:none;">
        <div class="loginbox">
          <h2>Sign in</h2>
          <p>Sheraton Niagara Falls Dashboard</p>

          <div class="fbox" style="margin-bottom:10px;">
            <label>Email</label>
            <input id="loginEmail" type="text" placeholder="name@niagarafallshotels.com" />
          </div>

          <div class="fbox">
            <label>Password</label>
            <input id="loginPass" type="text" placeholder="••••••••" />
          </div>

          <div class="actions">
            <button class="btn primary" id="btnSignIn">Sign in</button>
            <button class="btn" id="btnForgot">Send password reset</button>
          </div>

          <div id="loginMsg" class="msg" style="display:none;"></div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="dashView" style="display:none;" class="grid">
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Controls</h2>
              <div class="hint">Pick a start date (7 days). Print makes a clean snapshot.</div>
            </div>
          </div>
          <div class="card-b">
            <div class="row">
              <div class="field">
                <label>Start date</label>
                <input id="startDate" type="date" />
              </div>
              <button class="btn" id="btnToday">Today</button>
              <button class="btn primary" id="btnRefresh">Refresh</button>
              <button class="btn" id="btnPrint">Print 7-day snapshot (PDF)</button>
            </div>
            <div id="appMsg" class="msg" style="display:none;"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <h2>7-Day Occupancy Forecast</h2>
              <div class="hint">Click a day card to edit (Guest Service or Admin).</div>
            </div>
            <div class="hint" id="occPermHint"></div>
          </div>
          <div class="card-b">
            <div class="occ-wrap" id="occWrap"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <h2>Restaurant Status</h2>
              <div class="hint">Breakfast/Lunch/Dinner: only one green per day. Double-click green to clear (all closed).</div>
            </div>
            <div class="hint" id="fbPermHint"></div>
          </div>
          <div class="card-b">
            <div class="matrix-wrap">
              <table class="matrix" id="restTable"></table>
            </div>
            <div id="restMsg" class="msg" style="display:none;"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <div>
              <h2>Lobby Bar + Outlets</h2>
              <div class="hint">If a day is Open, hours are required. “Edit week” lets you update multiple days at once.</div>
            </div>
            <div class="hint" id="outletPermHint"></div>
          </div>
          <div class="card-b">
            <div class="outlet-grid" id="outletGrid"></div>
            <div id="outletMsg" class="msg" style="display:none;"></div>
          </div>
        </div>
      </div>

      <!-- USERS -->
      <div id="usersView" style="display:none;" class="grid">
        <div class="card">
          <div class="card-h">
            <div>
              <h2>Admin – Users</h2>
              <div class="hint">Select a user, then update name, role, and department. (No UIDs shown.)</div>
            </div>
          </div>
          <div class="card-b">
            <div class="formgrid">
              <div class="fbox">
                <label>Select user</label>
                <select id="userSelect"></select>
              </div>
              <div class="fbox">
                <label>Email (read only)</label>
                <input id="userEmail" type="text" readonly />
              </div>
              <div class="fbox">
                <label>Full name</label>
                <input id="userName" type="text" />
              </div>
              <div class="fbox">
                <label>Role</label>
                <select id="userRole">
                  <option value="admin">admin</option>
                  <option value="user">user</option>
                  <option value="viewer">viewer</option>
                </select>
              </div>
              <div class="fbox">
                <label>Department</label>
                <select id="userDept">
                  <option value="">(none)</option>
                  <option value="Guest Service">Guest Service</option>
                  <option value="F&B">F&B</option>
                  <option value="Outlets">Outlets</option>
                </select>
              </div>
              <div class="fbox">
                <label>Active</label>
                <select id="userActive">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="btnUserSave">Save changes</button>
              <button class="btn" id="btnUserReload">Reload list</button>
            </div>

            <div id="usersMsg" class="msg" style="display:none;"></div>

            <div style="margin-top:14px;" class="matrix-wrap">
              <table class="matrix" id="usersTable"></table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PRINT SNAPSHOT AREA (hidden until printing) -->
  <div id="printArea"></div>

  <!-- MODALS -->
  <div class="overlay" id="occOverlay">
    <div class="modal">
      <div class="modal-h">
        <strong id="occTitle">Edit occupancy</strong>
        <button class="btn" id="occClose">Close</button>
      </div>
      <div class="modal-b">
        <div class="formgrid">
          <div class="fbox">
            <label>Occupancy % (0–100)</label>
            <input id="occPct" type="number" min="0" max="100" step="0.1" />
          </div>
          <div class="fbox">
            <label>Notes (short)</label>
            <input id="occShort" type="text" placeholder="Optional" />
          </div>
        </div>

        <div class="formgrid one" style="margin-top:12px;">
          <div class="fbox" style="padding:0; border:none;">
            <label style="padding:10px 12px 0;">Notes (long)</label>
            <textarea id="occLong" placeholder="Write longer notes here (easy to read)"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="occSave">Save</button>
        </div>
        <div id="occMsg" class="msg" style="display:none;"></div>
      </div>
    </div>
  </div>

  <div class="overlay" id="outOverlay">
    <div class="modal">
      <div class="modal-h">
        <strong id="outTitle">Edit week</strong>
        <button class="btn" id="outClose">Close</button>
      </div>
      <div class="modal-b">
        <div class="fbox">
          <label>Outlet</label>
          <select id="outOutlet"></select>
        </div>

        <div style="margin-top:12px;" class="matrix-wrap">
          <table class="matrix" id="outWeekTable"></table>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="outSave">Save week</button>
        </div>
        <div id="outEditMsg" class="msg" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- SUPABASE LIB (LOCAL) -->
  <!-- IMPORTANT: keep a file named supabase.js in your repo root (same folder as index.html) -->
  <script src="./supabase.js"></script>

  <script>
    /***************
      CONFIG
    ***************/
    const SUPABASE_URL = "https://jiarjsvoumbbilfsqftj.supabase.co";
    const SUPABASE_KEY = "sb_publishable_AB6JsEiTT1V5Bu5ANA0Qmw_yFE8M0NV";

    const TZ = "America/Toronto";

    const GROUPS = [
      { key: "breakfast", label: "BREAKFAST" },
      { key: "lunch", label: "LUNCH" },
      { key: "dinner", label: "DINNER" },
      { key: "massimo", label: "MASSIMO" }
    ];

    // Lobby Bar is controlled by F&B only
    const OUTLET_ITEMS = [
      { name: "LOBBY BAR", dept: "F&B" },
      { name: "STARBUCKS", dept: "Outlets" },
      { name: "SWEET JESUS", dept: "Outlets" },
      { name: "FRESHII", dept: "Outlets" },
    ];

    /***************
      DOM
    ***************/
    const libMsg = document.getElementById("libMsg");

    const whoPills = document.getElementById("whoPills");
    const pillRole = document.getElementById("pillRole");
    const pillDept = document.getElementById("pillDept");
    const pillUser = document.getElementById("pillUser");

    const navBtns = document.getElementById("navBtns");
    const btnDashboard = document.getElementById("btnDashboard");
    const btnUsers = document.getElementById("btnUsers");
    const btnLogout = document.getElementById("btnLogout");

    const loginView = document.getElementById("loginView");
    const dashView = document.getElementById("dashView");
    const usersView = document.getElementById("usersView");

    const loginEmail = document.getElementById("loginEmail");
    const loginPass = document.getElementById("loginPass");
    const btnSignIn = document.getElementById("btnSignIn");
    const btnForgot = document.getElementById("btnForgot");
    const loginMsg = document.getElementById("loginMsg");

    const startDateEl = document.getElementById("startDate");
    const btnToday = document.getElementById("btnToday");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnPrint = document.getElementById("btnPrint");
    const appMsg = document.getElementById("appMsg");

    const occWrap = document.getElementById("occWrap");
    const occPermHint = document.getElementById("occPermHint");

    const restTable = document.getElementById("restTable");
    const restMsg = document.getElementById("restMsg");
    const fbPermHint = document.getElementById("fbPermHint");

    const outletGrid = document.getElementById("outletGrid");
    const outletMsg = document.getElementById("outletMsg");
    const outletPermHint = document.getElementById("outletPermHint");

    // occupancy modal
    const occOverlay = document.getElementById("occOverlay");
    const occTitle = document.getElementById("occTitle");
    const occClose = document.getElementById("occClose");
    const occPct = document.getElementById("occPct");
    const occShort = document.getElementById("occShort");
    const occLong = document.getElementById("occLong");
    const occSave = document.getElementById("occSave");
    const occMsg = document.getElementById("occMsg");

    // outlet modal
    const outOverlay = document.getElementById("outOverlay");
    const outTitle = document.getElementById("outTitle");
    const outClose = document.getElementById("outClose");
    const outOutlet = document.getElementById("outOutlet");
    const outWeekTable = document.getElementById("outWeekTable");
    const outSave = document.getElementById("outSave");
    const outEditMsg = document.getElementById("outEditMsg");

    // users
    const userSelect = document.getElementById("userSelect");
    const userEmail = document.getElementById("userEmail");
    const userName = document.getElementById("userName");
    const userRole = document.getElementById("userRole");
    const userDept = document.getElementById("userDept");
    const userActive = document.getElementById("userActive");
    const btnUserSave = document.getElementById("btnUserSave");
    const btnUserReload = document.getElementById("btnUserReload");
    const usersMsg = document.getElementById("usersMsg");
    const usersTable = document.getElementById("usersTable");

    /***************
      SUPABASE INIT
    ***************/
    function showLibError(msg){
      libMsg.style.display = "block";
      libMsg.className = "msg err";
      libMsg.textContent = msg;
    }

    if (!window.supabase || !window.supabase.createClient){
      showLibError("Supabase library is missing. Make sure supabase.js is in your repo root (same folder as index.html).");
    }

    const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    /***************
      STATE
    ***************/
    let session = null;
    let me = null; // {user_id, full_name, email, role, department, active}

    let dashboardDays = []; // [{day, label, occupancy_percent, notes_short, notes_long, updated_at, updated_by_name}]
    let serviceItems = [];  // from service_items
    let serviceByName = new Map(); // name -> item
    let serviceById = new Map();   // id -> item
    let profilesById = new Map();  // uuid -> profile (full_name/email)
    let dssMeta = new Map(); // key(day, group) -> {selected, updated_at, updated_by}
    let massimoMap = new Map(); // key(day, service_item_id) -> {is_active, updated_at, updated_by}
    let outletMap = new Map();  // key(day,outlet_name) -> {is_open, open_time, close_time, updated_at, updated_by}

    let occEditingDate = null;

    /***************
      HELPERS
    ***************/
    function setMsg(el, text, type){
      el.style.display = "block";
      el.className = "msg " + (type || "");
      el.textContent = text;
    }
    function hideMsg(el){ el.style.display = "none"; el.textContent = ""; }

    function isoToday(){
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function addDays(iso, n){
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d));
      dt.setUTCDate(dt.getUTCDate()+n);
      const yy = dt.getUTCFullYear();
      const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
      const dd = String(dt.getUTCDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }

    function fmtDay(iso){
      // Use Toronto time for labels (safe for day names)
      const dt = new Date(iso+"T12:00:00Z");
      return new Intl.DateTimeFormat("en-CA", { timeZone: TZ, weekday:"short", month:"short", day:"numeric" }).format(dt);
    }

    function fmtToronto(ts){
      if (!ts) return "";
      const dt = new Date(ts);
      return new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year:"numeric", month:"short", day:"numeric",
        hour:"numeric", minute:"2-digit"
      }).format(dt);
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function fmtTime12(t){
      if (!t) return "";
      // expects "HH:MM:SS" or "HH:MM"
      const parts = t.split(":");
      const hh = Number(parts[0]);
      const mm = parts[1] ?? "00";
      const ampm = hh >= 12 ? "PM" : "AM";
      const h12 = ((hh + 11) % 12) + 1;
      return `${h12}:${mm} ${ampm}`;
    }

    function keyDss(day, group){ return `${day}__${group}`; }
    function keyMassimo(day, id){ return `${day}__${id}`; }
    function keyOutlet(day, name){ return `${day}__${name}`; }

    function canEditOcc(){
      if (!me) return false;
      return me.role === "admin" || (me.role === "user" && me.department === "Guest Service");
    }
    function canEditRestaurants(){
      if (!me) return false;
      return me.role === "admin" || (me.role === "user" && me.department === "F&B");
    }
    function canEditLobbyBar(){
      if (!me) return false;
      return me.role === "admin" || (me.role === "user" && me.department === "F&B");
    }
    function canEditOutlets(){
      if (!me) return false;
      return me.role === "admin" || (me.role === "user" && me.department === "Outlets");
    }
    function isAdmin(){
      return me && me.role === "admin";
    }

    function currentRedirectUrl(){
      // GitHub Pages friendly: use current page without query/hash
      const u = new URL(window.location.href);
      u.hash = "";
      u.search = "";
      return u.toString();
    }

    /***************
      AUTH + ROUTING
    ***************/
    function showLogin(){
      loginView.style.display = "flex";
      dashView.style.display = "none";
      usersView.style.display = "none";
      whoPills.style.display = "none";
      navBtns.style.display = "none";
      btnUsers.style.display = "none";
    }
    function showDashboard(){
      loginView.style.display = "none";
      dashView.style.display = "grid";
      usersView.style.display = "none";
      whoPills.style.display = "flex";
      navBtns.style.display = "flex";
      btnUsers.style.display = isAdmin() ? "inline-block" : "none";
    }
    function showUsers(){
      loginView.style.display = "none";
      dashView.style.display = "none";
      usersView.style.display = "grid";
      whoPills.style.display = "flex";
      navBtns.style.display = "flex";
      btnUsers.style.display = isAdmin() ? "inline-block" : "none";
    }

    function setWho(){
      pillRole.textContent = `Role: ${me?.role || "?"}`;
      pillDept.textContent = `Dept: ${me?.department || "(none)"}`;
      pillUser.textContent = `User: ${me?.full_name || me?.email || "?"}`;
      occPermHint.textContent = canEditOcc() ? "You can edit occupancy." : "View only.";
      fbPermHint.textContent = canEditRestaurants() ? "You can edit restaurant statuses." : "View only.";
      outletPermHint.textContent = (canEditLobbyBar() || canEditOutlets()) ? "You can edit your outlet section(s)." : "View only.";
    }

    async function ensureProfileRow(user){
      // Try to load profile; if missing, create minimal one (viewer + inactive false)
      const { data, error } = await sb.from("profiles").select("*").eq("user_id", user.id).maybeSingle();
      if (error) throw error;
      if (data) return data;

      const payload = {
        user_id: user.id,
        email: user.email,
        full_name: user.user_metadata?.full_name || (user.email || "").split("@")[0] || "User",
        role: "viewer",
        department: "",
        active: true
      };
      const { data: ins, error: insErr } = await sb.from("profiles").insert(payload).select("*").single();
      if (insErr) throw insErr;
      return ins;
    }

    async function refreshSession(){
      const { data, error } = await sb.auth.getSession();
      if (error) throw error;
      session = data.session;
      if (!session){
        me = null;
        showLogin();
        return;
      }
      const prof = await ensureProfileRow(session.user);
      me = prof;
      setWho();
      showDashboard();
      await loadAll();
    }

    /***************
      LOAD DATA
    ***************/
    async function loadProfilesMap(){
      // Pull all profiles so we can show names in tooltips and snapshot
      const { data, error } = await sb.from("profiles")
        .select("user_id, full_name, email, role, department, active")
        .order("full_name", { ascending: true });
      if (error) throw error;
      profilesById.clear();
      for (const p of (data||[])){
        profilesById.set(p.user_id, p);
      }
    }

    async function loadServiceItems(){
      const { data, error } = await sb.from("service_items")
        .select("id, group_name, name, sort_order")
        .order("group_name", { ascending: true })
        .order("sort_order", { ascending: true })
        .order("name", { ascending: true });
      if (error) throw error;

      serviceItems = data || [];
      serviceByName.clear();
      serviceById.clear();
      for (const it of serviceItems){
        serviceByName.set(it.name, it);
        serviceById.set(String(it.id), it);
      }
    }

    async function loadForecast(days){
      const from = days[0];
      const to = days[days.length-1];
      const { data, error } = await sb.from("daily_forecast")
        .select("date, occupancy_percent, notes_short, notes_long, updated_at, updated_by")
        .gte("date", from).lte("date", to);
      if (error) throw error;

      const map = new Map();
      for (const r of (data||[])) map.set(r.date, r);

      dashboardDays = days.map(d => {
        const r = map.get(d);
        const updName = r?.updated_by ? (profilesById.get(r.updated_by)?.full_name || profilesById.get(r.updated_by)?.email || "Unknown") : "";
        return {
          day: d,
          label: fmtDay(d),
          occupancy_percent: r?.occupancy_percent ?? null,
          notes_short: r?.notes_short ?? "",
          notes_long: r?.notes_long ?? "",
          updated_at: r?.updated_at ?? null,
          updated_by: r?.updated_by ?? null,
          updated_by_name: updName
        };
      });
    }

    async function loadDailySelections(days){
      const from = days[0];
      const to = days[days.length-1];
      const { data, error } = await sb.from("daily_service_selection")
        .select("date, group_name, selected_service_item_id, updated_at, updated_by")
        .gte("date", from).lte("date", to);
      if (error) throw error;

      dssMeta.clear();
      for (const r of (data||[])){
        dssMeta.set(keyDss(r.date, r.group_name), {
          selected: r.selected_service_item_id ? String(r.selected_service_item_id) : null,
          updated_at: r.updated_at,
          updated_by: r.updated_by
        });
      }
    }

    async function loadMassimo(days){
      const from = days[0];
      const to = days[days.length-1];
      const { data, error } = await sb.from("daily_massimo_status")
        .select("date, service_item_id, is_active, updated_at, updated_by")
        .gte("date", from).lte("date", to);
      if (error) throw error;

      massimoMap.clear();
      for (const r of (data||[])){
        massimoMap.set(keyMassimo(r.date, String(r.service_item_id)), {
          is_active: !!r.is_active,
          updated_at: r.updated_at,
          updated_by: r.updated_by
        });
      }
    }

    async function loadOutlets(days){
      const from = days[0];
      const to = days[days.length-1];
      const { data, error } = await sb.from("daily_outlet_hours")
        .select("date, outlet_name, is_open, open_time, close_time, updated_at, updated_by")
        .gte("date", from).lte("date", to);
      if (error) throw error;

      outletMap.clear();
      for (const r of (data||[])){
        outletMap.set(keyOutlet(r.date, r.outlet_name), {
          is_open: !!r.is_open,
          open_time: r.open_time,
          close_time: r.close_time,
          updated_at: r.updated_at,
          updated_by: r.updated_by
        });
      }
    }

    async function loadAll(){
      hideMsg(appMsg);
      try{
        const start = startDateEl.value || isoToday();
        const days = Array.from({length:7}, (_,i)=> addDays(start, i));
        await loadProfilesMap();
        await loadServiceItems();
        await loadForecast(days);
        await loadDailySelections(days);
        await loadMassimo(days);
        await loadOutlets(days);

        renderOcc();
        renderRestaurantMatrix();
        renderOutlets();
      }catch(e){
        setMsg(appMsg, e?.message || String(e), "err");
      }
    }

    /***************
      RENDER: OCCUPANCY
    ***************/
    function renderOcc(){
      occWrap.innerHTML = "";
      const editable = canEditOcc();

      for (const d of dashboardDays){
        const div = document.createElement("div");
        div.className = "occ" + (editable ? "" : " disabled");
        div.innerHTML = `
          <div class="d1">${escapeHtml(d.label)}</div>
          <div class="d2">${escapeHtml(d.day)}</div>
          <div class="pct">${d.occupancy_percent == null ? "—" : escapeHtml(Number(d.occupancy_percent).toFixed(1) + "%")}</div>
          <div class="meta">
            ${d.updated_at ? `Last update: ${escapeHtml(d.updated_by_name)} • ${escapeHtml(fmtToronto(d.updated_at))}` : "No update yet"}
          </div>
        `;
        if (editable){
          div.addEventListener("click", ()=> openOccEdit(d.day));
        }
        occWrap.appendChild(div);
      }
    }

    async function openOccEdit(day){
      hideMsg(occMsg);
      occEditingDate = day;
      const d = dashboardDays.find(x=>x.day===day);
      occTitle.textContent = `Edit occupancy — ${day}`;

      // prefill with last saved values
      occPct.value = d?.occupancy_percent ?? "";
      occShort.value = d?.notes_short ?? "";
      occLong.value = d?.notes_long ?? "";

      occOverlay.classList.add("show");
    }

    occClose.addEventListener("click", ()=> occOverlay.classList.remove("show"));

    occSave.addEventListener("click", async ()=>{
      hideMsg(occMsg);
      if (!occEditingDate) return;

      const pctRaw = String(occPct.value || "").trim();
      const pct = pctRaw === "" ? null : Number(pctRaw);
      if (pct !== null && (isNaN(pct) || pct < 0 || pct > 100)){
        setMsg(occMsg, "Occupancy must be between 0 and 100.", "err");
        return;
      }

      const payload = {
        date: occEditingDate,
        occupancy_percent: pct,
        notes_short: String(occShort.value||"").trim(),
        notes_long: String(occLong.value||"").trim(),
        updated_by: session.user.id,
        updated_at: new Date().toISOString()
      };

      try{
        const { error } = await sb.from("daily_forecast").upsert(payload, { onConflict: "date" });
        if (error) throw error;

        setMsg(occMsg, "Saved.", "ok");
        await loadAll();
        setTimeout(()=> occOverlay.classList.remove("show"), 450);
      }catch(e){
        setMsg(occMsg, e?.message || String(e), "err");
      }
    });

    /***************
      RENDER: RESTAURANTS
    ***************/
    function groupItems(groupKey){
      return serviceItems.filter(x => x.group_name === groupKey);
    }

    function isSelected(day, groupKey, serviceId){
      const meta = dssMeta.get(keyDss(day, groupKey));
      return meta?.selected && String(meta.selected) === String(serviceId);
    }

    function selectedName(day, groupKey){
      const meta = dssMeta.get(keyDss(day, groupKey));
      if (!meta?.selected) return null;
      const it = serviceById.get(String(meta.selected));
      return it?.name || null;
    }

    function massimoIsOn(day, serviceName){
      const it = serviceByName.get(serviceName);
      if (!it) return false;
      const row = massimoMap.get(keyMassimo(day, String(it.id)));
      return !!row?.is_active;
    }

    function metaText(updated_by, updated_at){
      if (!updated_at) return "";
      const p = updated_by ? profilesById.get(updated_by) : null;
      const name = p?.full_name || p?.email || "Unknown";
      return `Updated by ${name} • ${fmtToronto(updated_at)}`;
    }

    function renderRestaurantMatrix(){
      const days = dashboardDays.map(d=>d.day);

      const head = `
        <thead>
          <tr>
            <th style="text-align:left;">Service</th>
            ${dashboardDays.map(d=>`
              <th>
                ${escapeHtml(d.label)}
                <div style="font-size:10px;color:#64748b;margin-top:2px;">${escapeHtml(d.day)}</div>
              </th>
            `).join("")}
          </tr>
        </thead>
      `;

      function sectionRow(title){
        return `<tr class="section-row"><td colspan="${1+days.length}">${escapeHtml(title)}</td></tr>`;
      }

      function rowForItem(item, groupKey, tagLabel){
        const cells = days.map(day=>{
          const sel = isSelected(day, groupKey, item.id);
          const meta = dssMeta.get(keyDss(day, groupKey));
          const tip = metaText(meta?.updated_by, meta?.updated_at);
          const cls = sel ? "green" : "red";
          const disabled = !canEditRestaurants() ? " disabled" : "";
          return `
            <td>
              <div class="cell ${cls}${disabled}" data-kind="single" data-day="${day}" data-group="${groupKey}" data-id="${item.id}" title="${escapeHtml(tip)}"></div>
            </td>
          `;
        }).join("");

        return `
          <tr>
            <td>
              <div class="svc-name">${escapeHtml(item.name)} <span class="tag">${escapeHtml(tagLabel)}</span></div>
            </td>
            ${cells}
          </tr>
        `;
      }

      function rowForMassimoItem(item){
        const cells = days.map(day=>{
          const row = massimoMap.get(keyMassimo(day, String(item.id)));
          const on = !!row?.is_active;
          const tip = metaText(row?.updated_by, row?.updated_at);
          const cls = on ? "green" : "red";
          const disabled = !canEditRestaurants() ? " disabled" : "";
          return `
            <td>
              <div class="cell ${cls}${disabled}" data-kind="massimo" data-day="${day}" data-id="${item.id}" title="${escapeHtml(tip)}"></div>
            </td>
          `;
        }).join("");

        return `
          <tr>
            <td>
              <div class="svc-name">${escapeHtml(item.name)} <span class="tag">Massimo</span></div>
            </td>
            ${cells}
          </tr>
        `;
      }

      const breakfast = groupItems("breakfast");
      const lunch = groupItems("lunch");
      const dinner = groupItems("dinner");
      const massimo = groupItems("massimo");

      const body = `
        <tbody>
          ${sectionRow("BREAKFAST")}
          ${breakfast.map(it => rowForItem(it, "breakfast", "Breakfast")).join("")}

          ${sectionRow("LUNCH")}
          ${lunch.map(it => rowForItem(it, "lunch", "Lunch")).join("")}

          ${sectionRow("DINNER")}
          ${dinner.map(it => rowForItem(it, "dinner", "Dinner")).join("")}

          ${sectionRow("MASSIMO")}
          ${massimo.map(it => rowForMassimoItem(it)).join("")}
        </tbody>
      `;

      restTable.innerHTML = head + body;

      // click handlers
      restTable.querySelectorAll(".cell").forEach(el=>{
        el.addEventListener("click", onCellClick);
        el.addEventListener("dblclick", onCellDblClick);
      });
    }

    async function onCellClick(ev){
      const el = ev.currentTarget;
      if (el.classList.contains("disabled")) return;

      hideMsg(restMsg);

      const kind = el.dataset.kind;
      const day = el.dataset.day;

      try{
        if (kind === "massimo"){
          // toggle on/off (multi green allowed)
          const service_item_id = String(el.dataset.id);
          const k = keyMassimo(day, service_item_id);
          const prev = massimoMap.get(k);
          const next = !(prev?.is_active);

          const payload = {
            date: day,
            service_item_id,
            is_active: next,
            updated_by: session.user.id,
            updated_at: new Date().toISOString()
          };
          const { error } = await sb.from("daily_massimo_status")
            .upsert(payload, { onConflict: "date,service_item_id" });
          if (error) throw error;

          await loadAll();
          const it = serviceById.get(service_item_id);
          const name = it?.name || "Massimo item";
          setMsg(restMsg, `${name} on ${day} updated.`, "ok");
          return;
        }

        // breakfast/lunch/dinner: set selected option (only one green per day)
        if (!canEditRestaurants()){
          setMsg(restMsg, "View only.", "err");
          return;
        }

        const group = el.dataset.group;
        const selected_service_item_id = String(el.dataset.id);

        const payload = {
          date: day,
          group_name: group,
          selected_service_item_id,
          updated_by: session.user.id,
          updated_at: new Date().toISOString()
        };

        const { error } = await sb.from("daily_service_selection")
          .upsert(payload, { onConflict: "date,group_name" });
        if (error) throw error;

        await loadAll();
        const it = serviceById.get(selected_service_item_id);
        setMsg(restMsg, `${(group||"").toUpperCase()} set to ${it?.name || "selection"} for ${day}.`, "ok");
      }catch(e){
        setMsg(restMsg, e?.message || String(e), "err");
      }
    }

    async function onCellDblClick(ev){
      const el = ev.currentTarget;
      if (el.classList.contains("disabled")) return;

      hideMsg(restMsg);

      const kind = el.dataset.kind;
      const day = el.dataset.day;

      try{
        if (kind === "massimo"){
          // double click on green -> turn off
          const service_item_id = String(el.dataset.id);
          const k = keyMassimo(day, service_item_id);
          const prev = massimoMap.get(k);
          if (!prev?.is_active) return;

          const payload = {
            date: day,
            service_item_id,
            is_active: false,
            updated_by: session.user.id,
            updated_at: new Date().toISOString()
          };
          const { error } = await sb.from("daily_massimo_status")
            .upsert(payload, { onConflict: "date,service_item_id" });
          if (error) throw error;

          await loadAll();
          setMsg(restMsg, `Massimo item cleared for ${day}.`, "ok");
          return;
        }

        // breakfast/lunch/dinner: double click green -> clear selection (all closed)
        const group = el.dataset.group;
        const meta = dssMeta.get(keyDss(day, group));
        const id = String(el.dataset.id);
        if (!meta?.selected || String(meta.selected) !== id) return; // only clear if this is currently selected

        const payload = {
          date: day,
          group_name: group,
          selected_service_item_id: null,
          updated_by: session.user.id,
          updated_at: new Date().toISOString()
        };

        const { error } = await sb.from("daily_service_selection")
          .upsert(payload, { onConflict: "date,group_name" });
        if (error) throw error;

        await loadAll();
        setMsg(restMsg, `${(group||"").toUpperCase()} cleared for ${day} (closed).`, "ok");
      }catch(e){
        setMsg(restMsg, e?.message || String(e), "err");
      }
    }

    /***************
      OUTLETS
    ***************/
    function outletSummary(day, outlet_name){
      const row = outletMap.get(keyOutlet(day, outlet_name));
      if (!row) return { cls:"closed", text:"Closed", meta:"" };
      if (!row.is_open) return { cls:"closed", text:"Closed", meta: metaText(row.updated_by, row.updated_at) };
      const ot = fmtTime12(row.open_time);
      const ct = fmtTime12(row.close_time);
      const text = (ot && ct) ? `Open ${ot}–${ct}` : "Open (hours missing)";
      return { cls:"open", text, meta: metaText(row.updated_by, row.updated_at) };
    }

    function renderOutlets(){
      outletGrid.innerHTML = "";

      for (const outlet of OUTLET_ITEMS){
        const canEditThis =
          outlet.name === "LOBBY BAR" ? canEditLobbyBar() : canEditOutlets();

        const row = document.createElement("div");
        row.className = "outlet-row";

        const name = document.createElement("div");
        name.className = "outlet-name";
        name.textContent = outlet.name;

        const miniWrap = document.createElement("div");
        miniWrap.className = "outlet-mini";

        for (const d of dashboardDays){
          const s = outletSummary(d.day, outlet.name);
          const mini = document.createElement("div");
          mini.className = "mini " + s.cls;
          mini.title = s.meta || "";
          mini.innerHTML = `
            <div class="d">${escapeHtml(d.label)} <span style="color:#64748b; font-weight:900;">(${escapeHtml(d.day)})</span></div>
            <div class="s">${escapeHtml(s.text)}</div>
            <div class="m">${s.meta ? escapeHtml(s.meta) : "No update yet"}</div>
          `;
          miniWrap.appendChild(mini);
        }

        const actions = document.createElement("div");
        actions.className = "row";
        const btn = document.createElement("button");
        btn.className = "btn primary";
        btn.textContent = "Edit week";
        btn.disabled = !canEditThis;
        btn.addEventListener("click", ()=> openOutletWeek(outlet.name));
        actions.appendChild(btn);

        row.appendChild(name);
        row.appendChild(actions);
        row.appendChild(miniWrap);
        outletGrid.appendChild(row);
      }

      // fill outlet dropdown for modal (but permissions will still control save)
      outOutlet.innerHTML = OUTLET_ITEMS.map(o=>`<option value="${escapeHtml(o.name)}">${escapeHtml(o.name)}</option>`).join("");
    }

    function openOutletWeek(outletName){
      hideMsg(outEditMsg);
      outOutlet.value = outletName;
      buildOutletWeekTable(outletName);
      outTitle.textContent = `Edit week — ${outletName}`;
      outOverlay.classList.add("show");
    }

    outClose.addEventListener("click", ()=> outOverlay.classList.remove("show"));
    outOutlet.addEventListener("change", ()=> buildOutletWeekTable(outOutlet.value));

    function buildOutletWeekTable(outletName){
      const days = dashboardDays.map(d=>d.day);
      const head = `
        <thead>
          <tr>
            <th style="text-align:left;">Date</th>
            <th>Open / Closed</th>
            <th>Open time</th>
            <th>Close time</th>
          </tr>
        </thead>
      `;

      const rows = days.map(day=>{
        const row = outletMap.get(keyOutlet(day, outletName));
        const is_open = row ? !!row.is_open : false;
        const open_time = row?.open_time ? String(row.open_time).slice(0,5) : "";
        const close_time = row?.close_time ? String(row.close_time).slice(0,5) : "";
        return `
          <tr data-day="${day}">
            <td style="font-weight:900;">${escapeHtml(fmtDay(day))} <span style="color:#64748b;">${escapeHtml(day)}</span></td>
            <td>
              <select class="ow-open">
                <option value="false" ${!is_open ? "selected":""}>Closed</option>
                <option value="true" ${is_open ? "selected":""}>Open</option>
              </select>
            </td>
            <td><input class="ow-ot" type="time" value="${escapeHtml(open_time)}" /></td>
            <td><input class="ow-ct" type="time" value="${escapeHtml(close_time)}" /></td>
          </tr>
        `;
      }).join("");

      outWeekTable.innerHTML = head + `<tbody>${rows}</tbody>`;
    }

    outSave.addEventListener("click", async ()=>{
      hideMsg(outEditMsg);

      const outletName = outOutlet.value;

      // permission check
      const outletCfg = OUTLET_ITEMS.find(x=>x.name===outletName);
      const canEditThis = outletCfg?.dept === "F&B" ? canEditLobbyBar() : canEditOutlets();
      if (!canEditThis){
        setMsg(outEditMsg, "View only.", "err");
        return;
      }

      const rows = Array.from(outWeekTable.querySelectorAll("tbody tr"));
      const updates = [];

      for (const tr of rows){
        const day = tr.dataset.day;
        const is_open = tr.querySelector(".ow-open").value === "true";
        const ot = tr.querySelector(".ow-ot").value || "";
        const ct = tr.querySelector(".ow-ct").value || "";

        // Rule: if open, hours required
        if (is_open && (!ot || !ct)){
          setMsg(outEditMsg, `Hours required for ${day} if Open.`, "err");
          return;
        }

        // only save if something changed vs current
        const cur = outletMap.get(keyOutlet(day, outletName));
        const curOpen = !!cur?.is_open;
        const curOt = (cur?.open_time ? String(cur.open_time).slice(0,5) : "");
        const curCt = (cur?.close_time ? String(cur.close_time).slice(0,5) : "");

        const changed =
          (curOpen !== is_open) ||
          (String(curOt) !== String(ot)) ||
          (String(curCt) !== String(ct));

        if (!changed) continue;

        updates.push({
          date: day,
          outlet_name: outletName,
          is_open,
          open_time: is_open ? ot : null,
          close_time: is_open ? ct : null,
          updated_by: session.user.id,
          updated_at: new Date().toISOString()
        });
      }

      if (updates.length === 0){
        setMsg(outEditMsg, "No changes to save.", "ok");
        return;
      }

      try{
        const { error } = await sb.from("daily_outlet_hours")
          .upsert(updates, { onConflict: "date,outlet_name" });
        if (error) throw error;

        setMsg(outEditMsg, "Saved week.", "ok");
        await loadAll();
        setTimeout(()=> outOverlay.classList.remove("show"), 450);
      }catch(e){
        setMsg(outEditMsg, e?.message || String(e), "err");
      }
    });

    /***************
      USERS (ADMIN)
    ***************/
    async function loadUsersPage(){
      if (!isAdmin()){
        setMsg(usersMsg, "Admins only.", "err");
        return;
      }
      hideMsg(usersMsg);

      await loadProfilesMap();
      renderUsersDropdown();
      renderUsersTable();
    }

    function renderUsersDropdown(){
      const list = Array.from(profilesById.values()).sort((a,b)=>{
        const aa = (a.full_name || a.email || "").toLowerCase();
        const bb = (b.full_name || b.email || "").toLowerCase();
        return aa.localeCompare(bb);
      });

      userSelect.innerHTML = list.map(p=>{
        const label = (p.full_name ? `${p.full_name} — ${p.email}` : p.email);
        return `<option value="${escapeHtml(p.user_id)}">${escapeHtml(label)}</option>`;
      }).join("");

      if (list.length){
        userSelect.value = list[0].user_id;
        fillUserForm(list[0].user_id);
      }
    }

    function fillUserForm(uid){
      const p = profilesById.get(uid);
      if (!p) return;
      userEmail.value = p.email || "";
      userName.value = p.full_name || "";
      userRole.value = p.role || "viewer";
      userDept.value = p.department || "";
      userActive.value = String(p.active ?? true);
    }

    userSelect.addEventListener("change", ()=> fillUserForm(userSelect.value));

    btnUserReload.addEventListener("click", async ()=>{
      try{
        await loadUsersPage();
        setMsg(usersMsg, "Reloaded.", "ok");
      }catch(e){
        setMsg(usersMsg, e?.message || String(e), "err");
      }
    });

    btnUserSave.addEventListener("click", async ()=>{
      hideMsg(usersMsg);
      const uid = userSelect.value;
      if (!uid) return;

      const payload = {
        user_id: uid,
        full_name: String(userName.value||"").trim(),
        role: userRole.value,
        department: userDept.value,
        active: (userActive.value === "true")
      };

      try{
        const { error } = await sb.from("profiles").update(payload).eq("user_id", uid);
        if (error) throw error;

        await loadUsersPage();
        setMsg(usersMsg, "Saved.", "ok");
      }catch(e){
        setMsg(usersMsg, e?.message || String(e), "err");
      }
    });

    function renderUsersTable(){
      const rows = Array.from(profilesById.values()).sort((a,b)=>{
        const aa = (a.full_name || a.email || "").toLowerCase();
        const bb = (b.full_name || b.email || "").toLowerCase();
        return aa.localeCompare(bb);
      });

      usersTable.innerHTML = `
        <thead>
          <tr>
            <th style="text-align:left;">Name</th>
            <th style="text-align:left;">Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Active</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(p=>`
            <tr>
              <td style="font-weight:900;">${escapeHtml(p.full_name || "")}</td>
              <td>${escapeHtml(p.email || "")}</td>
              <td style="text-align:center; font-weight:900;">${escapeHtml(p.role || "")}</td>
              <td style="text-align:center; font-weight:900;">${escapeHtml(p.department || "")}</td>
              <td style="text-align:center; font-weight:900;">${escapeHtml(String(p.active ?? true))}</td>
            </tr>
          `).join("")}
        </tbody>
      `;
    }

    /***************
      PRINT SNAPSHOT (NO POPUPS)
    ***************/
    function getSelectedServiceName(day, groupName){
      const meta = dssMeta.get(keyDss(day, groupName));
      if (!meta?.selected) return null;
      const it = serviceById.get(String(meta.selected));
      return it?.name || null;
    }
    function getMassimoActiveNames(day){
      const items = groupItems("massimo");
      const active = [];
      for (const it of items){
        const row = massimoMap.get(keyMassimo(day, String(it.id)));
        if (row?.is_active) active.push(it.name.replace("MASSIMO ", ""));
      }
      return active;
    }

    function buildSnapshotInnerHtml(){
      const startDate = startDateEl.value;
      const title = `Sheraton Niagara Falls – 7-Day Snapshot (${startDate})`;

      const dayCols = dashboardDays.map(d => ({
        day: d.day,
        label: fmtDay(d.day)
      }));

      function outletSummaryText(day, outlet_name){
        const row = outletMap.get(keyOutlet(day, outlet_name));
        if (!row) return "—";
        if (!row.is_open) return "Closed";
        const ot = fmtTime12(row.open_time);
        const ct = fmtTime12(row.close_time);
        if (!ot || !ct) return "Open (hours missing)";
        return `Open ${ot}–${ct}`;
      }

      function rowHtml(label, cells){
        return `
          <tr>
            <td class="label" style="border:1px solid #cbd5e1; padding:8px; font-weight:900; text-align:left; background:#f8fafc;">
              ${escapeHtml(label)}
            </td>
            ${cells.map(c => `<td style="border:1px solid #cbd5e1; padding:8px; vertical-align:top;">${c}</td>`).join("")}
          </tr>
        `;
      }

      const occCells = dashboardDays.map(d => d.occupancy_percent == null ? "—" : `<b>${escapeHtml(Number(d.occupancy_percent).toFixed(1))}%</b>`);
      const noteCells = dashboardDays.map(d => {
        const n = (d.notes_long || d.notes_short || "").trim();
        return n ? `<div style="white-space:pre-wrap;">${escapeHtml(n)}</div>` : "—";
      });

      const breakfastCells = dashboardDays.map(d => escapeHtml(getSelectedServiceName(d.day, "breakfast") || "Breakfast closed"));
      const lunchCells     = dashboardDays.map(d => escapeHtml(getSelectedServiceName(d.day, "lunch") || "Lunch closed"));
      const dinnerCells    = dashboardDays.map(d => escapeHtml(getSelectedServiceName(d.day, "dinner") || "Dinner closed"));

      const massimoCells   = dashboardDays.map(d => {
        const a = getMassimoActiveNames(d.day);
        return a.length ? escapeHtml(a.join(", ")) : "Massimo closed";
      });

      const lobbyCells  = dashboardDays.map(d => escapeHtml(outletSummaryText(d.day, "LOBBY BAR")));
      const starCells   = dashboardDays.map(d => escapeHtml(outletSummaryText(d.day, "STARBUCKS")));
      const sjCells     = dashboardDays.map(d => escapeHtml(outletSummaryText(d.day, "SWEET JESUS")));
      const freshCells  = dashboardDays.map(d => escapeHtml(outletSummaryText(d.day, "FRESHII")));

      return `
        <div style="font-family:Arial,sans-serif; margin:22px; color:#111827;">
          <h1 style="font-size:18px; margin:0 0 10px;">${escapeHtml(title)}</h1>
          <div style="color:#475569; font-size:12px; margin-bottom:14px;">
            Generated by Sheraton Dashboard • Times shown in America/Toronto where applicable
          </div>

          <table style="border-collapse:collapse; width:100%; table-layout:fixed;">
            <thead>
              <tr>
                <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; text-align:left;">Section</th>
                ${dayCols.map(d => `
                  <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9;">
                    ${escapeHtml(d.label)}
                    <div style="font-size:10px;color:#64748b;margin-top:2px;">${escapeHtml(d.day)}</div>
                  </th>
                `).join("")}
              </tr>
            </thead>
            <tbody>
              ${rowHtml("Occupancy %", occCells)}
              ${rowHtml("Notes", noteCells)}
              ${rowHtml("Breakfast", breakfastCells)}
              ${rowHtml("Lunch", lunchCells)}
              ${rowHtml("Dinner", dinnerCells)}
              ${rowHtml("Massimo", massimoCells)}
              ${rowHtml("Lobby Bar", lobbyCells)}
              ${rowHtml("Starbucks", starCells)}
              ${rowHtml("Sweet Jesus", sjCells)}
              ${rowHtml("Freshii", freshCells)}
            </tbody>
          </table>
        </div>
      `;
    }

    function printSnapshot(){
      try{
        hideMsg(appMsg);
        if (!dashboardDays || dashboardDays.length === 0){
          setMsg(appMsg, "Nothing to print yet. Hit Refresh first.", "err");
          return;
        }
        const area = document.getElementById("printArea");
        area.innerHTML = buildSnapshotInnerHtml();

        document.body.classList.add("printing");

        // let DOM render then print
        setTimeout(()=> window.print(), 50);
      }catch(e){
        setMsg(appMsg, e?.message || String(e), "err");
      }
    }

    window.addEventListener("afterprint", ()=>{
      try{
        document.body.classList.remove("printing");
        const area = document.getElementById("printArea");
        if (area) area.innerHTML = "";
      }catch{}
    });

    /***************
      EVENTS
    ***************/
    btnToday.addEventListener("click", ()=>{
      startDateEl.value = isoToday();
      loadAll();
    });
    btnRefresh.addEventListener("click", loadAll);
    btnPrint.addEventListener("click", printSnapshot);

    btnDashboard.addEventListener("click", ()=>{
      showDashboard();
    });
    btnUsers.addEventListener("click", async ()=>{
      showUsers();
      await loadUsersPage();
    });

    btnLogout.addEventListener("click", async ()=>{
      try{
        await sb.auth.signOut();
        showLogin();
      }catch(e){
        setMsg(appMsg, e?.message || String(e), "err");
      }
    });

    btnSignIn.addEventListener("click", async ()=>{
      hideMsg(loginMsg);
      try{
        const email = String(loginEmail.value||"").trim();
        const password = String(loginPass.value||"").trim();
        if (!email || !password){
          setMsg(loginMsg, "Enter email and password.", "err");
          return;
        }
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        setMsg(loginMsg, "Signed in.", "ok");
        await refreshSession();
      }catch(e){
        setMsg(loginMsg, e?.message || String(e), "err");
      }
    });

    btnForgot.addEventListener("click", async ()=>{
      hideMsg(loginMsg);
      try{
        const email = String(loginEmail.value||"").trim();
        if (!email){
          setMsg(loginMsg, "Enter the email first.", "err");
          return;
        }
        const { error } = await sb.auth.resetPasswordForEmail(email, {
          redirectTo: currentRedirectUrl()
        });
        if (error) throw error;
        setMsg(loginMsg, "Password reset email sent. Use the link, then come back here and sign in.", "ok");
      }catch(e){
        setMsg(loginMsg, e?.message || String(e), "err");
      }
    });

    /***************
      STARTUP
    ***************/
    (async function init(){
      // default start date = today
      startDateEl.value = isoToday();

      if (!sb){
        showLogin();
        return;
      }

      // auth state
      sb.auth.onAuthStateChange(async (_event, _session)=>{
        // keep it simple: just refresh on changes
        try{ await refreshSession(); }catch(e){
          showLogin();
          setMsg(loginMsg, e?.message || String(e), "err");
        }
      });

      // initial load
      try{
        await refreshSession();
      }catch(e){
        showLogin();
        setMsg(loginMsg, e?.message || String(e), "err");
      }
    })();
  </script>
</body>
</html>
