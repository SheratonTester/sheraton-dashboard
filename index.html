<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheraton Niagara Falls – Dashboard</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --shadow: 0 10px 24px rgba(15,23,42,.08);

      --on:#166534;   /* dark green */
      --off:#991b1b;  /* dark red */

      --rowHead:#f8fafc;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --warn:#b45309;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, #f6f8fc 0%, #eef2ff 100%);
      color:var(--text);
    }
    .wrap{max-width:1480px;margin:0 auto;padding:16px}

    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .titleRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{
      font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(6px);
    }

    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tabBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(6px);
      padding:9px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      transition: all .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tabBtn:hover{border-color:#cbd5e1}
    .tabBtn.active{
      background: linear-gradient(180deg, var(--brand) 0%, var(--brand2) 100%);
      color:white;
      border-color: rgba(29,78,216,.6);
      box-shadow: 0 10px 18px rgba(37,99,235,.20);
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,button,select,textarea{
      background:#fff;color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    input[type="date"]{padding:9px 12px}
    textarea{width:100%;min-height:160px;resize:vertical;line-height:1.3}
    button{cursor:pointer;transition: all .15s ease}
    button:hover{border-color:#cbd5e1}
    .btnPrimary{
      background: linear-gradient(180deg, var(--brand) 0%, var(--brand2) 100%);
      border-color: rgba(29,78,216,.55);
      color:white;
      box-shadow: 0 10px 18px rgba(37,99,235,.18);
    }
    .btnPrimary:hover{filter: brightness(1.03)}
    .btnGhost{background: rgba(255,255,255,.95)}
    .btnDanger{
      background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
      border-color: rgba(220,38,38,.5);
      color:white;
      box-shadow: 0 10px 18px rgba(239,68,68,.18);
    }
    .btnDanger:hover{filter: brightness(1.03)}

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }

    .sectionTitle{
      margin:14px 0 10px;
      font-size:13px;
      color:var(--muted);
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    }
    .hint{font-size:12px;color:var(--muted)}
    .msg{margin-top:10px;font-size:13px;color:var(--muted)}
    .err{color:#b91c1c}
    .oktxt{color:#166534}
    .warntxt{color:var(--warn)}
    .badge{
      font-size:11px;color:var(--muted);
      padding:3px 8px;border-radius:999px;border:1px solid var(--line);
      background: rgba(248,250,252,.95);
      white-space:nowrap;
    }

    .gridDays{
      display:grid;
      grid-template-columns:repeat(7, minmax(180px,1fr));
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
    }
    .daycard{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      min-width:180px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .daycard:hover{border-color:#cbd5e1; box-shadow: 0 12px 22px rgba(15,23,42,.08)}
    .daycard.today{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 14px 28px rgba(37,99,235,.16);
    }
    .daytitle{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
    .occ{font-size:22px;margin-top:4px;font-weight:750}
    .notes{font-size:12px;color:var(--muted);margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .clickable{cursor:pointer}
    .clickable:active{transform: scale(.995)}

    .tableWrap{
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      background:#fff;
    }
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:980px}
    th,td{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:10px;
      text-align:center;
      background:#fff;
    }
    th:first-child,td:first-child{
      text-align:left;
      position:sticky; left:0;
      z-index:2;
      background:#fff;
      min-width:260px;
    }
    thead th{
      position:sticky; top:0;
      z-index:3;
      font-size:12px;
      color:var(--muted);
      background: var(--rowHead);
    }

    .groupRow td{
      position:sticky;
      left:0;
      z-index:4;
      background: linear-gradient(180deg, rgba(37,99,235,.10) 0%, rgba(29,78,216,.08) 100%);
      color:#1e3a8a;
      font-weight:900;
      letter-spacing:.3px;
      text-transform: uppercase;
      font-size:12px;
      border-right:1px solid var(--line);
    }
    .groupRow td:not(:first-child){ position:static; z-index:1; }

    .serviceName{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      font-weight:750;
    }

    .statusCell{
      user-select:none;
      padding:6px 8px;
      height:64px;
      min-width:92px;
      -webkit-tap-highlight-color: transparent;
    }
    .statusFill{
      width:100%;
      height:56px;
      border-radius:12px;
      margin:0 auto;
      border:2px solid rgba(15,23,42,.12);
      transition: transform .08s ease, filter .12s ease, outline .12s ease;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:flex-end;
      justify-content:flex-start;
      padding:6px 7px;
    }
    .isOn{ background: var(--on); border-color: rgba(20,83,45,.55); }
    .isOff{ background: var(--off); border-color: rgba(127,29,29,.55); }

    .statusCell.clickable:hover .statusFill{
      outline:3px solid rgba(37,99,235,.25);
      outline-offset: 2px;
      filter: brightness(1.03);
    }
    .statusCell.clickable:active .statusFill{ transform: scale(.98); }

    .stamp{
      font-size:10px;
      line-height:1.05;
      color: rgba(255,255,255,.95);
      text-shadow: 0 1px 2px rgba(0,0,0,.35);
      max-width:100%;
      display:flex;
      flex-direction:column;
      gap:2px;
      pointer-events:none;
    }
    .stampLine{
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .stampLine2{
      font-weight:700;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    .loginBox{max-width:560px;margin:40px auto}

    .modalBack{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index: 999999;
    }
    .modal{
      width:100%; max-width:760px;
      background:#fff;
      border:1px solid rgba(226,232,240,.9);
      border-radius:18px;
      box-shadow: 0 24px 60px rgba(15,23,42,.22);
      overflow:hidden;
      position:relative;
      z-index: 1000000;
    }
    .modalHeader{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px;
      border-bottom:1px solid var(--line);
      background: var(--rowHead);
    }
    .modalHeader b{font-size:14px}
    .modalBody{padding:14px}
    .modalFooter{
      padding:14px;
      display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;
      border-top:1px solid var(--line);
      background: var(--rowHead);
    }
    .xBtn{border-radius:12px; padding:8px 10px}
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    @media (max-width: 860px){
      .twoCol{grid-template-columns:1fr}
      .wrap{padding:12px}
      h1{font-size:16px}

      .tabs{width:100%}
      .tabBtn{flex:1; justify-content:center; text-align:center}

      .gridDays{
        display:grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(240px, 1fr);
        grid-template-columns: unset;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        padding-bottom:10px;
      }
      .daycard{min-width:240px;scroll-snap-align: start}

      table{min-width:900px}
      th:first-child, td:first-child{min-width:200px}
      th,td{padding:8px}
      .statusCell{min-width:96px}
      .statusFill{height:58px}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN -->
    <div id="loginView" class="loginBox card" style="display:none;">
      <h2 style="margin:0 0 8px;font-size:18px;">Sheraton Dashboard</h2>
      <div class="hint">Sign in to view / update occupancy and restaurant status.</div>

      <label style="display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;">Email</label>
      <input id="email" type="email" placeholder="name@niagarafallshotels.com" />

      <label style="display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;">Password</label>
      <input id="password" type="password" placeholder="••••••••" />

      <div class="row" style="margin-top:12px;">
        <button id="btnLogin" class="btnPrimary">Sign in</button>
        <button id="btnForgot" class="btnGhost">Forgot password</button>
      </div>

      <div id="loginMsg" class="msg"></div>
    </div>

    <!-- INVITE / RESET PASSWORD -->
    <div id="recoveryView" class="loginBox card" style="display:none;">
      <h2 style="margin:0 0 8px;font-size:18px;">Finish setup</h2>
      <div class="hint">Enter your name, confirm your email, and set your password.</div>

      <label style="display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;">Full name</label>
      <input id="setupName" type="text" placeholder="Your full name" />

      <label style="display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;">Email</label>
      <input id="setupEmail" type="email" placeholder="name@niagarafallshotels.com" />

      <label style="display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;">New password</label>
      <input id="newPass" type="password" placeholder="New password" />

      <label style="display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;">Confirm new password</label>
      <input id="newPass2" type="password" placeholder="Confirm new password" />

      <div class="row" style="margin-top:12px;">
        <button id="btnSetPass" class="btnPrimary">Save and continue</button>
        <button id="btnCancelRecovery" class="btnGhost">Cancel</button>
      </div>

      <div id="recoveryMsg" class="msg"></div>
    </div>

    <!-- APP -->
    <div id="appView" style="display:none;">
      <div class="topbar">
        <div class="titleRow">
          <h1>Sheraton Niagara Falls – Ops Dashboard</h1>
          <span id="rolePill" class="pill">Role: …</span>
          <span id="deptPill" class="pill">Dept: …</span>
          <span id="userPill" class="pill">User: …</span>
        </div>

        <div class="tabs">
          <button id="tabDashboard" class="tabBtn active">Dashboard</button>
          <button id="tabUsers" class="tabBtn" style="display:none;">Users</button>
          <button id="btnLogout" class="tabBtn btnDanger">Logout</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="panelDashboard">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <label style="margin:0;color:var(--muted);font-size:12px;">Start date</label>
              <input id="startDate" type="date" />
              <button id="btnToday" class="btnGhost">Today</button>
              <button id="btnRefresh" class="btnPrimary">Refresh</button>
            </div>
          </div>

          <div id="permHint" class="msg warntxt" style="margin-top:10px; display:none;"></div>
        </div>

        <div class="sectionTitle">7-Day Occupancy Forecast</div>
        <div class="card">
          <div id="occCards" class="gridDays"></div>
          <div class="hint" style="margin-top:10px;">
            Click a day to edit (if you have permission). It will prefill the last saved percent + notes.
          </div>
        </div>

        <div class="sectionTitle">
          Restaurant Status
          <span class="badge" style="border-color: rgba(20,83,45,.35);">Green = Active</span>
          <span class="badge" style="border-color: rgba(127,29,29,.35);">Red = Inactive</span>
          <span class="badge">Time shown: America/Toronto</span>
          <span class="badge">Tip: double-click a green meal item to clear</span>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr id="headRow">
                <th>Service</th>
              </tr>
            </thead>
            <tbody id="bodyRows"></tbody>
          </table>
        </div>

        <div class="sectionTitle">Lobby Bar</div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr id="lobbyHead">
                <th>Lobby Bar</th>
              </tr>
            </thead>
            <tbody id="lobbyBody"></tbody>
          </table>
        </div>

        <div class="sectionTitle">Outlets</div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr id="outletsHead">
                <th>Outlet</th>
              </tr>
            </thead>
            <tbody id="outletsBody"></tbody>
          </table>
        </div>

        <div id="appMsg" class="msg"></div>
      </div>

      <!-- USERS -->
      <div id="panelUsers" style="display:none;">
        <div class="sectionTitle">Admin – Users</div>

        <div class="card">
          <div class="hint" style="margin-bottom:10px;">
            Use Supabase to invite/create Auth users. Then select them here and set name/role/department.
          </div>

          <label style="display:block;font-size:12px;color:var(--muted);margin:6px 0;">Select user</label>
          <select id="userSelect" style="width:min(720px,100%);"></select>

          <div class="twoCol" style="margin-top:10px;">
            <div>
              <label style="margin:0;color:var(--muted);font-size:12px;">Full name</label>
              <input id="editUserName" placeholder="Full name" />
            </div>
            <div>
              <label style="margin:0;color:var(--muted);font-size:12px;">Email (read only)</label>
              <input id="editUserEmail" disabled />
            </div>
          </div>

          <div class="twoCol" style="margin-top:10px;">
            <div>
              <label style="margin:0;color:var(--muted);font-size:12px;">Role</label>
              <select id="editUserRole">
                <option value="viewer">viewer</option>
                <option value="user">user</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <div>
              <label style="margin:0;color:var(--muted);font-size:12px;">Department</label>
              <select id="editUserDept">
                <option value="Guest Service">Guest Service</option>
                <option value="F&B">F&amp;B</option>
                <option value="Outlets">Outlets</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <label style="margin:0;color:var(--muted);font-size:12px;">Active</label>
            <select id="editUserActive" style="width:160px;">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="btnSaveUser" class="btnPrimary">Save changes</button>
            <button id="btnReloadUsers" class="btnGhost">Reload list</button>
          </div>

          <div id="usersMsg" class="msg"></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="sectionTitle" style="margin-top:0;">Current users</div>
          <div class="tableWrap" style="box-shadow:none;">
            <table style="min-width:980px;">
              <thead>
                <tr>
                  <th style="width:260px;">Name</th>
                  <th>Email</th>
                  <th style="width:160px;">Role</th>
                  <th style="width:160px;">Department</th>
                  <th style="width:120px;">Active</th>
                </tr>
              </thead>
              <tbody id="usersTable"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

  </div>

  <!-- MODAL: Occupancy edit -->
  <div id="occModalBack" class="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <b id="occModalTitle">Edit</b>
        <button id="btnOccClose" class="btnGhost xBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="twoCol">
          <div>
            <label style="margin:0;color:var(--muted);font-size:12px;">Occupancy % (0–100)</label>
            <input id="occInput" type="number" min="0" max="100" step="0.1" placeholder="e.g. 78.5" />
          </div>
          <div>
            <label style="margin:0;color:var(--muted);font-size:12px;">Notes</label>
            <div class="hint">Bigger box so notes are easy to read.</div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <textarea id="occNotes" placeholder="Type full notes here…"></textarea>
        </div>

        <div id="occModalMsg" class="msg"></div>
      </div>
      <div class="modalFooter">
        <button id="btnOccSave" class="btnPrimary">Save</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Outlet/Lobby edit -->
  <div id="outletModalBack" class="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <b id="outletModalTitle">Edit</b>
        <button id="btnOutletClose" class="btnGhost xBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="twoCol">
          <div>
            <label style="margin:0;color:var(--muted);font-size:12px;">Status</label>
            <select id="outletIsOpen">
              <option value="false">Closed</option>
              <option value="true">Open</option>
            </select>
          </div>
          <div>
            <label style="margin:0;color:var(--muted);font-size:12px;">Open time</label>
            <input id="outletOpenTime" type="time" />
          </div>
        </div>

        <div class="twoCol" style="margin-top:10px;">
          <div>
            <label style="margin:0;color:var(--muted);font-size:12px;">Close time</label>
            <input id="outletCloseTime" type="time" />
          </div>
          <div class="hint" style="display:flex;align-items:flex-end;">
            If Open is selected, both times are required.
          </div>
        </div>

        <div id="outletModalMsg" class="msg"></div>
      </div>
      <div class="modalFooter">
        <button id="btnOutletSave" class="btnPrimary">Save</button>
      </div>
    </div>
  </div>

  <script src="./supabase.js"></script>

  <script>
    const SUPABASE_URL = "https://jiarjsvoumbbilfsqftj.supabase.co";
    const SUPABASE_KEY = "sb_publishable_AB6JsEiTT1V5Bu5ANA0Qmw_yFE8M0NV";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const DAYS = 7;

    const loginView = document.getElementById("loginView");
    const recoveryView = document.getElementById("recoveryView");
    const appView = document.getElementById("appView");

    const tabDashboard = document.getElementById("tabDashboard");
    const tabUsers = document.getElementById("tabUsers");
    const panelDashboard = document.getElementById("panelDashboard");
    const panelUsers = document.getElementById("panelUsers");

    const rolePill = document.getElementById("rolePill");
    const deptPill = document.getElementById("deptPill");
    const userPill = document.getElementById("userPill");
    const permHint = document.getElementById("permHint");

    const startDateEl = document.getElementById("startDate");
    const occCards = document.getElementById("occCards");
    const headRow = document.getElementById("headRow");
    const bodyRows = document.getElementById("bodyRows");
    const appMsg = document.getElementById("appMsg");

    const lobbyHead = document.getElementById("lobbyHead");
    const lobbyBody = document.getElementById("lobbyBody");
    const outletsHead = document.getElementById("outletsHead");
    const outletsBody = document.getElementById("outletsBody");

    const loginMsg = document.getElementById("loginMsg");
    const recoveryMsg = document.getElementById("recoveryMsg");

    const setupName = document.getElementById("setupName");
    const setupEmail = document.getElementById("setupEmail");

    const usersMsg = document.getElementById("usersMsg");
    const usersTable = document.getElementById("usersTable");
    const userSelect = document.getElementById("userSelect");
    const editUserName = document.getElementById("editUserName");
    const editUserEmail = document.getElementById("editUserEmail");
    const editUserRole = document.getElementById("editUserRole");
    const editUserDept = document.getElementById("editUserDept");
    const editUserActive = document.getElementById("editUserActive");

    const occModalBack = document.getElementById("occModalBack");
    const occModalTitle = document.getElementById("occModalTitle");
    const occModalMsg = document.getElementById("occModalMsg");
    const occInput = document.getElementById("occInput");
    const occNotes = document.getElementById("occNotes");

    const outletModalBack = document.getElementById("outletModalBack");
    const outletModalTitle = document.getElementById("outletModalTitle");
    const outletModalMsg = document.getElementById("outletModalMsg");
    const outletIsOpen = document.getElementById("outletIsOpen");
    const outletOpenTime = document.getElementById("outletOpenTime");
    const outletCloseTime = document.getElementById("outletCloseTime");

    let currentUser = null;
    let myRole = "viewer";
    let myDept = "";
    let myName = "";

    let dashboardDays = [];
    let serviceByName = new Map();

    let dssMeta = new Map();
    let dmsMeta = new Map();
    let outletMap = new Map();

    let occEditDate = null;
    let outletEdit = { date:null, outlet_name:null };

    let adminUsersCache = []; // for dropdown

    const GROUPS = [
      { title: "Breakfast", groupName: "breakfast", items: [
        "BREAKFAST ALA CARTE",
        "BREAKFAST BUFFET REDUCED",
        "BREAKFAST FULL BUFFET",
        "BRUNCH",
        "SPECIAL BREAKFAST- CLOSED"
      ]},
      { title: "Lunch", groupName: "lunch", items: [
        "LUNCH ALA CARTE",
        "LUNCH BUFFET",
        "HOLIDAY LUNCH BUFFET BRUNCH",
        "SPECIAL LUNCH- CLOSED"
      ]},
      { title: "Dinner", groupName: "dinner", items: [
        "DINNER ALA CARTE",
        "DINNER BUFFET",
        "DINNER HOLIDAY /SPECIAL BUFFET",
        "DINNER CLOSED"
      ]},
      { title: "Massimo", groupName: "massimo", items: [
        "MASSIMO BREAKFAST",
        "MASSIMO LUNCH",
        "MASSIMO DINNER"
      ]}
    ];

    const LOBBY_BAR = ["LOBBY BAR"];
    const OUTLETS = ["STARBUCKS","SWEET JESUS","FRESHII"];

    function setMsg(el, text, type="") {
      el.className = "msg " + (type === "err" ? "err" : type === "ok" ? "oktxt" : type === "warn" ? "warntxt" : "");
      el.textContent = text || "";
    }
    function show(view){
      loginView.style.display = "none";
      recoveryView.style.display = "none";
      appView.style.display = "none";
      view.style.display = "block";
    }

    function isAdmin(){ return myRole === "admin"; }
    function isUser(){ return myRole === "user"; }

    function canEditOcc(){
      return isAdmin() || (isUser() && (myDept || "") === "Guest Service");
    }
    function canEditRestaurantAndLobby(){
      return isAdmin() || (isUser() && (myDept || "") === "F&B");
    }
    function canEditOutlets(){
      return isAdmin() || (isUser() && (myDept || "") === "Outlets");
    }

    function switchTab(which){
      tabDashboard.classList.remove("active");
      tabUsers.classList.remove("active");
      panelDashboard.style.display = "none";
      panelUsers.style.display = "none";

      if (which === "dashboard"){
        tabDashboard.classList.add("active");
        panelDashboard.style.display = "block";
      } else {
        tabUsers.classList.add("active");
        panelUsers.style.display = "block";
      }
    }

    function cleanUrlAll(){
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    }
    function parseHashParams(){
      const h = window.location.hash.startsWith("#") ? window.location.hash.slice(1) : window.location.hash;
      const p = new URLSearchParams(h);
      return {
        type: p.get("type"),
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token"),
        error: p.get("error"),
        error_description: p.get("error_description")
      };
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function toDateStr(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
    function fmtDay(d){
      const dt = new Date(d + "T00:00:00");
      return dt.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
    }
    function isToday(d){
      const t = new Date(); t.setHours(0,0,0,0);
      const dt = new Date(d + "T00:00:00");
      return dt.getTime() === t.getTime();
    }

    function fmtToronto(ts) {
      if (!ts) return "";
      try{
        return new Intl.DateTimeFormat("en-CA", {
          timeZone: "America/Toronto",
          year: "numeric", month: "short", day: "2-digit",
          hour: "2-digit", minute: "2-digit",
          hour12: true
        }).format(new Date(ts));
      } catch { return ""; }
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function keyDss(day, group){ return `${day}|${group}`; }
    function keyDms(day, serviceItemId){ return `${day}|${serviceItemId}`; }
    function keyOutlet(day, name){ return `${day}|${name}`; }

    function fmtTime12(hhmm){
      if (!hhmm) return "";
      const parts = String(hhmm).split(":");
      const h = Number(parts[0]);
      const m = Number(parts[1]);
      if (Number.isNaN(h) || Number.isNaN(m)) return hhmm;
      const ampm = h >= 12 ? "PM" : "AM";
      const hr = (h % 12) === 0 ? 12 : (h % 12);
      return `${hr}:${String(m).padStart(2,"0")} ${ampm}`;
    }

    function stampHtml(lines){
      const clean = lines.filter(Boolean);
      if (clean.length === 0) return "";
      const l1 = clean[0] ? `<div class="stampLine">${escapeHtml(clean[0])}</div>` : "";
      const l2 = clean[1] ? `<div class="stampLine2">${escapeHtml(clean[1])}</div>` : "";
      const l3 = clean[2] ? `<div class="stampLine2">${escapeHtml(clean[2])}</div>` : "";
      return `<div class="stamp">${l1}${l2}${l3}</div>`;
    }

    async function loadMyProfile(){
      const { data, error } = await sb
        .from("profiles")
        .select("role, full_name, email, department, is_active")
        .eq("user_id", currentUser.id)
        .maybeSingle();
      if (error) throw error;

      myRole = data?.role || "viewer";
      myName = data?.full_name || "";
      myDept = data?.department || "";

      if (data?.is_active === false){
        throw new Error("Your account is disabled. Contact an admin.");
      }
    }

    async function loadServiceItems(){
      const { data, error } = await sb
        .from("service_items")
        .select("id,name,group_name,sort_order")
        .order("sort_order", { ascending: true });
      if (error) throw error;
      serviceByName = new Map((data || []).map(x => [x.name, x]));
    }

    async function fetchDashboard(startDate){
      const { data, error } = await sb.rpc("get_dashboard", { p_start_date: startDate, p_days: DAYS });
      if (error) throw error;
      dashboardDays = data || [];
    }

    async function fetchRestaurantMeta(){
      dssMeta = new Map();
      dmsMeta = new Map();

      const days = (dashboardDays || []).map(x => x.day);
      if (days.length === 0) return;

      const { data: dss, error: e1 } = await sb
        .from("daily_service_selection")
        .select("date,group_name,selected_service_item_id,last_action_service_item_id,updated_by_name,updated_at")
        .in("date", days)
        .in("group_name", ["breakfast","lunch","dinner"]);
      if (e1) throw e1;

      for (const r of (dss || [])){
        dssMeta.set(keyDss(r.date, r.group_name), {
          selected: r.selected_service_item_id,
          last_action: r.last_action_service_item_id,
          by: r.updated_by_name,
          at: r.updated_at
        });
      }

      const massimoNames = ["MASSIMO BREAKFAST","MASSIMO LUNCH","MASSIMO DINNER"];
      const massimoIds = massimoNames.map(n => serviceByName.get(n)?.id).filter(v => v !== undefined && v !== null);

      if (massimoIds.length > 0){
        const { data: dms, error: e2 } = await sb
          .from("daily_massimo_status")
          .select("date,service_item_id,is_active,updated_by_name,updated_at")
          .in("date", days)
          .in("service_item_id", massimoIds);
        if (e2) throw e2;

        for (const r of (dms || [])){
          dmsMeta.set(keyDms(r.date, r.service_item_id), {
            on: !!r.is_active,
            by: r.updated_by_name,
            at: r.updated_at
          });
        }
      }
    }

    async function fetchOutletHours(){
      outletMap = new Map();
      const days = (dashboardDays || []).map(x => x.day);
      if (days.length === 0) return;

      const names = ["LOBBY BAR","STARBUCKS","SWEET JESUS","FRESHII"];
      const { data, error } = await sb
        .from("daily_outlet_hours")
        .select("date,outlet_name,is_open,open_time,close_time,updated_by_name,updated_at")
        .in("date", days)
        .in("outlet_name", names);

      if (error) throw error;

      for (const r of (data || [])){
        outletMap.set(keyOutlet(r.date, r.outlet_name), r);
      }
    }

    function buildHeaderRow(rowEl){
      while (rowEl.children.length > 1) rowEl.removeChild(rowEl.lastChild);
      for (const day of dashboardDays){
        const th = document.createElement("th");
        th.textContent = fmtDay(day.day);
        rowEl.appendChild(th);
      }
    }

    function openOccModal(day){
      const row = dashboardDays.find(x => x.day === day);
      occEditDate = day;

      occModalTitle.textContent = `Edit occupancy – ${day}`;
      setMsg(occModalMsg,"");

      occInput.value = (row?.occupancy_percent ?? "") === null ? "" : String(row?.occupancy_percent ?? "");
      occNotes.value = row?.notes || "";

      occModalBack.style.display = "flex";
      document.body.style.overflow = "hidden";
    }
    function closeOccModal(){
      occModalBack.style.display = "none";
      occEditDate = null;
      document.body.style.overflow = "";
    }

    async function saveOccModal(){
      try{
        if (!occEditDate) return;
        if (!canEditOcc()){
          setMsg(occModalMsg,"You do not have permission to edit occupancy.","err");
          return;
        }

        const occRaw = String(occInput.value || "").trim();
        const occNum = occRaw === "" ? null : Number(occRaw);
        if (occNum !== null && (Number.isNaN(occNum) || occNum < 0 || occNum > 100)){
          setMsg(occModalMsg,"Occupancy must be 0 to 100 (or blank).","err");
          return;
        }

        const notes = String(occNotes.value || "").trim() || null;

        setMsg(occModalMsg,"Saving…");

        const { error } = await sb
          .from("daily_forecast")
          .upsert({ date: occEditDate, occupancy_percent: occNum, notes }, { onConflict: "date" });

        if (error) throw error;

        const row = dashboardDays.find(x => x.day === occEditDate);
        if (row){
          row.occupancy_percent = occNum;
          row.notes = notes;
        }

        setMsg(occModalMsg,"Saved.","ok");
        renderOccCards();
        setTimeout(closeOccModal, 200);
      } catch(e){
        setMsg(occModalMsg, e?.message || String(e), "err");
      }
    }

    function renderOccCards(){
      occCards.innerHTML = "";
      for (const day of dashboardDays){
        const card = document.createElement("div");
        card.className = "daycard" + (isToday(day.day) ? " today" : "");

        const title = document.createElement("div");
        title.className = "daytitle";
        title.innerHTML = `<span>${fmtDay(day.day)}</span><span>${day.day}</span>`;

        const occ = document.createElement("div");
        occ.className = "occ";
        occ.textContent = (day.occupancy_percent === null || day.occupancy_percent === undefined)
          ? "—"
          : `${Number(day.occupancy_percent).toFixed(1)}%`;

        const notes = document.createElement("div");
        notes.className = "notes";
        notes.textContent = day.notes || "";

        card.appendChild(title);
        card.appendChild(occ);
        card.appendChild(notes);

        if (canEditOcc()){
          card.classList.add("clickable");
          card.title = "Click to edit (prefilled)";
          card.addEventListener("click", () => openOccModal(day.day));
        } else {
          card.title = "View only";
        }
        occCards.appendChild(card);
      }
    }

    function pickOneIsOn(day, serviceName){
      const item = serviceByName.get(serviceName);
      if (!item) return false;
      const group = item.group_name;
      if (!["breakfast","lunch","dinner"].includes(group)) return false;

      const meta = dssMeta.get(keyDss(day, group));
      return meta?.selected != null && String(meta.selected) === String(item.id);
    }

    function pickOneStamp(day, serviceName, isOn){
      const item = serviceByName.get(serviceName);
      if (!item) return "";
      const group = item.group_name;
      const meta = dssMeta.get(keyDss(day, group));
      if (!meta?.by || !meta?.at) return "";

      const isLastClicked = meta.last_action != null && String(meta.last_action) === String(item.id);
      if (isOn || (!meta.selected && isLastClicked)){
        return stampHtml([meta.by, fmtToronto(meta.at)]);
      }
      return "";
    }

    function massimoIsOn(day, serviceName){
      const item = serviceByName.get(serviceName);
      if (!item) return false;
      const meta = dmsMeta.get(keyDms(day, item.id));
      return !!meta?.on;
    }

    function massimoStamp(day, serviceName){
      const item = serviceByName.get(serviceName);
      if (!item) return "";
      const meta = dmsMeta.get(keyDms(day, item.id));
      if (!meta?.by || !meta?.at) return "";
      return stampHtml([meta.by, fmtToronto(meta.at)]);
    }

    async function setPickOne(date, serviceName){
      const item = serviceByName.get(serviceName);
      if (!item) throw new Error("Service item not found: " + serviceName);
      const group = item.group_name;
      const { error } = await sb
        .from("daily_service_selection")
        .upsert({
          date,
          group_name: group,
          selected_service_item_id: item.id,
          last_action_service_item_id: item.id
        }, { onConflict: "date,group_name" });
      if (error) throw error;
    }

    async function clearPickOne(date, serviceName){
      const item = serviceByName.get(serviceName);
      if (!item) throw new Error("Service item not found: " + serviceName);
      const group = item.group_name;
      const { error } = await sb
        .from("daily_service_selection")
        .upsert({
          date,
          group_name: group,
          selected_service_item_id: null,
          last_action_service_item_id: item.id
        }, { onConflict: "date,group_name" });
      if (error) throw error;
    }

    async function toggleMassimo(date, serviceName, isOn){
      const item = serviceByName.get(serviceName);
      if (!item) throw new Error("Service item not found: " + serviceName);
      const { error } = await sb
        .from("daily_massimo_status")
        .upsert({ date, service_item_id: item.id, is_active: !isOn }, { onConflict: "date,service_item_id" });
      if (error) throw error;
    }

    function renderRestaurantGrid(){
      bodyRows.innerHTML = "";
      const colspan = 1 + (dashboardDays?.length || DAYS);

      for (const group of GROUPS){
        const trg = document.createElement("tr");
        trg.className = "groupRow";
        const tdg = document.createElement("td");
        tdg.colSpan = colspan;
        tdg.textContent = group.title;
        trg.appendChild(tdg);
        bodyRows.appendChild(trg);

        for (const serviceName of group.items){
          const tr = document.createElement("tr");

          const tdLabel = document.createElement("td");
          tdLabel.innerHTML = `<div class="serviceName"><span>${escapeHtml(serviceName)}</span><span class="badge">${escapeHtml(group.title)}</span></div>`;
          tr.appendChild(tdLabel);

          for (const dayRow of dashboardDays){
            let isOn = false;
            let stamp = "";

            if (serviceName.startsWith("MASSIMO ")){
              isOn = massimoIsOn(dayRow.day, serviceName);
              stamp = massimoStamp(dayRow.day, serviceName);
            } else {
              isOn = pickOneIsOn(dayRow.day, serviceName);
              stamp = pickOneStamp(dayRow.day, serviceName, isOn);
            }

            const td = document.createElement("td");
            td.className = "statusCell " + (canEditRestaurantAndLobby() ? "clickable" : "");
            td.title = isOn ? "Active" : "Inactive";

            const fill = document.createElement("div");
            fill.className = "statusFill " + (isOn ? "isOn" : "isOff");
            fill.innerHTML = stamp;
            td.appendChild(fill);

            if (canEditRestaurantAndLobby()){
              td.addEventListener("click", async () => {
                try{
                  setMsg(appMsg, "");
                  if (serviceName.startsWith("MASSIMO ")){
                    await toggleMassimo(dayRow.day, serviceName, isOn);
                  } else {
                    await setPickOne(dayRow.day, serviceName);
                  }
                  await fetchRestaurantMeta();
                  renderRestaurantGrid();
                  setMsg(appMsg, "Saved.", "ok");
                } catch(e){
                  setMsg(appMsg, e?.message || String(e), "err");
                }
              });

              if (!serviceName.startsWith("MASSIMO ")){
                td.addEventListener("dblclick", async () => {
                  try{
                    if (!isOn) return;
                    setMsg(appMsg, "");
                    await clearPickOne(dayRow.day, serviceName);
                    await fetchRestaurantMeta();
                    renderRestaurantGrid();
                    setMsg(appMsg, "Cleared.", "ok");
                  } catch(e){
                    setMsg(appMsg, e?.message || String(e), "err");
                  }
                });
              }
            }

            tr.appendChild(td);
          }

          bodyRows.appendChild(tr);
        }
      }
    }

    function outletCellStamp(row){
      const who = row?.updated_by_name || "";
      const when = fmtToronto(row?.updated_at);
      const openLine = row?.is_open
        ? `OPEN ${fmtTime12(row?.open_time)}–${fmtTime12(row?.close_time)}`
        : "CLOSED";
      return stampHtml([openLine, who, when]);
    }

    function renderOutletTable(headerEl, bodyEl, names, canEditFn){
      bodyEl.innerHTML = "";
      buildHeaderRow(headerEl);

      for (const name of names){
        const tr = document.createElement("tr");
        const tdLabel = document.createElement("td");
        tdLabel.innerHTML = `<div class="serviceName"><span>${escapeHtml(name)}</span><span class="badge">${canEditFn() ? "Editable" : "View only"}</span></div>`;
        tr.appendChild(tdLabel);

        for (const dayRow of dashboardDays){
          const row = outletMap.get(keyOutlet(dayRow.day, name));
          const isOn = !!row?.is_open;

          const td = document.createElement("td");
          td.className = "statusCell " + (canEditFn() ? "clickable" : "");
          td.title = isOn ? "Open" : "Closed";

          const fill = document.createElement("div");
          fill.className = "statusFill " + (isOn ? "isOn" : "isOff");
          fill.innerHTML = outletCellStamp(row);
          td.appendChild(fill);

          if (canEditFn()){
            td.addEventListener("click", () => openOutletModal(dayRow.day, name));
          }
          tr.appendChild(td);
        }

        bodyEl.appendChild(tr);
      }
    }

    function openOutletModal(date, outletName){
      outletEdit = { date, outlet_name: outletName };
      const row = outletMap.get(keyOutlet(date, outletName));
      const isOpen = !!row?.is_open;

      outletModalTitle.textContent = `Edit – ${outletName} (${date})`;
      setMsg(outletModalMsg, "");

      outletIsOpen.value = String(isOpen);
      outletOpenTime.value = isOpen ? (row?.open_time || "") : "";
      outletCloseTime.value = isOpen ? (row?.close_time || "") : "";

      outletModalBack.style.display = "flex";
      document.body.style.overflow = "hidden";
      syncOutletTimeEnabled();
    }

    function closeOutletModal(){
      outletModalBack.style.display = "none";
      outletEdit = { date:null, outlet_name:null };
      document.body.style.overflow = "";
    }

    function syncOutletTimeEnabled(){
      const isOpen = (outletIsOpen.value === "true");
      outletOpenTime.disabled = !isOpen;
      outletCloseTime.disabled = !isOpen;
    }

    async function saveOutletModal(){
      try{
        const date = outletEdit.date;
        const outlet_name = outletEdit.outlet_name;
        if (!date || !outlet_name) return;

        const isLobby = (outlet_name === "LOBBY BAR");
        if (isLobby && !canEditRestaurantAndLobby()){
          setMsg(outletModalMsg, "Only F&B (or admin) can edit Lobby Bar.", "err");
          return;
        }
        if (!isLobby && !canEditOutlets()){
          setMsg(outletModalMsg, "Only Outlets (or admin) can edit outlets.", "err");
          return;
        }

        const is_open = (outletIsOpen.value === "true");
        let open_time = null;
        let close_time = null;

        if (is_open){
          open_time = String(outletOpenTime.value || "").trim();
          close_time = String(outletCloseTime.value || "").trim();
          if (!open_time || !close_time){
            setMsg(outletModalMsg, "If Open, both times are required.", "err");
            return;
          }
        }

        setMsg(outletModalMsg, "Saving…");

        const { error } = await sb
          .from("daily_outlet_hours")
          .upsert({ date, outlet_name, is_open, open_time, close_time }, { onConflict: "date,outlet_name" });

        if (error) throw error;

        await fetchOutletHours();
        renderOutletTable(lobbyHead, lobbyBody, LOBBY_BAR, () => canEditRestaurantAndLobby());
        renderOutletTable(outletsHead, outletsBody, OUTLETS, () => canEditOutlets());

        setMsg(outletModalMsg, "Saved.", "ok");
        setTimeout(closeOutletModal, 200);
      } catch(e){
        setMsg(outletModalMsg, e?.message || String(e), "err");
      }
    }

    function buildUsersDropdown(){
      userSelect.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select a user…";
      userSelect.appendChild(opt0);

      for (const u of adminUsersCache){
        const opt = document.createElement("option");
        opt.value = u.email || "";
        const labelName = (u.full_name || "(no name)");
        opt.textContent = `${labelName} — ${u.email || ""}`;
        userSelect.appendChild(opt);
      }
    }

    function fillUserEditorByEmail(email){
      const u = adminUsersCache.find(x => (x.email || "") === email);
      if (!u){
        editUserName.value = "";
        editUserEmail.value = "";
        editUserRole.value = "viewer";
        editUserDept.value = "Guest Service";
        editUserActive.value = "true";
        return;
      }
      editUserName.value = u.full_name || "";
      editUserEmail.value = u.email || "";
      editUserRole.value = (u.role || "viewer");
      editUserDept.value = (u.department || "Guest Service");
      editUserActive.value = String(!!u.is_active);
    }

    async function loadUsers(){
      if (!isAdmin()){
        setMsg(usersMsg, "Not authorized (admin only).", "err");
        return;
      }
      try{
        setMsg(usersMsg, "Loading users…");
        const { data, error } = await sb.rpc("admin_list_profiles");
        if (error) throw error;

        adminUsersCache = (data || []).slice().sort((a,b) => (a.full_name || "").localeCompare((b.full_name || "")));

        buildUsersDropdown();
        fillUserEditorByEmail(userSelect.value);

        usersTable.innerHTML = "";
        for (const r of adminUsersCache){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="text-align:left;">${escapeHtml(r.full_name || "")}</td>
            <td style="text-align:left;">${escapeHtml(r.email || "")}</td>
            <td>${escapeHtml(r.role || "")}</td>
            <td>${escapeHtml(r.department || "")}</td>
            <td>${escapeHtml(String(r.is_active))}</td>
          `;
          usersTable.appendChild(tr);
        }
        setMsg(usersMsg, "");
      } catch(e){
        setMsg(usersMsg, e?.message || String(e), "err");
      }
    }

    async function saveSelectedUser(){
      if (!isAdmin()){
        setMsg(usersMsg, "Not authorized (admin only).", "err");
        return;
      }

      const email = String(editUserEmail.value || "").trim();
      const name = String(editUserName.value || "").trim();
      const role = String(editUserRole.value || "").trim().toLowerCase();
      const dept = String(editUserDept.value || "").trim();
      const active = (String(editUserActive.value) === "true");

      if (!email) return setMsg(usersMsg, "Select a user first.", "err");
      if (!name) return setMsg(usersMsg, "Name is required.", "err");

      try{
        setMsg(usersMsg, "Saving…");
        const { error } = await sb.rpc("admin_upsert_profile_by_email", {
          p_email: email,
          p_full_name: name,
          p_role: role,
          p_department: dept,
          p_is_active: active
        });
        if (error) throw error;

        setMsg(usersMsg, "Saved.", "ok");
        await loadUsers();
        userSelect.value = email;
        fillUserEditorByEmail(email);
      } catch(e){
        setMsg(usersMsg, e?.message || String(e), "err");
      }
    }

    async function refreshAll(){
      try{
        setMsg(appMsg, "Loading…");
        await loadServiceItems();
        await fetchDashboard(startDateEl.value);
        await fetchRestaurantMeta();
        await fetchOutletHours();

        buildHeaderRow(headRow);
        buildHeaderRow(lobbyHead);
        buildHeaderRow(outletsHead);

        renderOccCards();
        renderRestaurantGrid();
        renderOutletTable(lobbyHead, lobbyBody, LOBBY_BAR, () => canEditRestaurantAndLobby());
        renderOutletTable(outletsHead, outletsBody, OUTLETS, () => canEditOutlets());

        setMsg(appMsg, "");
      } catch(e){
        setMsg(appMsg, e?.message || String(e), "err");
      }
    }

    async function showApp(){
      show(appView);

      rolePill.textContent = `Role: ${myRole}`;
      deptPill.textContent = `Dept: ${myDept || "—"}`;
      userPill.textContent = `User: ${myName ? myName : (currentUser?.email || "")}`;

      tabUsers.style.display = isAdmin() ? "inline-flex" : "none";

      const parts = [];
      parts.push(canEditOcc() ? "✅ Occupancy" : "❌ Occupancy");
      parts.push(canEditRestaurantAndLobby() ? "✅ Restaurant/Lobby" : "❌ Restaurant/Lobby");
      parts.push(canEditOutlets() ? "✅ Outlets" : "❌ Outlets");
      permHint.style.display = (!isAdmin() ? "block" : "none");
      permHint.textContent = (!isAdmin() ? ("Permissions: " + parts.join(" • ")) : "");

      startDateEl.value = toDateStr(new Date());

      switchTab("dashboard");
      await refreshAll();
      if (isAdmin()) await loadUsers();
    }

    // IMPORTANT: Invite links now open this setup screen too
    async function handleRecoveryFromUrl(){
      const isPwFlow = (t) => t === "recovery" || t === "invite";

      const hp = parseHashParams();
      if (hp.error){
        setMsg(loginMsg, "Auth link error: " + (hp.error_description || hp.error), "err");
        cleanUrlAll();
        show(loginView);
        return true;
      }
      if (isPwFlow(hp.type) && hp.access_token && hp.refresh_token){
        const { error } = await sb.auth.setSession({
          access_token: hp.access_token,
          refresh_token: hp.refresh_token
        });
        cleanUrlAll();
        if (error){
          setMsg(recoveryMsg, "Link error: " + error.message, "err");
          show(loginView);
        } else {
          await prefillSetupFields();
          show(recoveryView);
        }
        return true;
      }

      const sp = new URLSearchParams(window.location.search);
      const type = sp.get("type");
      const code = sp.get("code");
      const tokenHash = sp.get("token_hash") || sp.get("token");

      if (isPwFlow(type) && code){
        const { error } = await sb.auth.exchangeCodeForSession(code);
        cleanUrlAll();
        if (error){
          setMsg(recoveryMsg, "Link error: " + error.message, "err");
          show(loginView);
        } else {
          await prefillSetupFields();
          show(recoveryView);
        }
        return true;
      }

      if (isPwFlow(type) && tokenHash){
        const { error } = await sb.auth.verifyOtp({ type, token_hash: tokenHash });
        cleanUrlAll();
        if (error){
          setMsg(recoveryMsg, "Link error: " + error.message, "err");
          show(loginView);
        } else {
          await prefillSetupFields();
          show(recoveryView);
        }
        return true;
      }

      return false;
    }

    async function prefillSetupFields(){
      const { data } = await sb.auth.getSession();
      const email = data?.session?.user?.email || "";
      if (email) setupEmail.value = email;
      // name stays blank so they must enter it (as you wanted)
      setupName.value = setupName.value || "";
    }

    // UI actions
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!email || !password) return setMsg(loginMsg, "Enter email and password.", "err");

      try{
        setMsg(loginMsg, "Signing in…");
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        await loadMyProfile();
        setMsg(loginMsg, "");
        await showApp();
      } catch(e){
        setMsg(loginMsg, e?.message || String(e), "err");
      }
    });

    document.getElementById("btnForgot").addEventListener("click", async () => {
      const email = document.getElementById("email").value.trim();
      if (!email) return setMsg(loginMsg, "Enter your email first.", "err");

      try{
        setMsg(loginMsg, "Sending reset email…");
        const redirectTo = window.location.origin + window.location.pathname;
        const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) throw error;
        setMsg(loginMsg, "Reset email sent. Open the link, then set your new password.", "ok");
      } catch(e){
        setMsg(loginMsg, e?.message || String(e), "err");
      }
    });

    document.getElementById("btnSetPass").addEventListener("click", async () => {
      const fullName = String(setupName.value || "").trim();
      const email = String(setupEmail.value || "").trim().toLowerCase();
      const p1 = document.getElementById("newPass").value;
      const p2 = document.getElementById("newPass2").value;

      if (!fullName) return setMsg(recoveryMsg, "Please enter your full name.", "err");
      if (!email) return setMsg(recoveryMsg, "Please enter your email.", "err");
      if (!p1 || p1.length < 6) return setMsg(recoveryMsg, "Password must be at least 6 characters.", "err");
      if (p1 !== p2) return setMsg(recoveryMsg, "Passwords do not match.", "err");

      try{
        setMsg(recoveryMsg, "Saving…");

        // must have a session from invite/reset link
        const { data: sessData } = await sb.auth.getSession();
        if (!sessData?.session){
          setMsg(recoveryMsg, "No session found. Open the invite/reset link again.", "err");
          return;
        }

        // 1) set password
        const { error: e1 } = await sb.auth.updateUser({ password: p1 });
        if (e1) throw e1;

        // 2) save name + email into profiles using safe RPC
        const { error: e2 } = await sb.rpc("self_update_profile", {
          p_full_name: fullName,
          p_email: email
        });
        if (e2) throw e2;

        setMsg(recoveryMsg, "Setup saved. Please sign in with your new password.", "ok");
        await sb.auth.signOut();
        show(loginView);
      } catch(e){
        setMsg(recoveryMsg, e?.message || String(e), "err");
      }
    });

    document.getElementById("btnCancelRecovery").addEventListener("click", async () => {
      await sb.auth.signOut();
      cleanUrlAll();
      show(loginView);
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await sb.auth.signOut();
      currentUser = null;
      myRole = "viewer";
      myDept = "";
      myName = "";
      show(loginView);
    });

    tabDashboard.addEventListener("click", () => switchTab("dashboard"));
    tabUsers.addEventListener("click", async () => { switchTab("users"); await loadUsers(); });

    document.getElementById("btnRefresh").addEventListener("click", refreshAll);
    startDateEl.addEventListener("change", refreshAll);
    document.getElementById("btnToday").addEventListener("click", () => {
      startDateEl.value = toDateStr(new Date());
      refreshAll();
    });

    document.getElementById("btnOccClose").addEventListener("click", closeOccModal);
    document.getElementById("btnOccSave").addEventListener("click", saveOccModal);
    occModalBack.addEventListener("click", (e) => { if (e.target === occModalBack) closeOccModal(); });

    document.getElementById("btnOutletClose").addEventListener("click", closeOutletModal);
    document.getElementById("btnOutletSave").addEventListener("click", saveOutletModal);
    outletModalBack.addEventListener("click", (e) => { if (e.target === outletModalBack) closeOutletModal(); });
    outletIsOpen.addEventListener("change", syncOutletTimeEnabled);

    document.getElementById("btnReloadUsers").addEventListener("click", loadUsers);
    document.getElementById("btnSaveUser").addEventListener("click", saveSelectedUser);
    userSelect.addEventListener("change", () => fillUserEditorByEmail(userSelect.value));

    (async () => {
      const didRecovery = await handleRecoveryFromUrl();
      if (didRecovery) return;

      const { data } = await sb.auth.getSession();
      if (data?.session?.user){
        try{
          currentUser = data.session.user;
          await loadMyProfile();
          await showApp();
        } catch(e){
          await sb.auth.signOut();
          setMsg(loginMsg, e?.message || String(e), "err");
          show(loginView);
        }
      } else {
        show(loginView);
      }
    })();
  </script>
</body>
</html>
