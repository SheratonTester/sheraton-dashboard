<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheraton Niagara Falls – Ops Dashboard</title>

  <!-- IMPORTANT:
    This file expects a local Supabase JS UMD build at: ./supabase.js
    (You already did this earlier when CDNs were blocked.)
  -->
  <script src="./supabase.js"></script>

  <style>
    :root{
      --bg:#f4f8ff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#dbe6ff;
      --brand:#2563eb;

      --good:#0b5a35; /* dark green */
      --bad:#7a0f1c;  /* dark red */
      --goodSoft:#e7f6ee;
      --badSoft:#fde8eb;

      --shadow:0 10px 30px rgba(15,23,42,.08);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background: radial-gradient(1200px 500px at 20% 0%, #dbeafe 0%, rgba(219,234,254,0) 60%),
                  radial-gradient(900px 500px at 90% 10%, #e0e7ff 0%, rgba(224,231,255,0) 55%),
                  var(--bg);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(244,248,255,.75);
      border-bottom:1px solid var(--line);
    }
    .topbar-inner{
      max-width:1200px; margin:0 auto;
      padding:14px 16px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:flex-end; gap:10px;
    }
    .brand h1{
      font-size:18px; margin:0; letter-spacing:.2px;
    }
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--muted);
      display:inline-flex; gap:6px; align-items:center;
    }
    .badge strong{color:var(--ink); font-weight:700}

    .nav{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .btn{
      appearance:none; border:1px solid var(--line);
      background:#fff;
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 1px 0 rgba(15,23,42,.03);
    }
    .btn:hover{border-color:#bcd3ff}
    .btn.primary{
      background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
      border-color:#1d4ed8;
      color:#fff;
    }
    .btn.danger{
      background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
      border-color:#b91c1c;
      color:#fff;
    }
    .btn.ghost{
      background:transparent;
    }
    .btn.small{padding:8px 10px; border-radius:10px; font-size:13px}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .container{max-width:1200px; margin:0 auto; padding:16px}
    .grid{display:grid; gap:14px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
    }
    .card-h h2{margin:0; font-size:14px; color:var(--muted); font-weight:900; letter-spacing:.2px}
    .card-b{padding:14px 16px}

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .field{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .field label{font-size:12px; color:var(--muted); font-weight:800}
    .field input, .field select, .field textarea{
      font:inherit; border:none; outline:none;
      min-width:140px;
      color:var(--ink);
      background:transparent;
    }
    .field textarea{min-width:260px; min-height:90px; resize:vertical}

    .hint{
      font-size:12px; color:var(--muted);
    }
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
      color:var(--muted);
      display:none;
    }
    .msg.ok{display:block; border-color:#bbf7d0; background:#f0fdf4; color:#14532d}
    .msg.err{display:block; border-color:#fecaca; background:#fff1f2; color:#7f1d1d}
    .msg.info{display:block; border-color:#bfdbfe; background:#eff6ff; color:#1e3a8a}

    /* Occupancy cards */
    .occ-row{
      display:grid;
      grid-template-columns: repeat(7, minmax(170px, 1fr));
      gap:12px;
      overflow:auto;
      padding-bottom:6px;
    }
    .occ-tile{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:12px;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
      cursor:pointer;
      min-height:110px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .occ-tile:hover{border-color:#bcd3ff}
    .occ-top{
      display:flex; justify-content:space-between; gap:10px;
      align-items:flex-start;
    }
    .occ-day{font-weight:900; font-size:13px; color:#1e293b}
    .occ-date{font-size:12px; color:var(--muted)}
    .occ-val{font-size:28px; font-weight:1000; letter-spacing:-.5px}
    .occ-meta{font-size:11px; color:var(--muted); margin-top:8px; line-height:1.2}

    /* Status tables */
    .table-wrap{
      overflow:auto;
      border-top:1px solid var(--line);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:980px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      vertical-align:middle;
      background:#fff;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:#f8fbff;
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      text-align:center;
      border-bottom:1px solid var(--line);
    }
    .col-service{
      position:sticky;
      left:0;
      z-index:3;
      text-align:left;
      min-width:220px;
      max-width:260px;
      background:#fff;
    }
    .section-row td{
      background: linear-gradient(180deg, #eef2ff 0%, #e0e7ff 100%);
      font-weight:1000;
      color:#1e293b;
      letter-spacing:.3px;
      border-bottom:1px solid #c7d2fe;
    }

    .pill{
      font-size:11px;
      font-weight:900;
      color:#1e293b;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }

    .cell{
      text-align:center;
      padding:8px;
    }
    .status-box{
      width:100%;
      height:38px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
      cursor:pointer;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .status-box.red{background:var(--bad)}
    .status-box.green{background:var(--good)}
    .status-box.disabled{
      opacity:.45; cursor:not-allowed;
      filter:grayscale(.2);
    }
    .status-box .mini{
      position:absolute;
      inset:auto 6px 5px auto;
      font-size:10px;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
      max-width:calc(100% - 12px);
      overflow:hidden;
      text-overflow:ellipsis;
      display:none;
    }
    .status-box:hover .mini{display:block}

    /* Outlet cells show text */
    .status-box.outlet{
      height:auto;
      padding:10px 8px;
      min-height:44px;
      flex-direction:column;
      gap:4px;
    }
    .status-box.outlet .otxt{
      font-size:12px;
      color:#fff;
      font-weight:1000;
      line-height:1.1;
    }
    .status-box.outlet .mini{display:block; position:static; font-size:10px; opacity:.9}

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(840px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,.12);
      box-shadow:0 30px 80px rgba(2,6,23,.35);
      overflow:hidden;
    }
    .modal-h{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:#f8fbff;
    }
    .modal-h strong{font-size:14px}
    .modal-b{padding:14px 16px}
    .modal-actions{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
      background:#fff;
    }

    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .note-long textarea{min-height:160px}

    /* Auth */
    .auth-wrap{
      min-height:calc(100vh - 70px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .auth-card{
      width:min(520px, 100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .auth-head{
      padding:16px 18px;
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
      border-bottom:1px solid var(--line);
    }
    .auth-head h2{margin:0 0 4px 0; font-size:18px}
    .auth-head p{margin:0; color:var(--muted); font-size:13px}
    .auth-body{padding:16px 18px}
    .auth-body .field{width:100%}
    .auth-body .field input{width:100%}
    .auth-body .row{display:grid; gap:10px}

    /* Mobile tweaks */
    @media (max-width: 820px){
      .occ-row{grid-template-columns: repeat(7, minmax(150px, 1fr))}
      .col-service{min-width:160px; max-width:200px}
      .two-col{grid-template-columns:1fr}
      .topbar-inner{gap:10px}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1>Sheraton Niagara Falls – Ops Dashboard</h1>
      </div>

      <div class="badges" id="userBadges" style="display:none;">
        <span class="badge"><strong>Role:</strong> <span id="bRole"></span></span>
        <span class="badge"><strong>Dept:</strong> <span id="bDept"></span></span>
        <span class="badge"><strong>User:</strong> <span id="bName"></span></span>
      </div>

      <div class="nav" id="navBtns" style="display:none;">
        <button class="btn small" id="btnDash">Dashboard</button>
        <button class="btn small" id="btnUsers" style="display:none;">Users</button>
        <button class="btn small danger" id="btnLogout">Logout</button>
      </div>
    </div>
  </div>

  <div class="container" id="appRoot">
    <div class="msg" id="globalMsg"></div>

    <!-- AUTH -->
    <div id="viewAuth" class="auth-wrap" style="display:none;">
      <div class="auth-card">
        <div class="auth-head">
          <h2 id="authTitle">Sign in</h2>
          <p id="authSub">Use your work email and password.</p>
        </div>
        <div class="auth-body">
          <div class="row" id="authFormSignin">
            <div class="field">
              <label>Email</label>
              <input id="inEmail" type="email" placeholder="name@niagarafallshotels.com" autocomplete="email" />
            </div>
            <div class="field">
              <label>Password</label>
              <input id="inPass" type="password" placeholder="••••••••" autocomplete="current-password" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn" id="btnForgot">Forgot password</button>
              <button class="btn primary" id="btnSignin">Sign in</button>
            </div>
          </div>

          <div class="row" id="authFormReset" style="display:none;">
            <div class="field">
              <label>Email</label>
              <input id="resetEmail" type="email" placeholder="name@niagarafallshotels.com" autocomplete="email" />
            </div>
            <div class="hint">
              We’ll email you a reset link. If your link lands back on the login screen, open it again and wait 2–3 seconds.
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn" id="btnBackSignin">Back</button>
              <button class="btn primary" id="btnSendReset">Send reset link</button>
            </div>
          </div>

          <div class="row" id="authFormSetPassword" style="display:none;">
            <div class="hint" style="margin-bottom:6px;">
              Finish setup: set your name + new password.
            </div>
            <div class="field">
              <label>Full name</label>
              <input id="setName" type="text" placeholder="Full name" />
            </div>
            <div class="field">
              <label>New password</label>
              <input id="setPass1" type="password" placeholder="••••••••" autocomplete="new-password" />
            </div>
            <div class="field">
              <label>Confirm</label>
              <input id="setPass2" type="password" placeholder="••••••••" autocomplete="new-password" />
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
              <button class="btn" id="btnSetCancel">Cancel</button>
              <button class="btn primary" id="btnSetSave">Save & continue</button>
            </div>
          </div>

          <div class="msg" id="authMsg"></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="viewApp" style="display:none;">
      <div class="card">
        <div class="card-b">
          <div class="controls">
            <div class="field">
              <label>Start date</label>
              <input id="startDate" type="date" />
            </div>
            <button class="btn" id="btnToday">Today</button>
            <button class="btn primary" id="btnRefresh">Refresh</button>
            <button class="btn" id="btnPdf">Download 7-Day PDF Snapshot</button>

            <div class="hint" style="margin-left:auto;">
              Editors: tap occupancy cards to edit. Tap status boxes to change.
            </div>
          </div>
          <div class="msg" id="appMsg"></div>
        </div>
      </div>

      <!-- DASHBOARD VIEW -->
      <div id="viewDashboard" class="grid" style="margin-top:14px;">
        <div class="card">
          <div class="card-h">
            <h2>7-Day Occupancy Forecast</h2>
            <span class="pill">Toronto time</span>
          </div>
          <div class="card-b">
            <div class="occ-row" id="occRow"></div>
            <div class="hint" style="margin-top:10px;">
              Tip: On mobile, swipe the cards left/right.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h2>Restaurant Status (Green = Active, Red = Inactive)</h2>
            <span class="pill">Double-click green to clear (closed)</span>
          </div>
          <div class="table-wrap">
            <table id="tblRestaurants">
              <thead>
                <tr id="restHeadRow">
                  <th class="col-service">Service</th>
                </tr>
              </thead>
              <tbody id="restBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h2>Lobby Bar & Outlets</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn small" id="btnEditOutletWeek" style="display:none;">Edit Outlets Week</button>
            </div>
          </div>
          <div class="table-wrap">
            <table id="tblOutlets">
              <thead>
                <tr id="outHeadRow">
                  <th class="col-service">Outlet</th>
                </tr>
              </thead>
              <tbody id="outBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- USERS VIEW -->
      <div id="viewUsers" class="grid" style="margin-top:14px; display:none;">
        <div class="card">
          <div class="card-h">
            <h2>Admin – Users</h2>
            <span class="pill">Name + role + department</span>
          </div>
          <div class="card-b">
            <div class="hint" style="margin-bottom:10px;">
              Pick a user, edit details, then save. No UIDs shown.
            </div>

            <div class="two-col">
              <div class="field" style="width:100%;">
                <label>Select user</label>
                <select id="selUser"></select>
              </div>

              <div class="field" style="width:100%;">
                <label>Email (read-only)</label>
                <input id="uEmail" type="text" readonly />
              </div>

              <div class="field" style="width:100%;">
                <label>Full name</label>
                <input id="uName" type="text" />
              </div>

              <div class="field" style="width:100%;">
                <label>Role</label>
                <select id="uRole">
                  <option value="admin">admin</option>
                  <option value="user">user</option>
                  <option value="viewer">viewer</option>
                </select>
              </div>

              <div class="field" style="width:100%;">
                <label>Department</label>
                <select id="uDept">
                  <option value="">(none)</option>
                  <option value="Guest Service">Guest Service</option>
                  <option value="F&B">F&B</option>
                  <option value="Outlets">Outlets</option>
                </select>
              </div>

              <div class="field" style="width:100%;">
                <label>Active</label>
                <select id="uActive">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
              <button class="btn" id="btnReloadUsers">Reload list</button>
              <button class="btn primary" id="btnSaveUser">Save changes</button>
            </div>

            <div class="msg" id="usersMsg"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h2>Current users</h2>
          </div>
          <div class="table-wrap">
            <table style="min-width:820px;">
              <thead>
                <tr>
                  <th class="col-service">Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Department</th>
                  <th>Active</th>
                </tr>
              </thead>
              <tbody id="usersTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- OCC MODAL -->
  <div class="overlay" id="occOverlay">
    <div class="modal">
      <div class="modal-h">
        <strong id="occTitle">Edit occupancy</strong>
        <button class="btn small" id="occClose">Close</button>
      </div>
      <div class="modal-b">
        <div class="two-col">
          <div class="field">
            <label>Occupancy % (0–100)</label>
            <input id="occPct" type="number" min="0" max="100" step="0.1" />
          </div>
          <div class="field">
            <label>Notes (short)</label>
            <input id="occNote" type="text" placeholder="Optional" />
          </div>
        </div>

        <div class="field note-long" style="margin-top:12px;">
          <label>Notes (long)</label>
          <textarea id="occLong" placeholder="Write longer notes here..."></textarea>
        </div>

        <div class="hint" style="margin-top:8px;">
          Saving overwrites the current value but history remains in your DB history tables.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="occSave">Save</button>
      </div>
    </div>
  </div>

  <!-- OUTLET DAY MODAL -->
  <div class="overlay" id="outOverlay">
    <div class="modal">
      <div class="modal-h">
        <strong id="outTitle">Edit outlet</strong>
        <button class="btn small" id="outClose">Close</button>
      </div>
      <div class="modal-b">
        <div class="two-col">
          <div class="field">
            <label>Status</label>
            <select id="outOpen">
              <option value="false">Closed</option>
              <option value="true">Open</option>
            </select>
          </div>
          <div class="field">
            <label>Open time</label>
            <input id="outTimeOpen" type="time" />
          </div>
          <div class="field">
            <label>Close time</label>
            <input id="outTimeClose" type="time" />
          </div>
          <div class="hint" style="align-self:center;">
            If Open = true, times are required.
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="outSave">Save</button>
      </div>
    </div>
  </div>

  <!-- OUTLET WEEK MODAL -->
  <div class="overlay" id="outWeekOverlay">
    <div class="modal">
      <div class="modal-h">
        <strong id="outWeekTitle">Edit Outlets Week</strong>
        <button class="btn small" id="outWeekClose">Close</button>
      </div>
      <div class="modal-b">
        <div class="hint" style="margin-bottom:10px;">
          Fill as much as you want. If a day is set to Open, times are required.
        </div>

        <div class="table-wrap" style="border:1px solid var(--line); border-radius:14px;">
          <table style="min-width:760px;">
            <thead>
              <tr>
                <th class="col-service">Date</th>
                <th>Starbucks</th>
                <th>Sweet Jesus</th>
                <th>Freshii</th>
              </tr>
            </thead>
            <tbody id="outWeekBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" id="outWeekSave">Save week</button>
      </div>
    </div>
  </div>

  <script>
    /********************
     * CONFIG (your project)
     ********************/
    const SUPABASE_URL = "https://jiarjsvoumbbilfsqftj.supabase.co";
    const SUPABASE_KEY = "sb_publishable_AB6JsEiTT1V5Bu5ANA0Qmw_yFE8M0NV";
    const TIMEZONE = "America/Toronto";
    const DAYS = 7;

    /********************
     * SAFE HELPERS
     ********************/
    const $ = (id) => document.getElementById(id);
    const showMsg = (el, text, kind="info") => {
      el.className = "msg " + (kind || "info");
      el.textContent = text || "";
      el.style.display = text ? "block" : "none";
    };
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function toISODateToronto(d=new Date()){
      // Format as YYYY-MM-DD in Toronto time
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: TIMEZONE, year:"numeric", month:"2-digit", day:"2-digit"
      }).formatToParts(d);
      const y = parts.find(p=>p.type==="year").value;
      const m = parts.find(p=>p.type==="month").value;
      const da = parts.find(p=>p.type==="day").value;
      return `${y}-${m}-${da}`;
    }

    function fmtDay(yyyy_mm_dd){
      const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
      return new Intl.DateTimeFormat("en-CA", {
        timeZone: TIMEZONE, weekday:"short", month:"short", day:"2-digit"
      }).format(dt);
    }

    function fmtTsToronto(ts){
      if (!ts) return "";
      const dt = new Date(ts);
      return new Intl.DateTimeFormat("en-CA", {
        timeZone: TIMEZONE,
        year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit"
      }).format(dt);
    }

    function addDays(yyyy_mm_dd, n){
      const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
      dt.setUTCDate(dt.getUTCDate() + n);
      const yy = dt.getUTCFullYear();
      const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
      const dd = String(dt.getUTCDate()).padStart(2,"0");
      return `${yy}-${mm}-${dd}`;
    }

    function fmtTime12(timeStr){
      if (!timeStr) return "";
      const parts = String(timeStr).split(":");
      if (parts.length < 2) return "";
      let hh = parseInt(parts[0],10);
      const mm = parts[1].padStart(2,"0");
      const ap = hh >= 12 ? "PM" : "AM";
      hh = hh % 12; if (hh===0) hh=12;
      return `${hh}:${mm} ${ap}`;
    }

    /********************
     * SUPABASE INIT
     ********************/
    const globalMsg = $("globalMsg");
    if (!window.supabase || !window.supabase.createClient){
      showMsg(globalMsg,
        "Supabase library not found. Make sure supabase.js is in the repo root (same folder as index.html).",
        "err"
      );
    }
    const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_KEY);

    /********************
     * STATE
     ********************/
    let session = null;
    let me = { user_id:null, role:"viewer", department:null, name:"", email:"" };

    let dash = null;
    let days = []; // array of YYYY-MM-DD
    let serviceItems = []; // from RPC
    let serviceById = new Map(); // uuid -> item
    let itemsByGroup = { breakfast:[], lunch:[], dinner:[], massimo:[] };

    // daily maps
    let forecastByDate = new Map(); // date -> row
    let selByKey = new Map(); // `${date}|${group}` -> row
    let massimoByKey = new Map(); // `${date}|${service_item_id}` -> row
    let outletByKey = new Map(); // `${date}|${outlet}` -> row
    let profiles = []; // from RPC
    let profileById = new Map(); // uuid -> profile

    // modals
    let occEditDate = null;
    let outEdit = { date:null, outlet:null };
    let outWeekDraft = []; // for week editor

    /********************
     * PERMISSIONS
     ********************/
    function canAdmin(){ return me.role === "admin"; }
    function canViewUsers(){ return canAdmin(); }

    function canEditForecast(){
      return canAdmin() || (me.role==="user" && me.department==="Guest Service");
    }
    function canEditRestaurants(){
      return canAdmin() || (me.role==="user" && me.department==="F&B");
    }
    function canEditLobbyBar(){
      return canAdmin() || (me.role==="user" && me.department==="F&B");
    }
    function canEditOutlets(){
      return canAdmin() || (me.role==="user" && me.department==="Outlets");
    }

    /********************
     * VIEWS
     ********************/
    const viewAuth = $("viewAuth");
    const viewApp = $("viewApp");
    const navBtns = $("navBtns");
    const userBadges = $("userBadges");
    const btnUsers = $("btnUsers");
    const viewDashboard = $("viewDashboard");
    const viewUsers = $("viewUsers");

    function showAuth(mode="signin"){
      viewApp.style.display = "none";
      navBtns.style.display = "none";
      userBadges.style.display = "none";
      viewAuth.style.display = "flex";

      $("authFormSignin").style.display = (mode==="signin") ? "grid" : "none";
      $("authFormReset").style.display = (mode==="reset") ? "grid" : "none";
      $("authFormSetPassword").style.display = (mode==="setpass") ? "grid" : "none";

      showMsg($("authMsg"), "", "info");

      if (mode==="signin"){
        $("authTitle").textContent = "Sign in";
        $("authSub").textContent = "Use your work email and password.";
      }
      if (mode==="reset"){
        $("authTitle").textContent = "Reset password";
        $("authSub").textContent = "We’ll email you a reset link.";
      }
      if (mode==="setpass"){
        $("authTitle").textContent = "Set your password";
        $("authSub").textContent = "Finish setup to access the dashboard.";
      }
    }

    function showApp(){
      viewAuth.style.display = "none";
      viewApp.style.display = "block";
      navBtns.style.display = "flex";
      userBadges.style.display = "flex";

      $("bRole").textContent = me.role || "viewer";
      $("bDept").textContent = me.department || "—";
      $("bName").textContent = me.name || me.email || "—";

      btnUsers.style.display = canViewUsers() ? "inline-flex" : "none";
      showDashboard();
    }

    function showDashboard(){
      viewDashboard.style.display = "grid";
      viewUsers.style.display = "none";
    }
    function showUsers(){
      viewDashboard.style.display = "none";
      viewUsers.style.display = "grid";
    }

    /********************
     * AUTH HANDLING
     ********************/
    async function handleAuthLinksIfAny(){
      // Support code-based links: ?code=... (invite/reset)
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      const type = url.searchParams.get("type"); // invite / recovery / magiclink etc

      if (sb && code){
        try{
          showMsg(globalMsg, "Finishing sign-in link…", "info");
          const { data, error } = await sb.auth.exchangeCodeForSession(code);
          if (error) throw error;

          // Clean URL (remove code)
          url.searchParams.delete("code");
          url.searchParams.delete("type");
          window.history.replaceState({}, document.title, url.toString());

          // If invite or recovery, show set password UI
          if (type === "invite" || type === "recovery"){
            showAuth("setpass");
            return true;
          }
        }catch(e){
          showMsg(globalMsg, e?.message || String(e), "err");
        }
      }
      return false;
    }

    async function loadSession(){
      if (!sb) return;
      const { data } = await sb.auth.getSession();
      session = data?.session || null;
    }

    async function signIn(email, password){
      const authMsg = $("authMsg");
      try{
        showMsg(authMsg, "Signing in…", "info");
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        session = data.session;
        showMsg(authMsg, "Signed in.", "ok");
        await initAfterLogin();
      }catch(e){
        showMsg(authMsg, e?.message || String(e), "err");
      }
    }

    async function sendReset(email){
      const authMsg = $("authMsg");
      try{
        showMsg(authMsg, "Sending reset link…", "info");
        const redirectTo = window.location.origin + window.location.pathname; // same page
        const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) throw error;
        showMsg(authMsg, "Reset email sent. Check your inbox.", "ok");
      }catch(e){
        showMsg(authMsg, e?.message || String(e), "err");
      }
    }

    async function setPasswordAndProfile(fullName, pass1, pass2){
      const authMsg = $("authMsg");
      try{
        if (!pass1 || pass1.length < 8) throw new Error("Password must be at least 8 characters.");
        if (pass1 !== pass2) throw new Error("Passwords do not match.");

        showMsg(authMsg, "Saving…", "info");

        // Update password
        const { error: e1 } = await sb.auth.updateUser({ password: pass1 });
        if (e1) throw e1;

        // Update profile name (best effort)
        const { data: sessData } = await sb.auth.getSession();
        const uid = sessData?.session?.user?.id;
        const email = sessData?.session?.user?.email;

        if (uid){
          // Try update by user_id column
          await sb.from("profiles").upsert({
            user_id: uid,
            email: email || null,
            name: fullName || null,
            is_active: true
          }, { onConflict: "user_id" });
        }

        showMsg(authMsg, "Done. You can now use the dashboard.", "ok");
        await initAfterLogin();
      }catch(e){
        showMsg(authMsg, e?.message || String(e), "err");
      }
    }

    async function logout(){
      try{
        await sb.auth.signOut();
      }catch{}
      session = null;
      me = { user_id:null, role:"viewer", department:null, name:"", email:"" };
      showAuth("signin");
    }

    /********************
     * DASHBOARD LOAD
     ********************/
    function hydrateFromRpc(json){
      dash = json;

      // days
      const startDate = $("startDate").value;
      days = Array.from({ length: DAYS }, (_,i)=> addDays(startDate, i));

      // profiles
      profiles = Array.isArray(json.profiles) ? json.profiles : [];
      profileById = new Map(profiles.map(p => [String(p.user_id), p]));

      // service items
      serviceItems = Array.isArray(json.service_items) ? json.service_items : [];
      serviceById = new Map(serviceItems.map(si => [String(si.id), si]));

      itemsByGroup = { breakfast:[], lunch:[], dinner:[], massimo:[] };
      for (const si of serviceItems){
        if (!itemsByGroup[si.group_name]) continue;
        itemsByGroup[si.group_name].push(si);
      }
      // sort by sort_order if present else by name
      for (const g of Object.keys(itemsByGroup)){
        itemsByGroup[g].sort((a,b)=>{
          const ao = (a.sort_order ?? 9999), bo = (b.sort_order ?? 9999);
          if (ao !== bo) return ao - bo;
          return String(a.name).localeCompare(String(b.name));
        });
      }

      // forecast
      forecastByDate = new Map();
      for (const r of (json.daily_forecast || [])){
        forecastByDate.set(r.date, r);
      }

      // selections
      selByKey = new Map();
      for (const r of (json.daily_service_selection || [])){
        selByKey.set(`${r.date}|${r.group_name}`, r);
      }

      // massimo
      massimoByKey = new Map();
      for (const r of (json.daily_massimo_status || [])){
        massimoByKey.set(`${r.date}|${String(r.service_item_id)}`, r);
      }

      // outlets
      outletByKey = new Map();
      for (const r of (json.daily_outlet_hours || [])){
        outletByKey.set(`${r.date}|${r.outlet_name}`, r);
      }

      // me
      if (session?.user?.id){
        const p = profileById.get(String(session.user.id));
        me.user_id = String(session.user.id);
        me.email = session.user.email || "";
        me.name = p?.name || me.email || "";
        me.role = p?.role || "viewer";
        me.department = p?.department || null;
      }
    }

    async function loadDashboard(){
      const appMsg = $("appMsg");
      try{
        showMsg(appMsg, "Loading dashboard…", "info");
        const startDate = $("startDate").value;
        const { data, error } = await sb.rpc("get_dashboard", { p_start_date: startDate, p_days: DAYS });
        if (error) throw error;

        hydrateFromRpc(data);
        renderAll();
        showMsg(appMsg, "Loaded.", "ok");
      }catch(e){
        showMsg(appMsg, e?.message || String(e), "err");
      }
    }

    async function initAfterLogin(){
      await loadSession();
      if (!session){
        showAuth("signin");
        return;
      }
      // Ensure start date is set
      if (!$("startDate").value) $("startDate").value = toISODateToronto();
      await loadDashboard();
      showApp();
    }

    /********************
     * RENDER
     ********************/
    function renderAll(){
      // badges
      $("bRole").textContent = me.role || "viewer";
      $("bDept").textContent = me.department || "—";
      $("bName").textContent = me.name || me.email || "—";
      btnUsers.style.display = canViewUsers() ? "inline-flex" : "none";

      renderOcc();
      renderRestaurantTables();
      renderOutletTables();
      if (canViewUsers()) renderUsersAdmin();
    }

    function renderOcc(){
      const row = $("occRow");
      row.innerHTML = "";

      for (const d of days){
        const r = forecastByDate.get(d) || {};
        const pct = (r.occupancy_percent ?? r.occupancy ?? null);
        const notesShort = (r.notes ?? r.note ?? r.notes_short ?? "").trim?.() ?? "";
        const who = r.updated_by ? (profileById.get(String(r.updated_by))?.name || profileById.get(String(r.updated_by))?.email || "Unknown") : "—";
        const when = r.updated_at ? fmtTsToronto(r.updated_at) : "";

        const tile = document.createElement("div");
        tile.className = "occ-tile";
        tile.title = canEditForecast() ? "Tap to edit" : "View only";
        tile.addEventListener("click", ()=>{
          if (!canEditForecast()) return;
          openOccModal(d);
        });

        tile.innerHTML = `
          <div class="occ-top">
            <div>
              <div class="occ-day">${esc(fmtDay(d))}</div>
              <div class="occ-date">${esc(d)}</div>
            </div>
          </div>
          <div>
            <div class="occ-val">${pct==null ? "—" : esc(Number(pct).toFixed(1) + "%")}</div>
            <div class="occ-meta">
              ${notesShort ? ("Note: " + esc(notesShort) + "<br>") : ""}
              Last update: ${esc(who)}${when ? (" • " + esc(when)) : ""}
            </div>
          </div>
        `;
        row.appendChild(tile);
      }
    }

    function renderRestaurantTables(){
      // headers
      const head = $("restHeadRow");
      head.innerHTML = `<th class="col-service">Service</th>` + days.map(d => `
        <th>
          ${esc(fmtDay(d))}
          <div style="font-size:10px;color:#64748b;margin-top:2px;">${esc(d)}</div>
        </th>
      `).join("");

      const body = $("restBody");
      body.innerHTML = "";

      // Section helper
      const addSection = (title) => {
        const tr = document.createElement("tr");
        tr.className = "section-row";
        tr.innerHTML = `<td class="col-service" colspan="${1 + days.length}">${esc(title)}</td>`;
        body.appendChild(tr);
      };

      const addItemRowSinglePick = (groupName, item) => {
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td");
        nameTd.className = "col-service";
        nameTd.innerHTML = `<strong>${esc(item.name)}</strong>`;
        tr.appendChild(nameTd);

        for (const d of days){
          const td = document.createElement("td");
          td.className = "cell";
          const key = `${d}|${groupName}`;
          const sel = selByKey.get(key);
          const selectedId = sel?.service_item_id ? String(sel.service_item_id) : null;
          const isGreen = selectedId && selectedId === String(item.id);

          const who = sel?.updated_by ? (profileById.get(String(sel.updated_by))?.name || profileById.get(String(sel.updated_by))?.email || "Unknown") : "";
          const when = sel?.updated_at ? fmtTsToronto(sel.updated_at) : "";
          const meta = (who || when) ? `${who}${when ? (" • " + when) : ""}` : "";

          const box = document.createElement("div");
          box.className = "status-box " + (isGreen ? "green" : "red") + (canEditRestaurants() ? "" : " disabled");
          box.title = meta || (canEditRestaurants() ? "Click to select. Double-click green to clear." : "View only");
          if (meta){
            const mini = document.createElement("div");
            mini.className = "mini";
            mini.textContent = meta;
            box.appendChild(mini);
          }

          // click: select this item (UUID only)
          box.addEventListener("click", async (ev)=>{
            ev.preventDefault();
            if (!canEditRestaurants()) return;
            await setSelection(groupName, d, String(item.id));
          });

          // double click: if this is selected (green), clear (closed)
          box.addEventListener("dblclick", async (ev)=>{
            ev.preventDefault();
            if (!canEditRestaurants()) return;
            if (isGreen){
              await setSelection(groupName, d, null);
            }
          });

          td.appendChild(box);
          tr.appendChild(td);
        }

        body.appendChild(tr);
      };

      const addItemRowMassimoToggle = (item) => {
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td");
        nameTd.className = "col-service";
        nameTd.innerHTML = `<strong>${esc(item.name)}</strong>`;
        tr.appendChild(nameTd);

        for (const d of days){
          const td = document.createElement("td");
          td.className = "cell";
          const k = `${d}|${String(item.id)}`;
          const r = massimoByKey.get(k);
          const isOn = !!r?.is_active;

          const who = r?.updated_by ? (profileById.get(String(r.updated_by))?.name || profileById.get(String(r.updated_by))?.email || "Unknown") : (r?.updated_by_name || "");
          const when = r?.updated_at ? fmtTsToronto(r.updated_at) : "";
          const meta = (who || when) ? `${who}${when ? (" • " + when) : ""}` : "";

          const box = document.createElement("div");
          box.className = "status-box " + (isOn ? "green" : "red") + (canEditRestaurants() ? "" : " disabled");
          box.title = meta || (canEditRestaurants() ? "Click to toggle" : "View only");

          const mini = document.createElement("div");
          mini.className = "mini";
          mini.textContent = meta;
          box.appendChild(mini);

          box.addEventListener("click", async (ev)=>{
            ev.preventDefault();
            if (!canEditRestaurants()) return;
            await setMassimo(d, String(item.id), !isOn);
          });

          td.appendChild(box);
          tr.appendChild(td);
        }

        body.appendChild(tr);
      };

      // Build groups
      addSection("BREAKFAST");
      for (const item of itemsByGroup.breakfast) addItemRowSinglePick("breakfast", item);

      addSection("LUNCH");
      for (const item of itemsByGroup.lunch) addItemRowSinglePick("lunch", item);

      addSection("DINNER");
      for (const item of itemsByGroup.dinner) addItemRowSinglePick("dinner", item);

      addSection("MASSIMO");
      for (const item of itemsByGroup.massimo) addItemRowMassimoToggle(item);
    }

    function renderOutletTables(){
      // headers
      const head = $("outHeadRow");
      head.innerHTML = `<th class="col-service">Outlet</th>` + days.map(d => `
        <th>
          ${esc(fmtDay(d))}
          <div style="font-size:10px;color:#64748b;margin-top:2px;">${esc(d)}</div>
        </th>
      `).join("");

      const body = $("outBody");
      body.innerHTML = "";

      const addSection = (title) => {
        const tr = document.createElement("tr");
        tr.className = "section-row";
        tr.innerHTML = `<td class="col-service" colspan="${1 + days.length}">${esc(title)}</td>`;
        body.appendChild(tr);
      };

      const outletRow = (label, outletName, canEditFn) => {
        const tr = document.createElement("tr");
        const td0 = document.createElement("td");
        td0.className = "col-service";
        td0.innerHTML = `<strong>${esc(label)}</strong>`;
        tr.appendChild(td0);

        for (const d of days){
          const td = document.createElement("td");
          td.className = "cell";

          const r = outletByKey.get(`${d}|${outletName}`) || {};
          const isOpen = !!r.is_open;
          const ot = fmtTime12(r.open_time);
          const ct = fmtTime12(r.close_time);
          const mainText = isOpen ? (ot && ct ? `${ot}–${ct}` : "Open") : "Closed";

          const who = r.updated_by ? (profileById.get(String(r.updated_by))?.name || profileById.get(String(r.updated_by))?.email || "Unknown") : "";
          const when = r.updated_at ? fmtTsToronto(r.updated_at) : "";
          const meta = (who || when) ? `${who}${when ? (" • " + when) : ""}` : "";

          const box = document.createElement("div");
          box.className = "status-box outlet " + (isOpen ? "green" : "red") + (canEditFn() ? "" : " disabled");
          box.title = meta || (canEditFn() ? "Click to edit" : "View only");

          box.innerHTML = `
            <div class="otxt">${esc(isOpen ? "Open" : "Closed")}</div>
            <div class="otxt" style="font-size:11px;opacity:.95;">${esc(mainText)}</div>
            <div class="mini">${esc(meta || "")}</div>
          `;

          box.addEventListener("click", ()=>{
            if (!canEditFn()) return;
            openOutletModal(d, outletName, label);
          });

          td.appendChild(box);
          tr.appendChild(td);
        }

        body.appendChild(tr);
      };

      addSection("LOBBY BAR");
      outletRow("Lobby Bar", "LOBBY BAR", canEditLobbyBar);

      addSection("OUTLETS");
      outletRow("Starbucks", "STARBUCKS", canEditOutlets);
      outletRow("Sweet Jesus", "SWEET JESUS", canEditOutlets);
      outletRow("Freshii", "FRESHII", canEditOutlets);

      // Outlets week edit button
      $("btnEditOutletWeek").style.display = canEditOutlets() ? "inline-flex" : "none";
    }

    /********************
     * USERS ADMIN
     ********************/
    function renderUsersAdmin(){
      const sel = $("selUser");
      const tb = $("usersTableBody");
      sel.innerHTML = "";
      tb.innerHTML = "";

      // dropdown
      const sorted = [...profiles].sort((a,b)=> String(a.email||"").localeCompare(String(b.email||"")));
      for (const p of sorted){
        const opt = document.createElement("option");
        const label = `${p.name || p.email || "(no name)"} — ${p.email || ""}`;
        opt.value = String(p.user_id);
        opt.textContent = label;
        sel.appendChild(opt);
      }

      // table list
      for (const p of sorted){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-service">${esc(p.name || "")}</td>
          <td>${esc(p.email || "")}</td>
          <td>${esc(p.role || "")}</td>
          <td>${esc(p.department || "")}</td>
          <td>${esc(String(!!p.is_active))}</td>
        `;
        tb.appendChild(tr);
      }

      // select first + fill
      if (sorted.length){
        sel.value = String(sorted[0].user_id);
        fillUserEditor(sorted[0]);
      }
    }

    function fillUserEditor(p){
      $("uEmail").value = p.email || "";
      $("uName").value = p.name || "";
      $("uRole").value = p.role || "viewer";
      $("uDept").value = p.department || "";
      $("uActive").value = String(!!p.is_active);
    }

    async function saveUserChanges(){
      const usersMsg = $("usersMsg");
      try{
        const uid = $("selUser").value;
        if (!uid) throw new Error("Select a user first.");

        const payload = {
          user_id: uid,
          name: $("uName").value.trim() || null,
          role: $("uRole").value,
          department: $("uDept").value || null,
          is_active: $("uActive").value === "true"
        };

        showMsg(usersMsg, "Saving…", "info");
        const { error } = await sb.from("profiles").upsert(payload, { onConflict: "user_id" });
        if (error) throw error;

        showMsg(usersMsg, "Saved.", "ok");
        await loadDashboard(); // refresh lists
      }catch(e){
        showMsg(usersMsg, e?.message || String(e), "err");
      }
    }

    /********************
     * WRITE ACTIONS (UUID ONLY)
     ********************/
    async function setSelection(groupName, date, serviceItemIdOrNull){
      const appMsg = $("appMsg");
      try{
        showMsg(appMsg, "Saving…", "info");

        const payload = {
          date,
          group_name: groupName,
          service_item_id: serviceItemIdOrNull, // uuid or null
          updated_by: me.user_id,
          updated_at: new Date().toISOString()
        };

        const { error } = await sb.from("daily_service_selection")
          .upsert(payload, { onConflict: "date,group_name" });

        if (error) throw error;

        await loadDashboard();
      }catch(e){
        showMsg(appMsg, e?.message || String(e), "err");
      }
    }

    async function setMassimo(date, serviceItemId, isActive){
      const appMsg = $("appMsg");
      try{
        showMsg(appMsg, "Saving…", "info");

        const payload = {
          date,
          service_item_id: serviceItemId, // uuid
          is_active: !!isActive,
          updated_by: me.user_id,
          updated_at: new Date().toISOString()
        };

        const { error } = await sb.from("daily_massimo_status")
          .upsert(payload, { onConflict: "date,service_item_id" });

        if (error) throw error;

        await loadDashboard();
      }catch(e){
        showMsg(appMsg, e?.message || String(e), "err");
      }
    }

    async function saveForecast(date, pct, notes, notesLong){
      const appMsg = $("appMsg");
      const payloadBase = {
        date,
        occupancy_percent: pct,
        notes: notes || null,
        updated_by: me.user_id,
        updated_at: new Date().toISOString()
      };

      // Try with notes_long first; if column doesn't exist, retry without it
      try{
        showMsg(appMsg, "Saving…", "info");

        let payload = { ...payloadBase, notes_long: notesLong || null };
        let res = await sb.from("daily_forecast").upsert(payload, { onConflict: "date" });
        if (res.error){
          // Retry without notes_long
          payload = { ...payloadBase };
          res = await sb.from("daily_forecast").upsert(payload, { onConflict: "date" });
          if (res.error) throw res.error;
        }

        await loadDashboard();
      }catch(e){
        showMsg(appMsg, e?.message || String(e), "err");
      }
    }

    async function saveOutlet(date, outletName, isOpen, openTime, closeTime){
      const appMsg = $("appMsg");
      try{
        showMsg(appMsg, "Saving…", "info");

        const payload = {
          date,
          outlet_name: outletName,
          is_open: !!isOpen,
          open_time: isOpen ? (openTime || null) : null,
          close_time: isOpen ? (closeTime || null) : null,
          updated_by: me.user_id,
          updated_at: new Date().toISOString()
        };

        const { error } = await sb.from("daily_outlet_hours")
          .upsert(payload, { onConflict: "date,outlet_name" });

        if (error) throw error;

        await loadDashboard();
      }catch(e){
        showMsg(appMsg, e?.message || String(e), "err");
      }
    }

    /********************
     * MODALS
     ********************/
    function openOccModal(date){
      occEditDate = date;
      const r = forecastByDate.get(date) || {};

      const pct = (r.occupancy_percent ?? r.occupancy ?? "");
      const notes = (r.notes ?? r.note ?? r.notes_short ?? "");
      const notesLong = (r.notes_long ?? r.notesLong ?? r.long_notes ?? "");

      $("occTitle").textContent = `Edit occupancy — ${date}`;
      $("occPct").value = (pct === null || pct === undefined) ? "" : Number(pct);
      $("occNote").value = notes || "";
      $("occLong").value = notesLong || "";

      $("occOverlay").classList.add("show");
    }

    function closeOccModal(){
      $("occOverlay").classList.remove("show");
      occEditDate = null;
    }

    function openOutletModal(date, outletName, label){
      outEdit = { date, outlet: outletName, label };
      const r = outletByKey.get(`${date}|${outletName}`) || {};
      $("outTitle").textContent = `Edit ${label} — ${date}`;
      $("outOpen").value = String(!!r.is_open);
      $("outTimeOpen").value = r.open_time ? String(r.open_time).slice(0,5) : "";
      $("outTimeClose").value = r.close_time ? String(r.close_time).slice(0,5) : "";
      $("outOverlay").classList.add("show");
    }

    function closeOutletModal(){
      $("outOverlay").classList.remove("show");
      outEdit = { date:null, outlet:null, label:null };
    }

    function openOutletWeekModal(){
      // only for Outlets dept/admin
      const tbody = $("outWeekBody");
      tbody.innerHTML = "";
      outWeekDraft = [];

      for (const d of days){
        const mkCell = (outletName) => {
          const r = outletByKey.get(`${d}|${outletName}`) || {};
          const isOpen = !!r.is_open;
          const ot = r.open_time ? String(r.open_time).slice(0,5) : "";
          const ct = r.close_time ? String(r.close_time).slice(0,5) : "";
          return { date:d, outlet: outletName, isOpen, ot, ct };
        };

        const star = mkCell("STARBUCKS");
        const sj = mkCell("SWEET JESUS");
        const fr = mkCell("FRESHII");

        outWeekDraft.push(star, sj, fr);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-service"><strong>${esc(fmtDay(d))}</strong><div style="font-size:11px;color:#64748b;margin-top:2px;">${esc(d)}</div></td>
          ${weekEditorCellHtml(star)}
          ${weekEditorCellHtml(sj)}
          ${weekEditorCellHtml(fr)}
        `;
        tbody.appendChild(tr);
      }

      $("outWeekOverlay").classList.add("show");
    }

    function weekEditorCellHtml(obj){
      const key = `${obj.date}|${obj.outlet}`;
      const s = `
        <td>
          <div style="display:grid; gap:8px;">
            <div class="field" style="padding:8px 10px; border-radius:12px;">
              <label>Status</label>
              <select data-week="status" data-key="${esc(key)}">
                <option value="false" ${obj.isOpen? "":"selected"}>Closed</option>
                <option value="true" ${obj.isOpen? "selected":""}>Open</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
              <div class="field" style="padding:8px 10px; border-radius:12px;">
                <label>Open</label>
                <input data-week="open" data-key="${esc(key)}" type="time" value="${esc(obj.ot)}" />
              </div>
              <div class="field" style="padding:8px 10px; border-radius:12px;">
                <label>Close</label>
                <input data-week="close" data-key="${esc(key)}" type="time" value="${esc(obj.ct)}" />
              </div>
            </div>
          </div>
        </td>
      `;
      return s;
    }

    function closeOutletWeekModal(){
      $("outWeekOverlay").classList.remove("show");
      outWeekDraft = [];
    }

    async function saveOutletWeek(){
      const appMsg = $("appMsg");
      try{
        // read values from DOM
        const statusEls = document.querySelectorAll("[data-week='status']");
        const openEls = document.querySelectorAll("[data-week='open']");
        const closeEls = document.querySelectorAll("[data-week='close']");

        const statusMap = new Map();
        statusEls.forEach(el => statusMap.set(el.getAttribute("data-key"), el.value === "true"));
        const openMap = new Map();
        openEls.forEach(el => openMap.set(el.getAttribute("data-key"), el.value || ""));
        const closeMap = new Map();
        closeEls.forEach(el => closeMap.set(el.getAttribute("data-key"), el.value || ""));

        // Build payloads for outlets only
        const payloads = [];
        for (const d of days){
          for (const outletName of ["STARBUCKS","SWEET JESUS","FRESHII"]){
            const key = `${d}|${outletName}`;
            const isOpen = statusMap.get(key) || false;
            const ot = openMap.get(key) || "";
            const ct = closeMap.get(key) || "";

            // If user set open, require times
            if (isOpen && (!ot || !ct)){
              throw new Error(`Hours required when Open: ${outletName} on ${d}`);
            }

            // Only save rows the user touched OR any explicit open/closed choice.
            // We’ll always upsert so it’s consistent.
            payloads.push({
              date: d,
              outlet_name: outletName,
              is_open: isOpen,
              open_time: isOpen ? ot : null,
              close_time: isOpen ? ct : null,
              updated_by: me.user_id,
              updated_at: new Date().toISOString()
            });
          }
        }

        showMsg(appMsg, "Saving week…", "info");
        const { error } = await sb.from("daily_outlet_hours").upsert(payloads, { onConflict:"date,outlet_name" });
        if (error) throw error;

        closeOutletWeekModal();
        await loadDashboard();
      }catch(e){
        showMsg(appMsg, e?.message || String(e), "err");
      }
    }

    /********************
     * PDF SNAPSHOT (simple, no libs)
     ********************/
    function pdfEscape(s){
      return String(s ?? "")
        .replace(/\\/g, "\\\\")
        .replace(/\(/g, "\\(")
        .replace(/\)/g, "\\)")
        .replace(/[^\x09\x0A\x0D\x20-\x7E]/g, "?");
    }

    function buildSimplePdfFromLines(lines){
      const pageW = 612, pageH = 792;
      const marginL = 48, marginT = 56;
      const lineH = 14;
      const maxLinesPerPage = Math.floor((pageH - marginT - 48) / lineH);

      const pages = [];
      for (let i=0; i<lines.length; i+=maxLinesPerPage) pages.push(lines.slice(i, i+maxLinesPerPage));

      const objs = [];
      const add = (s)=>{ objs.push(s); return objs.length; };

      add(`<< /Type /Catalog /Pages 2 0 R >>`);
      add(`<< >>`); // pages placeholder
      const fontId = add(`<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>`);

      const contentIds = [];
      const pageIds = [];

      for (let p=0; p<pages.length; p++){
        const pageLines = pages[p];

        const content = [];
        content.push("BT");
        content.push(`/F1 11 Tf`);
        content.push(`${marginL} ${pageH - marginT} Td`);
        for (let i=0; i<pageLines.length; i++){
          const t = pdfEscape(pageLines[i]);
          if (i===0) content.push(`(${t}) Tj`);
          else content.push(`0 -${lineH} Td (${t}) Tj`);
        }
        content.push("ET");
        const cs = content.join("\n");
        const cid = add(`<< /Length ${cs.length} >>\nstream\n${cs}\nendstream`);
        contentIds.push(cid);

        const pid = add(
          `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW} ${pageH}] ` +
          `/Resources << /Font << /F1 ${fontId} 0 R >> >> ` +
          `/Contents ${cid} 0 R >>`
        );
        pageIds.push(pid);
      }

      objs[1] = `<< /Type /Pages /Kids [${pageIds.map(id=>`${id} 0 R`).join(" ")}] /Count ${pageIds.length} >>`;

      let pdf = `%PDF-1.4\n`;
      const xref = [];
      xref.push("0000000000 65535 f \n");

      for (let i=0; i<objs.length; i++){
        const offset = pdf.length;
        xref.push(String(offset).padStart(10,"0") + " 00000 n \n");
        pdf += `${i+1} 0 obj\n${objs[i]}\nendobj\n`;
      }

      const xrefOffset = pdf.length;
      pdf += `xref\n0 ${objs.length+1}\n` + xref.join("") +
             `trailer\n<< /Size ${objs.length+1} /Root 1 0 R >>\nstartxref\n${xrefOffset}\n%%EOF`;

      return new Uint8Array(Array.from(pdf).map(ch => ch.charCodeAt(0)));
    }

    function serviceSelectedName(date, group){
      const r = selByKey.get(`${date}|${group}`);
      const id = r?.service_item_id ? String(r.service_item_id) : null;
      if (!id) return null;
      return serviceById.get(id)?.name || null;
    }

    function massimoActiveNames(date){
      const out = [];
      for (const item of itemsByGroup.massimo){
        const r = massimoByKey.get(`${date}|${String(item.id)}`);
        if (r?.is_active) out.push(item.name.replace("MASSIMO ",""));
      }
      return out;
    }

    function outletSummary(date, outletName){
      const r = outletByKey.get(`${date}|${outletName}`);
      if (!r) return "Closed";
      if (!r.is_open) return "Closed";
      const ot = fmtTime12(r.open_time);
      const ct = fmtTime12(r.close_time);
      return (ot && ct) ? `Open ${ot}–${ct}` : "Open";
    }

    function downloadPdf(){
      const start = $("startDate").value;
      const now = fmtTsToronto(new Date().toISOString());

      const lines = [];
      lines.push("Sheraton Niagara Falls – 7-Day Snapshot");
      lines.push(`Start date: ${start}`);
      lines.push(`Generated: ${now} (Toronto time)`);
      lines.push("");

      for (const d of days){
        const bf = serviceSelectedName(d,"breakfast") || "Breakfast closed";
        const lu = serviceSelectedName(d,"lunch") || "Lunch closed";
        const di = serviceSelectedName(d,"dinner") || "Dinner closed";
        const ma = massimoActiveNames(d);
        const maLine = ma.length ? ("Massimo: " + ma.join(", ")) : "Massimo closed";

        lines.push(`${fmtDay(d)}  [${d}]`);
        lines.push(`  Breakfast: ${bf}`);
        lines.push(`  Lunch: ${lu}`);
        lines.push(`  Dinner: ${di}`);
        lines.push(`  ${maLine}`);
        lines.push(`  Lobby Bar: ${outletSummary(d,"LOBBY BAR")}`);
        lines.push(`  Starbucks: ${outletSummary(d,"STARBUCKS")}`);
        lines.push(`  Sweet Jesus: ${outletSummary(d,"SWEET JESUS")}`);
        lines.push(`  Freshii: ${outletSummary(d,"FRESHII")}`);
        lines.push("");
      }

      const bytes = buildSimplePdfFromLines(lines);
      const blob = new Blob([bytes], { type:"application/pdf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `Sheraton_7Day_Snapshot_${start}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }

    /********************
     * EVENTS
     ********************/
    $("btnSignin").addEventListener("click", ()=>{
      const email = $("inEmail").value.trim();
      const pass = $("inPass").value;
      signIn(email, pass);
    });

    $("btnForgot").addEventListener("click", ()=>{
      $("resetEmail").value = $("inEmail").value.trim();
      showAuth("reset");
    });

    $("btnBackSignin").addEventListener("click", ()=> showAuth("signin"));
    $("btnSendReset").addEventListener("click", ()=>{
      const email = $("resetEmail").value.trim();
      sendReset(email);
    });

    $("btnSetCancel").addEventListener("click", ()=> showAuth("signin"));
    $("btnSetSave").addEventListener("click", ()=>{
      setPasswordAndProfile(
        $("setName").value.trim(),
        $("setPass1").value,
        $("setPass2").value
      );
    });

    $("btnLogout").addEventListener("click", logout);
    $("btnDash").addEventListener("click", showDashboard);
    $("btnUsers").addEventListener("click", ()=>{
      if (!canViewUsers()) return;
      showUsers();
      renderUsersAdmin();
    });

    $("btnRefresh").addEventListener("click", loadDashboard);
    $("btnToday").addEventListener("click", ()=>{
      $("startDate").value = toISODateToronto();
      loadDashboard();
    });
    $("btnPdf").addEventListener("click", downloadPdf);

    // Occ modal
    $("occClose").addEventListener("click", closeOccModal);
    $("occOverlay").addEventListener("click", (e)=>{ if (e.target.id==="occOverlay") closeOccModal(); });
    $("occSave").addEventListener("click", ()=>{
      if (!occEditDate) return;
      const pctRaw = $("occPct").value;
      const pct = pctRaw === "" ? null : Number(pctRaw);
      if (pct !== null && (isNaN(pct) || pct < 0 || pct > 100)){
        showMsg($("appMsg"), "Occupancy must be between 0 and 100.", "err");
        return;
      }
      closeOccModal();
      saveForecast(occEditDate, pct, $("occNote").value.trim(), $("occLong").value.trim());
    });

    // Outlet day modal
    $("outClose").addEventListener("click", closeOutletModal);
    $("outOverlay").addEventListener("click", (e)=>{ if (e.target.id==="outOverlay") closeOutletModal(); });
    $("outSave").addEventListener("click", ()=>{
      if (!outEdit?.date || !outEdit?.outlet) return;

      const isOpen = $("outOpen").value === "true";
      const ot = $("outTimeOpen").value || "";
      const ct = $("outTimeClose").value || "";

      if (isOpen && (!ot || !ct)){
        showMsg($("appMsg"), "If Open is selected, you must enter open and close times.", "err");
        return;
      }

      closeOutletModal();
      saveOutlet(outEdit.date, outEdit.outlet, isOpen, ot, ct);
    });

    // Outlet week modal
    $("btnEditOutletWeek").addEventListener("click", ()=>{
      if (!canEditOutlets()) return;
      openOutletWeekModal();
    });
    $("outWeekClose").addEventListener("click", closeOutletWeekModal);
    $("outWeekOverlay").addEventListener("click", (e)=>{ if (e.target.id==="outWeekOverlay") closeOutletWeekModal(); });
    $("outWeekSave").addEventListener("click", saveOutletWeek);

    // Users admin
    $("selUser").addEventListener("change", ()=>{
      const uid = $("selUser").value;
      const p = profiles.find(x => String(x.user_id) === String(uid));
      if (p) fillUserEditor(p);
    });
    $("btnSaveUser").addEventListener("click", saveUserChanges);
    $("btnReloadUsers").addEventListener("click", async ()=>{
      showMsg($("usersMsg"), "Reloading…", "info");
      await loadDashboard();
      showMsg($("usersMsg"), "Reloaded.", "ok");
      renderUsersAdmin();
    });

    /********************
     * BOOT
     ********************/
    (async function boot(){
      if (!sb) return;

      // If link-based auth flow, handle it first
      const usedLink = await handleAuthLinksIfAny();

      await loadSession();
      if (!session){
        // start date default
        $("startDate").value = toISODateToronto();
        showAuth("signin");
        return;
      }

      // If this was an invite/reset link, show set password prompt once
      if (usedLink){
        showAuth("setpass");
        return;
      }

      $("startDate").value = $("startDate").value || toISODateToronto();
      await initAfterLogin();
    })();
  </script>
</body>
</html>
