<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheraton Dashboard</title>

  <script defer src="vendor/supabase-js.iife.min.js"></script>
  <script defer src="supabase.js"></script>
  <script defer src="app.js"></script>

  <style>
    :root{
      --bg1:#f6f9ff; --bg2:#ffffff; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --btn:#2563eb; --btn2:#0f172a; --bad:#b91c1c; --good:#15803d;
      --shadow:0 10px 30px rgba(2,6,23,.10); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #dbeafe 0%, transparent 55%),
                  radial-gradient(1000px 700px at 100% 20%, #e9d5ff 0%, transparent 50%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:100%; max-width:860px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .dot{width:12px; height:12px; border-radius:999px; background:var(--btn); box-shadow:0 0 0 6px rgba(37,99,235,.15);}
    .pill{font-size:12px; color:var(--muted); border:1px solid var(--line); background:rgba(255,255,255,.65); padding:6px 10px; border-radius:999px;}
    .card{background:var(--card); border:1px solid rgba(226,232,240,.8); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;}
    .head{padding:18px; border-bottom:1px solid var(--line); background:linear-gradient(180deg, rgba(37,99,235,.10), transparent);}
    .head h1{margin:0; font-size:22px;}
    .head p{margin:8px 0 0 0; color:var(--muted); font-size:14px; line-height:1.35;}
    .body{padding:18px; display:grid; grid-template-columns:1fr 1fr; gap:16px;}
    @media (max-width:860px){.body{grid-template-columns:1fr;}}
    .panel{border:1px solid var(--line); border-radius:14px; padding:14px; background:rgba(255,255,255,.7);}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input{width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--line); font-size:14px; outline:none; background:#fff;}
    input:focus{border-color: rgba(37,99,235,.65); box-shadow:0 0 0 4px rgba(37,99,235,.12);}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{border:0; border-radius:12px; padding:11px 14px; font-weight:900; cursor:pointer; font-size:14px;}
    .btn{background:var(--btn); color:#fff;}
    .btn2{background:var(--btn2); color:#fff;}
    .ghost{background:transparent; border:1px solid var(--line); color:var(--text); font-weight:900;}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; font-size:13px; display:none; line-height:1.35;}
    .msg.bad{border-color: rgba(185,28,28,.35); background: rgba(185,28,28,.06); color: var(--bad);}
    .msg.good{border-color: rgba(21,128,61,.35); background: rgba(21,128,61,.06); color: var(--good);}
    a{color:var(--btn); text-decoration:none; font-weight:900;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> Sheraton Dashboard</div>
      <div class="pill" id="statusPill">Loading…</div>
    </div>

    <div class="card">
      <div class="head">
        <h1>Home</h1>
        <p>If you log in through an invite, you will be forced into onboarding until it’s complete.</p>
      </div>

      <div class="body">
        <div class="panel" id="loginPanel">
          <h3 style="margin:0 0 6px 0;">Login</h3>
          <div style="color:var(--muted); font-size:12px;">Use email + password.</div>

          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="name@hotel.com" />

          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="Your password" />

          <div class="actions">
            <button class="btn" id="btnLogin">Sign In</button>
          </div>

          <div id="msgLogin" class="msg"></div>
        </div>

        <div class="panel" id="navPanel" style="display:none;">
          <h3 style="margin:0 0 6px 0;">Navigation</h3>
          <div style="color:var(--muted); font-size:12px;">You’ll only see this after onboarding is complete.</div>

          <div class="actions">
            <a class="ghost" style="padding:11px 14px; border-radius:12px; display:inline-block;" href="fnb-outlets.html">F&amp;B Outlets</a>
            <a class="ghost" style="padding:11px 14px; border-radius:12px; display:inline-block;" href="onboarding.html">My Profile</a>
            <button class="btn2" id="btnLogout">Sign Out</button>
          </div>

          <div id="msgNav" class="msg"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function showMsg(id, text, kind) {
      const el = $(id);
      el.className = "msg" + (kind ? (" " + kind) : "");
      el.textContent = text;
      el.style.display = "block";
    }
    function clearMsg(id) {
      const el = $(id);
      el.style.display = "none";
      el.textContent = "";
      el.className = "msg";
    }

    async function refreshUI() {
      const sb = window.App.getSB();
      const user = await window.App.getUser();

      if (!user) {
        $("statusPill").textContent = "Signed out";
        $("loginPanel").style.display = "block";
        $("navPanel").style.display = "none";
        return;
      }

      $("statusPill").textContent = user.email ? `Signed in: ${user.email}` : "Signed in";

      const prof = await window.App.getProfile(user.id);
      const onboarded = !!(prof && prof.onboarding_completed);

      if (onboarded) {
        $("loginPanel").style.display = "none";
        $("navPanel").style.display = "block";
      } else {
        // guard will redirect anyway, but keep UI sane
        $("loginPanel").style.display = "none";
        $("navPanel").style.display = "none";
      }
    }

    (async function init() {
      // If user arrived with a ?next=... from guard, keep it around.
      await refreshUI();

      $("btnLogin").addEventListener("click", async () => {
        clearMsg("msgLogin");
        const email = ($("email").value || "").trim();
        const password = ($("password").value || "").trim();

        if (!email || !password) {
          showMsg("msgLogin", "Enter email and password.", "bad");
          return;
        }

        const sb = window.App.getSB();
        const { error } = await sb.auth.signInWithPassword({ email, password });

        if (error) {
          showMsg("msgLogin", error.message || "Login failed.", "bad");
          return;
        }

        // IMPORTANT: force onboarding gate immediately
        await window.App.guardOnboarding().catch(() => {});
        await refreshUI();
      });

      $("btnLogout").addEventListener("click", async () => {
        const sb = window.App.getSB();
        await sb.auth.signOut();
        await refreshUI();
      });
    })();
  </script>
</body>
</html>
