<!-- =========================
FILE: index.html
Email + Password login
Forgot Password (emails reset link)
Reset link returns to index.html and shows "Set New Password"
NO invite/set-password flow
========================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sheraton Tools - Login</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow: 0 14px 40px rgba(15,23,42,.10);
      --radius:18px;
      --blue:#2563eb;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 10% 0%, #e9efff 0%, rgba(233,239,255,0) 60%),
        radial-gradient(900px 600px at 90% 10%, #e9fff6 0%, rgba(233,255,246,0) 55%),
        var(--bg);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 920px){
      .wrap{ grid-template-columns:1fr; }
    }
    .hero, .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.9);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero{
      padding:22px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:14px;
    }
    .logo{
      width:48px;height:48px;border-radius:16px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      box-shadow: var(--shadow);
    }
    h1{ margin:0; font-size:20px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      font-size:12px; padding:6px 10px; border:1px solid var(--line);
      border-radius:999px; color:var(--muted); background:#fff;
    }
    .card{
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .title{ font-weight:750; font-size:14px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:11px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus{ border-color: rgba(37,99,235,.55); }
    button{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:11px 12px;
      font-size:14px;
      cursor:pointer;
      background:#fff;
      transition: transform .04s ease, background .15s ease;
    }
    button:hover{ background:#f8fafc; }
    button:active{ transform: translateY(1px); }
    .primary{
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border-color: transparent;
      color:#fff;
      font-weight:650;
    }
    .primary:hover{ background: linear-gradient(135deg, #1d4ed8, #1e40af); }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .link{
      background:none;
      border:none;
      padding:0;
      cursor:pointer;
      color:var(--blue);
      font-size:13px;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .error{
      display:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#9f1239;
      font-size:13px;
      white-space:pre-wrap;
    }
    .ok{
      display:none;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #bbf7d0;
      background:#f0fdf4;
      color:#166534;
      font-size:13px;
      white-space:pre-wrap;
    }
    .hide{ display:none !important; }
    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="hero">
      <div>
        <div class="logo" aria-hidden="true"></div>
        <h1 style="margin-top:12px;">Sheraton Tools</h1>
        <div class="sub">
          Sign in with your email + password.
          <br/>Forgot password is available on this screen.
        </div>

        <div class="chips">
          <span class="chip">F&B Outlets</span>
          <span class="chip">Dashboards</span>
          <span class="chip">Internal use</span>
        </div>
      </div>

      <div class="muted">
        Tip: If you get “Supabase client not found”, it’s almost always a missing file or wrong path/case on GitHub Pages.
      </div>
    </section>

    <section class="card">
      <div class="title" id="modeTitle">Sign in</div>

      <div class="error" id="errorBox"></div>
      <div class="ok" id="okBox"></div>

      <!-- LOGIN FORM -->
      <div id="loginForm">
        <div>
          <label for="email">Email</label>
          <input id="email" type="email" autocomplete="username" placeholder="name@company.com">
        </div>

        <div>
          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" placeholder="••••••••">
        </div>

        <button class="primary" id="btnLogin">Sign in</button>

        <div class="row">
          <button class="link" id="btnForgot" type="button">Forgot password?</button>
          <span class="muted" id="sessionHint"></span>
        </div>
      </div>

      <!-- FORGOT PASSWORD -->
      <div id="forgotForm" class="hide">
        <div class="mini">
          Enter your email and we’ll send a reset link.
        </div>
        <div>
          <label for="fpEmail">Email</label>
          <input id="fpEmail" type="email" autocomplete="username" placeholder="name@company.com">
        </div>
        <button class="primary" id="btnSendReset">Send reset email</button>
        <button id="btnBackToLogin" type="button">Back</button>
      </div>

      <!-- RESET PASSWORD (from email link) -->
      <div id="resetForm" class="hide">
        <div class="mini">
          Set a new password for your account.
        </div>
        <div>
          <label for="newPass">New password</label>
          <input id="newPass" type="password" autocomplete="new-password" placeholder="New password">
        </div>
        <div>
          <label for="newPass2">Confirm new password</label>
          <input id="newPass2" type="password" autocomplete="new-password" placeholder="Confirm new password">
        </div>
        <button class="primary" id="btnSetNewPass">Set new password</button>
        <button id="btnCancelReset" type="button">Cancel</button>
      </div>
    </section>
  </div>

  <!-- Scripts: ALWAYS use ./ paths on GitHub Pages -->
  <script src="./vendor/supabase-js.iife.min.js"></script>
  <!-- supabase.js is provided above as its own file -->
  <script src="./supabase.js"></script>

  <script>
  (() => {
    const $ = (id) => document.getElementById(id);

    function showErr(msg){
      const b = $("errorBox");
      b.textContent = msg;
      b.style.display = "block";
      $("okBox").style.display = "none";
    }
    function showOk(msg){
      const b = $("okBox");
      b.textContent = msg;
      b.style.display = "block";
      $("errorBox").style.display = "none";
    }
    function clearMsgs(){
      $("errorBox").style.display = "none";
      $("okBox").style.display = "none";
    }

    function setMode(mode){
      // mode: login | forgot | reset
      $("loginForm").classList.toggle("hide", mode !== "login");
      $("forgotForm").classList.toggle("hide", mode !== "forgot");
      $("resetForm").classList.toggle("hide", mode !== "reset");
      $("modeTitle").textContent =
        mode === "login" ? "Sign in" :
        mode === "forgot" ? "Forgot password" :
        "Set new password";
      clearMsgs();
    }

    async function safeSB(){
      if(!window.sb){
        showErr("Supabase client not found. Make sure ./vendor/supabase-js.iife.min.js and ./supabase.js load correctly.");
        throw new Error("Supabase client not found");
      }
      return window.sb;
    }

    async function checkSession(){
      const sb = await safeSB();
      const { data, error } = await sb.auth.getSession();
      if(error) throw error;
      return data.session || null;
    }

    function getUrlType(){
      // Supabase recovery links usually provide tokens and "type=recovery" (or similar)
      const url = new URL(window.location.href);
      const type = url.searchParams.get("type") || "";
      // Also support hash style
      const hash = new URLSearchParams((url.hash || "").replace(/^#/, ""));
      const hType = hash.get("type") || "";
      return (type || hType || "").toLowerCase();
    }

    function cleanUrl(){
      // keep it clean after handling reset
      const url = new URL(window.location.href);
      url.search = "";
      url.hash = "";
      window.history.replaceState({}, document.title, url.toString());
    }

    async function goHome(){
      // Change this if your “home” is something else
      window.location.href = "index.html";
    }

    async function goAfterLogin(){
      // ✅ This is where you can send users after login.
      // If your index is the menu/home, keep it as index.html.
      // If you want to go straight to fnb-outlets, change it to "fnb-outlets.html".
      window.location.href = "fnb-outlets.html";
    }

    async function init(){
      try{
        const sb = await safeSB();

        // If already signed in, go to app page
        const session = await checkSession();
        if(session){
          $("sessionHint").textContent = "Signed in";
          await goAfterLogin();
          return;
        }

        // If coming from password reset email link
        const t = getUrlType();
        if(t === "recovery"){
          setMode("reset");
          showOk("Reset link detected. Set your new password.");
          return;
        }

        setMode("login");
      }catch(e){
        console.error(e);
      }
    }

    // --- Login ---
    $("btnLogin").addEventListener("click", async () => {
      try{
        clearMsgs();
        const sb = await safeSB();

        const email = $("email").value.trim();
        const password = $("password").value;

        if(!email || !password){
          showErr("Enter email and password.");
          return;
        }

        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;

        await goAfterLogin();
      }catch(e){
        showErr(e.message || String(e));
      }
    });

    // --- Forgot password ---
    $("btnForgot").addEventListener("click", () => {
      $("fpEmail").value = $("email").value.trim();
      setMode("forgot");
    });

    $("btnBackToLogin").addEventListener("click", () => setMode("login"));

    $("btnSendReset").addEventListener("click", async () => {
      try{
        clearMsgs();
        const sb = await safeSB();

        const email = $("fpEmail").value.trim();
        if(!email){
          showErr("Enter your email.");
          return;
        }

        // Must match a Redirect URL in Supabase Auth settings.
        // Use your actual GitHub Pages URL here (you can add multiple allowed redirects).
        const redirectTo = window.location.origin + window.location.pathname.replace(/\/[^/]*$/, "/index.html");

        const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
        if(error) throw error;

        showOk("Reset email sent. Check your inbox.");
      }catch(e){
        showErr(e.message || String(e));
      }
    });

    // --- Set new password (from recovery link) ---
    $("btnSetNewPass").addEventListener("click", async () => {
      try{
        clearMsgs();
        const sb = await safeSB();

        const p1 = $("newPass").value;
        const p2 = $("newPass2").value;

        if(!p1 || p1.length < 6){
          showErr("Password must be at least 6 characters.");
          return;
        }
        if(p1 !== p2){
          showErr("Passwords do not match.");
          return;
        }

        const { error } = await sb.auth.updateUser({ password: p1 });
        if(error) throw error;

        showOk("Password updated. Redirecting…");
        cleanUrl();
        // After reset, send them to login (or straight to app if you want)
        setTimeout(() => window.location.href = "index.html", 800);
      }catch(e){
        showErr(e.message || String(e));
      }
    });

    $("btnCancelReset").addEventListener("click", () => {
      cleanUrl();
      setMode("login");
    });

    init();
  })();
  </script>
</body>
</html>
