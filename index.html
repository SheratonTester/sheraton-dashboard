<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sheraton Niagara Falls – Dashboard</title>

  <!-- IMPORTANT: keep this file in your repo root -->
  <script src="./supabase.js"></script>

  <style>
    :root{
      --bg: #0b1220;
      --panel: #101a2d;
      --panel2:#0f1a30;
      --text: #e6edf7;
      --muted:#a6b3cc;
      --line: rgba(255,255,255,.10);
      --blue:#4ea1ff;
      --red:#991b1b;   /* dark red */
      --green:#166534; /* dark green */
      --cell:#0b152a;
      --cell2:#0d1933;
      --warn:#fbbf24;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 10%, #1a2a53 0%, var(--bg) 55%, #060b16 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    a{ color: var(--blue); text-decoration:none; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 16px; border:1px solid var(--line);
      background: rgba(16,26,45,.78); backdrop-filter: blur(10px);
      border-radius:16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:3px;
    }
    .brand h1{ margin:0; font-size:18px; font-weight:750; letter-spacing:.2px; }
    .brand .sub{ font-size:12px; color:var(--muted); }
    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(8,14,28,.6);
      font-size:12px; color:var(--muted);
    }
    .btn{
      cursor:pointer; user-select:none;
      border:1px solid var(--line);
      background: rgba(78,161,255,.14);
      color: var(--text);
      padding:9px 12px;
      border-radius:12px;
      font-weight:650;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn.secondary{ background: rgba(255,255,255,.08); }
    .btn.danger{ background: rgba(153,27,27,.25); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:14px 0 0;
    }
    .tab{
      cursor:pointer;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(16,26,45,.60);
      color: var(--muted);
      font-weight:650;
      font-size:13px;
    }
    .tab.active{
      background: rgba(78,161,255,.18);
      color: var(--text);
      border-color: rgba(78,161,255,.45);
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);
      background: rgba(16,26,45,.72);
      border-radius:16px;
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      background: rgba(6,10,22,.25);
    }
    .cardHead h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .cardHead .help{ color:var(--muted); font-size:12px; }
    .cardBody{ padding:12px 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 200px;
    }
    label{ font-size:12px; color:var(--muted); }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(8,14,28,.55);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
    }
    .msg.err{ border-color: rgba(153,27,27,.5); background: rgba(153,27,27,.18); color:#ffd2d2; }
    .msg.ok{ border-color: rgba(22,101,52,.55); background: rgba(22,101,52,.22); color:#d7ffe7; }

    .gridWrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(8,14,28,.35);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 920px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding:8px;
      vertical-align:top;
      font-size:12px;
    }
    th{
      position:sticky; top:0;
      background: rgba(8,14,28,.92);
      z-index: 2;
      color: var(--text);
      text-align:left;
      font-weight:800;
    }
    tr:last-child td{ border-bottom:none; }
    td.label{
      width:260px;
      color: var(--muted);
      font-weight:700;
      background: rgba(8,14,28,.60);
      position:sticky; left:0;
      z-index:1;
      border-right:1px solid var(--line);
    }
    .dayHdr{
      display:flex; flex-direction:column; gap:2px;
    }
    .dayHdr .d1{ font-weight:850; }
    .dayHdr .d2{ color:var(--muted); font-size:11px; }

    .cellBtn{
      width:100%;
      min-height:34px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(11,21,42,.85);
      color: var(--text);
      cursor:pointer;
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
      justify-content:center;
    }
    .cellBtn:hover{ filter:brightness(1.06); }
    .cellBtn:disabled{ opacity:.45; cursor:not-allowed; }
    .dot{
      width:100%;
      height:26px;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(153,27,27,.85); /* default red */
    }
    .dot.green{ background: rgba(22,101,52,.88); }
    .meta{
      font-size:10px;
      color: rgba(255,255,255,.78);
      line-height:1.2;
    }
    .meta span{ color: rgba(255,255,255,.92); font-weight:750; }
    .smallMuted{ color: var(--muted); font-size:11px; }

    .sectionTitleRow td{
      background: rgba(78,161,255,.10);
      font-weight:900;
      color: var(--text);
      border-top:1px solid var(--line);
    }

    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width: min(780px, 100%);
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(16,26,45,.96);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      gap:10px;
    }
    .modalHead h3{ margin:0; font-size:14px; }
    .modalBody{ padding:12px 14px; }
    .modalFoot{
      padding:12px 14px;
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      border-top:1px solid var(--line);
      background: rgba(6,10,22,.25);
    }

    .hint{
      font-size:12px; color: var(--muted);
    }

    @media (max-width: 700px){
      .wrap{ padding:12px; }
      td.label{ width:210px; }
      table{ min-width: 860px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Sheraton Niagara Falls – Dashboard</h1>
        <div class="sub">Toronto time • 7-day view • Roles by department</div>
      </div>
      <div class="right">
        <div class="pill" id="whoPill">Not signed in</div>
        <button class="btn secondary" id="btnLogout" style="display:none;">Logout</button>
      </div>
    </div>

    <div class="tabs" id="tabs" style="display:none;">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="users" id="tabUsers" style="display:none;">Users</div>
      <div class="tab" data-tab="account">Account</div>
    </div>

    <!-- AUTH -->
    <div class="card" id="authCard">
      <div class="cardHead">
        <h2>Sign in</h2>
        <div class="help">Use your hotel email + password.</div>
      </div>
      <div class="cardBody">
        <div class="row">
          <div class="field" style="min-width:260px;">
            <label>Email</label>
            <input id="loginEmail" type="email" placeholder="name@niagarafallshotels.com" />
          </div>
          <div class="field" style="min-width:260px;">
            <label>Password</label>
            <input id="loginPass" type="password" placeholder="Password" />
          </div>
          <div class="field" style="min-width:180px; align-self:flex-end;">
            <button class="btn" id="btnLogin">Login</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field" style="min-width:260px;">
            <label>Password reset (sends email)</label>
            <input id="resetEmail" type="email" placeholder="name@niagarafallshotels.com" />
          </div>
          <div class="field" style="min-width:180px; align-self:flex-end;">
            <button class="btn secondary" id="btnReset">Send reset link</button>
          </div>
        </div>

        <div class="msg" id="authMsg" style="display:none;"></div>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="appView" style="display:none;">
      <!-- DASHBOARD -->
      <div class="card" id="dashCard">
        <div class="cardHead">
          <div>
            <h2>7-Day Operations View</h2>
            <div class="help" id="permHint"></div>
          </div>
          <div class="row">
            <div class="field" style="min-width:200px;">
              <label>Start date</label>
              <input id="startDate" type="date" />
            </div>
            <div class="field" style="min-width:180px; align-self:flex-end;">
              <button class="btn secondary" id="btnRefresh">Refresh</button>
            </div>
            <div class="field" style="min-width:240px; align-self:flex-end;">
              <button class="btn" id="btnPdfSnapshot">Download 7-Day PDF Snapshot</button>
            </div>
          </div>
        </div>

        <div class="cardBody">
          <div class="gridWrap">
            <table id="grid"></table>
          </div>
          <div class="msg" id="appMsg" style="display:none;"></div>
        </div>
      </div>

      <!-- USERS (admin only) -->
      <div class="card" id="usersCard" style="display:none;">
        <div class="cardHead">
          <h2>User Management (Admin)</h2>
          <div class="help">Edit name / role / department for existing users.</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field" style="min-width:320px;">
              <label>Select user</label>
              <select id="userSelect"></select>
            </div>
            <div class="field" style="min-width:240px;">
              <label>Name</label>
              <input id="editName" type="text" />
            </div>
            <div class="field" style="min-width:170px;">
              <label>Role</label>
              <select id="editRole">
                <option value="admin">admin</option>
                <option value="user">user</option>
                <option value="viewer">viewer</option>
              </select>
            </div>
            <div class="field" style="min-width:190px;">
              <label>Department</label>
              <select id="editDept">
                <option value="">(none)</option>
                <option value="Guest Service">Guest Service</option>
                <option value="F&B">F&amp;B</option>
                <option value="Outlets">Outlets</option>
              </select>
            </div>
            <div class="field" style="min-width:160px; align-self:flex-end;">
              <button class="btn" id="btnSaveUser">Save</button>
            </div>
          </div>

          <div class="msg" id="usersMsg" style="display:none;"></div>

          <div style="margin-top:12px;" class="gridWrap">
            <table id="usersTable"></table>
          </div>
        </div>
      </div>

      <!-- ACCOUNT -->
      <div class="card" id="accountCard">
        <div class="cardHead">
          <h2>Account</h2>
          <div class="help">If you used a reset link, you can set your new password here.</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field" style="min-width:280px;">
              <label>New password</label>
              <input id="newPass" type="password" placeholder="New password" />
            </div>
            <div class="field" style="min-width:280px;">
              <label>Confirm</label>
              <input id="newPass2" type="password" placeholder="Confirm new password" />
            </div>
            <div class="field" style="min-width:160px; align-self:flex-end;">
              <button class="btn secondary" id="btnUpdatePass">Update password</button>
            </div>
          </div>
          <div class="msg" id="acctMsg" style="display:none;"></div>
        </div>
      </div>
    </div>

    <!-- MODAL: Occupancy edit -->
    <div class="modalBack" id="occModalBack">
      <div class="modal">
        <div class="modalHead">
          <h3 id="occTitle">Edit occupancy</h3>
          <button class="btn secondary" id="occClose">Close</button>
        </div>
        <div class="modalBody">
          <div class="row">
            <div class="field" style="min-width:180px;">
              <label>Occupancy %</label>
              <input id="occPct" type="number" step="0.1" min="0" max="100" placeholder="0 - 100" />
            </div>
            <div class="field" style="flex:1; min-width:280px;">
              <label>Notes</label>
              <textarea id="occNotes" placeholder="Add notes (bigger box)"></textarea>
            </div>
          </div>
          <div class="hint" style="margin-top:8px;">
            Saving will overwrite the current value for that date (history logging happens in the database if your triggers are enabled).
          </div>
          <div class="msg" id="occMsg" style="display:none;"></div>
        </div>
        <div class="modalFoot">
          <button class="btn" id="occSave">Save</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Edit single outlet cell -->
    <div class="modalBack" id="outModalBack">
      <div class="modal">
        <div class="modalHead">
          <h3 id="outTitle">Edit outlet</h3>
          <button class="btn secondary" id="outClose">Close</button>
        </div>
        <div class="modalBody">
          <div class="row">
            <div class="field" style="min-width:220px;">
              <label>Status</label>
              <select id="outOpen">
                <option value="false">Closed</option>
                <option value="true">Open</option>
              </select>
            </div>
            <div class="field" style="min-width:200px;">
              <label>Open time</label>
              <input id="outOpenTime" type="time" />
            </div>
            <div class="field" style="min-width:200px;">
              <label>Close time</label>
              <input id="outCloseTime" type="time" />
            </div>
          </div>
          <div class="hint" style="margin-top:8px;">
            If Open is selected, both times are required.
          </div>
          <div class="msg" id="outMsg" style="display:none;"></div>
        </div>
        <div class="modalFoot">
          <button class="btn" id="outSave">Save</button>
        </div>
      </div>
    </div>

    <!-- MODAL: Edit outlets week -->
    <div class="modalBack" id="outWeekBack">
      <div class="modal">
        <div class="modalHead">
          <h3 id="outWeekTitle">Edit outlets – week</h3>
          <button class="btn secondary" id="outWeekClose">Close</button>
        </div>
        <div class="modalBody" id="outWeekBody"></div>
        <div class="modalFoot">
          <button class="btn" id="outWeekSave">Save changes</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG (your Supabase)
========================= */
const SUPABASE_URL = "https://jiarjsvoumbbilfsqftj.supabase.co";
const SUPABASE_KEY = "sb_publishable_AB6JsEiTT1V5Bu5ANA0Qmw_yFE8M0NV";

/* =========================
   Helpers
========================= */
function setMsg(el, text, type){
  el.style.display = text ? "" : "none";
  el.className = "msg" + (type ? " " + type : "");
  el.textContent = text || "";
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
function torontoISODateToday(){
  // "en-CA" gives YYYY-MM-DD style
  const fmt = new Intl.DateTimeFormat("en-CA", { timeZone:"America/Toronto", year:"numeric", month:"2-digit", day:"2-digit" });
  return fmt.format(new Date());
}
function fmtTorontoDateTime(ts){
  if (!ts) return "";
  const d = new Date(ts);
  return new Intl.DateTimeFormat("en-CA", {
    timeZone:"America/Toronto",
    year:"numeric", month:"short", day:"2-digit",
    hour:"2-digit", minute:"2-digit"
  }).format(d);
}
function fmtTorontoDayLabel(yyyy_mm_dd){
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  return new Intl.DateTimeFormat("en-CA", { timeZone:"America/Toronto", weekday:"short", month:"short", day:"2-digit" }).format(dt);
}
function addDays(yyyy_mm_dd, n){
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  dt.setUTCDate(dt.getUTCDate() + n);
  const yy = dt.getUTCFullYear();
  const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
  const dd = String(dt.getUTCDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}
function fmtTime12(timeStr){
  if (!timeStr) return "";
  const parts = String(timeStr).split(":");
  if (parts.length < 2) return "";
  let hh = parseInt(parts[0],10);
  const mm = parts[1].padStart(2,"0");
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  return `${hh}:${mm} ${ampm}`;
}

/* =========================
   Supabase client
========================= */
if (!window.supabase || !window.supabase.createClient){
  alert("Supabase library not found. Make sure supabase.js is in the repo root beside index.html.");
}
const sb = window.__sb || (window.__sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
}));

/* =========================
   State
========================= */
let session = null;
let meProfile = null;
let allProfiles = []; // {user_id,name,email,role,department}
let profilesById = new Map();

let startDate = torontoISODateToday();
let days = []; // 7 days YYYY-MM-DD

let serviceItems = []; // from service_items
let serviceByGroup = { breakfast:[], lunch:[], dinner:[], massimo:[] };
let serviceById = new Map(); // id -> item

let forecastByDate = new Map(); // date -> row
let selectionByKey = new Map(); // `${date}|${group}` -> row {service_item_id, updated_by, updated_at}
let massimoByKey = new Map(); // `${date}|${service_item_id}` -> row {is_active, updated_by, updated_at}
let outletByKey = new Map(); // `${date}|${outlet_name}` -> row

const OUTLET_NAMES = ["LOBBY BAR","STARBUCKS","SWEET JESUS","FRESHII"];

/* =========================
   Elements
========================= */
const whoPill = document.getElementById("whoPill");
const btnLogout = document.getElementById("btnLogout");
const authCard = document.getElementById("authCard");
const authMsg = document.getElementById("authMsg");
const appView = document.getElementById("appView");
const tabs = document.getElementById("tabs");
const tabUsers = document.getElementById("tabUsers");

const startDateEl = document.getElementById("startDate");
const btnRefresh = document.getElementById("btnRefresh");
const btnPdfSnapshot = document.getElementById("btnPdfSnapshot");
const grid = document.getElementById("grid");
const appMsg = document.getElementById("appMsg");
const permHint = document.getElementById("permHint");

const usersCard = document.getElementById("usersCard");
const userSelect = document.getElementById("userSelect");
const editName = document.getElementById("editName");
const editRole = document.getElementById("editRole");
const editDept = document.getElementById("editDept");
const btnSaveUser = document.getElementById("btnSaveUser");
const usersMsg = document.getElementById("usersMsg");
const usersTable = document.getElementById("usersTable");

const btnLogin = document.getElementById("btnLogin");
const loginEmail = document.getElementById("loginEmail");
const loginPass = document.getElementById("loginPass");
const btnReset = document.getElementById("btnReset");
const resetEmail = document.getElementById("resetEmail");

const newPass = document.getElementById("newPass");
const newPass2 = document.getElementById("newPass2");
const btnUpdatePass = document.getElementById("btnUpdatePass");
const acctMsg = document.getElementById("acctMsg");

/* Occupancy modal */
const occModalBack = document.getElementById("occModalBack");
const occTitle = document.getElementById("occTitle");
const occPct = document.getElementById("occPct");
const occNotes = document.getElementById("occNotes");
const occClose = document.getElementById("occClose");
const occSave = document.getElementById("occSave");
const occMsg = document.getElementById("occMsg");
let occEditingDate = null;

/* Outlet modals */
const outModalBack = document.getElementById("outModalBack");
const outTitle = document.getElementById("outTitle");
const outOpen = document.getElementById("outOpen");
const outOpenTime = document.getElementById("outOpenTime");
const outCloseTime = document.getElementById("outCloseTime");
const outClose = document.getElementById("outClose");
const outSave = document.getElementById("outSave");
const outMsg = document.getElementById("outMsg");
let outEditing = { date:null, name:null };

const outWeekBack = document.getElementById("outWeekBack");
const outWeekTitle = document.getElementById("outWeekTitle");
const outWeekBody = document.getElementById("outWeekBody");
const outWeekClose = document.getElementById("outWeekClose");
const outWeekSave = document.getElementById("outWeekSave");

/* =========================
   Permissions
========================= */
function role(){ return (meProfile?.role || "viewer").toLowerCase(); }
function dept(){ return (meProfile?.department || ""); }

function canEditOccupancy(){
  if (role()==="admin") return true;
  return role()==="user" && dept()==="Guest Service";
}
function canEditRestaurants(){
  if (role()==="admin") return true;
  return role()==="user" && dept()==="F&B";
}
function canEditLobbyBar(){
  // Lobby Bar: only F&B (or admin)
  return canEditRestaurants();
}
function canEditOutlets(){
  if (role()==="admin") return true;
  return role()==="user" && dept()==="Outlets";
}
function isViewerOnly(){
  return role()==="viewer";
}

/* =========================
   Tabs
========================= */
function setTab(name){
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===name));
  usersCard.style.display = (name==="users" && role()==="admin") ? "" : "none";
  document.getElementById("dashCard").style.display = (name==="dashboard") ? "" : "none";
  document.getElementById("accountCard").style.display = (name==="account") ? "" : "none";
}
document.getElementById("tabs").addEventListener("click", (e)=>{
  const t = e.target.closest(".tab");
  if (!t) return;
  setTab(t.dataset.tab);
});

/* =========================
   Auth actions
========================= */
btnLogin.addEventListener("click", async ()=>{
  setMsg(authMsg,"",""); 
  const email = loginEmail.value.trim();
  const password = loginPass.value;
  if (!email || !password) return setMsg(authMsg,"Enter email and password.","err");
  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return setMsg(authMsg, error.message, "err");
  session = data.session;
  await bootstrap();
});

btnReset.addEventListener("click", async ()=>{
  setMsg(authMsg,"",""); 
  const email = resetEmail.value.trim();
  if (!email) return setMsg(authMsg,"Enter an email for password reset.","err");
  const redirectTo = window.location.origin + window.location.pathname; // GitHub pages friendly
  const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
  if (error) return setMsg(authMsg, error.message, "err");
  setMsg(authMsg, "Reset email sent. Open the link, then use Account tab to set a new password.", "ok");
});

btnLogout.addEventListener("click", async ()=>{
  await sb.auth.signOut();
  session = null;
  meProfile = null;
  appView.style.display = "none";
  tabs.style.display = "none";
  authCard.style.display = "";
  btnLogout.style.display = "none";
  whoPill.textContent = "Not signed in";
});

/* Password update (works for recovery sessions too) */
btnUpdatePass.addEventListener("click", async ()=>{
  setMsg(acctMsg,"","");
  const p1 = newPass.value;
  const p2 = newPass2.value;
  if (!p1 || p1.length < 8) return setMsg(acctMsg,"Use at least 8 characters.","err");
  if (p1 !== p2) return setMsg(acctMsg,"Passwords do not match.","err");
  const { error } = await sb.auth.updateUser({ password: p1 });
  if (error) return setMsg(acctMsg, error.message, "err");
  setMsg(acctMsg, "Password updated.", "ok");
  newPass.value = ""; newPass2.value = "";
});

/* =========================
   Load profile + base data
========================= */
async function loadProfiles(){
  const { data, error } = await sb.from("profiles").select("user_id,name,email,role,department").order("name");
  if (error) throw error;
  allProfiles = data || [];
  profilesById = new Map(allProfiles.map(p => [String(p.user_id), p]));
}

async function loadMyProfile(){
  const uid = session?.user?.id;
  if (!uid) return null;
  const { data, error } = await sb.from("profiles").select("user_id,name,email,role,department").eq("user_id", uid).maybeSingle();
  if (error) throw error;
  meProfile = data || { user_id: uid, name: session.user.email, email: session.user.email, role:"viewer", department:"" };
}

async function loadServiceItems(){
  const { data, error } = await sb.from("service_items").select("id,group_name,name").order("group_name").order("name");
  if (error) throw error;
  serviceItems = data || [];
  serviceByGroup = { breakfast:[], lunch:[], dinner:[], massimo:[] };
  serviceById = new Map();
  for (const it of serviceItems){
    serviceById.set(String(it.id), it);
    if (serviceByGroup[it.group_name]) serviceByGroup[it.group_name].push(it);
  }
}

function rangeDays(){
  days = Array.from({length:7}, (_,i)=>addDays(startDate, i));
}

async function loadWeekData(){
  rangeDays();
  const d1 = days[0];
  const d7 = days[6];

  // Forecast
  const f = await sb.from("daily_forecast").select("date,occupancy_percent,notes,updated_at,updated_by").gte("date", d1).lte("date", d7);
  if (f.error) throw f.error;
  forecastByDate = new Map((f.data||[]).map(r => [r.date, r]));

  // Single-select restaurant
  const s = await sb.from("daily_service_selection").select("date,group_name,service_item_id,updated_at,updated_by").gte("date", d1).lte("date", d7);
  if (s.error) throw s.error;
  selectionByKey = new Map((s.data||[]).map(r => [`${r.date}|${r.group_name}`, r]));

  // Massimo multi
  const m = await sb.from("daily_massimo_status").select("date,service_item_id,is_active,updated_at,updated_by").gte("date", d1).lte("date", d7);
  if (m.error) throw m.error;
  massimoByKey = new Map((m.data||[]).map(r => [`${r.date}|${String(r.service_item_id)}`, r]));

  // Outlets
  const o = await sb.from("daily_outlet_hours").select("date,outlet_name,is_open,open_time,close_time,updated_at,updated_by").gte("date", d1).lte("date", d7);
  if (o.error) throw o.error;
  outletByKey = new Map((o.data||[]).map(r => [`${r.date}|${r.outlet_name}`, r]));
}

/* =========================
   Render grid
========================= */
function nameFor(uid){
  if (!uid) return "";
  return profilesById.get(String(uid))?.name || profilesById.get(String(uid))?.email || "Unknown";
}

function selectionRow(date, group){
  return selectionByKey.get(`${date}|${group}`) || null;
}
function selectedId(date, group){
  return selectionRow(date, group)?.service_item_id ? String(selectionRow(date, group).service_item_id) : null;
}
function selectionMeta(date, group){
  const r = selectionRow(date, group);
  if (!r) return null;
  return {
    by: nameFor(r.updated_by),
    at: fmtTorontoDateTime(r.updated_at)
  };
}
function massimoRow(date, itemId){
  return massimoByKey.get(`${date}|${String(itemId)}`) || null;
}
function massimoOn(date, itemId){
  const r = massimoRow(date, itemId);
  return !!(r && r.is_active);
}
function massimoMeta(date, itemId){
  const r = massimoRow(date, itemId);
  if (!r) return null;
  return { by: nameFor(r.updated_by), at: fmtTorontoDateTime(r.updated_at) };
}

function outletRow(date, name){
  return outletByKey.get(`${date}|${name}`) || null;
}
function outletText(date, name){
  const r = outletRow(date, name);
  if (!r) return "Closed";
  if (!r.is_open) return "Closed";
  const ot = fmtTime12(r.open_time);
  const ct = fmtTime12(r.close_time);
  if (!ot || !ct) return "Open (hours missing)";
  return `Open ${ot}–${ct}`;
}
function outletMeta(date, name){
  const r = outletRow(date, name);
  if (!r) return null;
  return { by: nameFor(r.updated_by), at: fmtTorontoDateTime(r.updated_at) };
}

function sectionTitleRow(title){
  return `<tr class="sectionTitleRow"><td class="label">${escapeHtml(title)}</td>${days.map(()=>`<td></td>`).join("")}</tr>`;
}

function render(){
  setMsg(appMsg,"","");
  const canOcc = canEditOccupancy();
  const canRes = canEditRestaurants();
  const canLB  = canEditLobbyBar();
  const canOut = canEditOutlets();

  permHint.textContent =
    role()==="admin" ? "You are Admin (can edit everything)." :
    role()==="viewer" ? "Viewer (read-only)." :
    `User (${dept() || "no department set"})`;

  let html = "";

  // Header
  html += `<thead><tr><th class="label">Item</th>`;
  for (const d of days){
    html += `<th><div class="dayHdr"><div class="d1">${escapeHtml(fmtTorontoDayLabel(d))}</div><div class="d2">${escapeHtml(d)}</div></div></th>`;
  }
  html += `</tr></thead><tbody>`;

  // Occupancy row
  html += sectionTitleRow("Occupancy & Notes (Guest Service)");
  html += `<tr><td class="label">Occupancy % (click to edit)</td>`;
  for (const d of days){
    const r = forecastByDate.get(d);
    const pct = (r?.occupancy_percent ?? null);
    const show = (pct==null ? "—" : `${Number(pct).toFixed(1)}%`);
    const meta = r ? `${escapeHtml(nameFor(r.updated_by))} · ${escapeHtml(fmtTorontoDateTime(r.updated_at))}` : "";
    html += `<td>
      <button class="cellBtn" ${canOcc ? "" : "disabled"} data-occ="${d}">
        <div style="font-weight:900;">${escapeHtml(show)}</div>
        <div class="smallMuted">${r?.notes ? escapeHtml(r.notes.slice(0,40)) + (r.notes.length>40?"…":"") : " "}</div>
        ${meta ? `<div class="meta"><span>${escapeHtml(nameFor(r.updated_by))}</span> · ${escapeHtml(fmtTorontoDateTime(r.updated_at))}</div>` : ``}
      </button>
    </td>`;
  }
  html += `</tr>`;

  // Restaurant sections (single select)
  html += sectionTitleRow("Breakfast (F&B) – single selection (dbl-click green = closed)");
  for (const item of serviceByGroup.breakfast){
    html += `<tr><td class="label">${escapeHtml(item.name)}</td>`;
    for (const d of days){
      const sid = selectedId(d,"breakfast");
      const isGreen = sid && sid === String(item.id);
      const meta = isGreen ? selectionMeta(d,"breakfast") : null;
      html += `<td>
        <div class="cellBtn" style="cursor:${canRes?"pointer":"not-allowed"}; opacity:${canRes?1:.55};"
             data-sel="${d}|breakfast|${String(item.id)}" data-green="${isGreen ? "1":"0"}">
          <div class="dot ${isGreen ? "green":""}"></div>
          ${isGreen && meta ? `<div class="meta"><span>${escapeHtml(meta.by)}</span> · ${escapeHtml(meta.at)}</div>` : `<div class="meta" style="visibility:hidden;">x</div>`}
        </div>
      </td>`;
    }
    html += `</tr>`;
  }

  html += sectionTitleRow("Lunch (F&B) – single selection (dbl-click green = closed)");
  for (const item of serviceByGroup.lunch){
    html += `<tr><td class="label">${escapeHtml(item.name)}</td>`;
    for (const d of days){
      const sid = selectedId(d,"lunch");
      const isGreen = sid && sid === String(item.id);
      const meta = isGreen ? selectionMeta(d,"lunch") : null;
      html += `<td>
        <div class="cellBtn" style="cursor:${canRes?"pointer":"not-allowed"}; opacity:${canRes?1:.55};"
             data-sel="${d}|lunch|${String(item.id)}" data-green="${isGreen ? "1":"0"}">
          <div class="dot ${isGreen ? "green":""}"></div>
          ${isGreen && meta ? `<div class="meta"><span>${escapeHtml(meta.by)}</span> · ${escapeHtml(meta.at)}</div>` : `<div class="meta" style="visibility:hidden;">x</div>`}
        </div>
      </td>`;
    }
    html += `</tr>`;
  }

  html += sectionTitleRow("Dinner (F&B) – single selection (dbl-click green = closed)");
  for (const item of serviceByGroup.dinner){
    html += `<tr><td class="label">${escapeHtml(item.name)}</td>`;
    for (const d of days){
      const sid = selectedId(d,"dinner");
      const isGreen = sid && sid === String(item.id);
      const meta = isGreen ? selectionMeta(d,"dinner") : null;
      html += `<td>
        <div class="cellBtn" style="cursor:${canRes?"pointer":"not-allowed"}; opacity:${canRes?1:.55};"
             data-sel="${d}|dinner|${String(item.id)}" data-green="${isGreen ? "1":"0"}">
          <div class="dot ${isGreen ? "green":""}"></div>
          ${isGreen && meta ? `<div class="meta"><span>${escapeHtml(meta.by)}</span> · ${escapeHtml(meta.at)}</div>` : `<div class="meta" style="visibility:hidden;">x</div>`}
        </div>
      </td>`;
    }
    html += `</tr>`;
  }

  // Massimo multi
  html += sectionTitleRow("Massimo (F&B) – multi selection");
  for (const item of serviceByGroup.massimo){
    html += `<tr><td class="label">${escapeHtml(item.name)}</td>`;
    for (const d of days){
      const isGreen = massimoOn(d, item.id);
      const meta = isGreen ? massimoMeta(d, item.id) : null;
      html += `<td>
        <div class="cellBtn" style="cursor:${canRes?"pointer":"not-allowed"}; opacity:${canRes?1:.55};"
             data-mas="${d}|${String(item.id)}" data-green="${isGreen ? "1":"0"}">
          <div class="dot ${isGreen ? "green":""}"></div>
          ${isGreen && meta ? `<div class="meta"><span>${escapeHtml(meta.by)}</span> · ${escapeHtml(meta.at)}</div>` : `<div class="meta" style="visibility:hidden;">x</div>`}
        </div>
      </td>`;
    }
    html += `</tr>`;
  }

  // Lobby Bar + Outlets
  html += sectionTitleRow("Lobby Bar (F&B)");
  html += `<tr><td class="label">LOBBY BAR (click to edit)</td>`;
  for (const d of days){
    const txt = outletText(d,"LOBBY BAR");
    const isGreen = txt.startsWith("Open");
    const meta = outletMeta(d,"LOBBY BAR");
    html += `<td>
      <button class="cellBtn" ${canLB ? "" : "disabled"} data-out="${d}|LOBBY BAR">
        <div class="dot ${isGreen ? "green":""}"></div>
        <div class="smallMuted">${escapeHtml(txt)}</div>
        ${meta ? `<div class="meta"><span>${escapeHtml(meta.by)}</span> · ${escapeHtml(meta.at)}</div>` : ``}
      </button>
    </td>`;
  }
  html += `</tr>`;

  html += sectionTitleRow("Outlets (Outlets Lead) – week edit available");
  html += `<tr><td class="label">
      Outlets controls<br><span class="smallMuted">Only Outlets dept (or Admin) can edit</span><br>
      <button class="btn secondary" style="margin-top:8px;" id="btnOutWeek" ${canOut ? "" : "disabled"}>Edit Outlets Week</button>
    </td>`;
  for (const d of days){
    html += `<td class="smallMuted">Use week edit, or click outlet rows below</td>`;
  }
  html += `</tr>`;

  for (const outlet of ["STARBUCKS","SWEET JESUS","FRESHII"]){
    html += `<tr><td class="label">${escapeHtml(outlet)} (click to edit)</td>`;
    for (const d of days){
      const txt = outletText(d, outlet);
      const isGreen = txt.startsWith("Open");
      const meta = outletMeta(d, outlet);
      html += `<td>
        <button class="cellBtn" ${canOut ? "" : "disabled"} data-out="${d}|${escapeHtml(outlet)}">
          <div class="dot ${isGreen ? "green":""}"></div>
          <div class="smallMuted">${escapeHtml(txt)}</div>
          ${meta ? `<div class="meta"><span>${escapeHtml(meta.by)}</span> · ${escapeHtml(meta.at)}</div>` : ``}
        </button>
      </td>`;
    }
    html += `</tr>`;
  }

  html += `</tbody>`;
  grid.innerHTML = html;

  // Wire occupancy clicks
  grid.querySelectorAll("[data-occ]").forEach(btn=>{
    btn.addEventListener("click", ()=> openOcc(btn.dataset.occ));
  });

  // Wire single select click + double click
  grid.querySelectorAll("[data-sel]").forEach(div=>{
    div.addEventListener("click", ()=> onSingleSelectClick(div.dataset.sel));
    div.addEventListener("dblclick", ()=> onSingleSelectDblClick(div.dataset.sel));
  });

  // Wire massimo click + dbl
  grid.querySelectorAll("[data-mas]").forEach(div=>{
    div.addEventListener("click", ()=> onMassimoClick(div.dataset.mas));
    div.addEventListener("dblclick", ()=> onMassimoDblClick(div.dataset.mas));
  });

  // Outlet clicks
  grid.querySelectorAll("[data-out]").forEach(btn=>{
    btn.addEventListener("click", ()=> openOutlet(btn.dataset.out));
  });

  // Week outlets button
  const btnOutWeek = document.getElementById("btnOutWeek");
  if (btnOutWeek){
    btnOutWeek.addEventListener("click", ()=> openOutWeek());
  }
}

/* =========================
   Occupancy edit
========================= */
function openOcc(date){
  if (!canEditOccupancy()) return;
  occEditingDate = date;
  const r = forecastByDate.get(date);
  occTitle.textContent = `Edit occupancy – ${date} (${fmtTorontoDayLabel(date)})`;
  occPct.value = (r?.occupancy_percent ?? "");
  occNotes.value = (r?.notes ?? "");
  setMsg(occMsg,"","");
  occModalBack.style.display = "flex";
}
occClose.addEventListener("click", ()=> occModalBack.style.display="none");
occModalBack.addEventListener("click", (e)=>{ if (e.target===occModalBack) occModalBack.style.display="none"; });

occSave.addEventListener("click", async ()=>{
  setMsg(occMsg,"","");
  if (!occEditingDate) return;
  const pct = occPct.value === "" ? null : Number(occPct.value);
  if (pct != null && (pct < 0 || pct > 100)) return setMsg(occMsg,"Occupancy must be 0–100.","err");
  const notes = occNotes.value || null;

  const payload = {
    date: occEditingDate,
    occupancy_percent: pct,
    notes: notes,
    updated_by: session.user.id,
    updated_at: new Date().toISOString()
  };

  const { error } = await sb.from("daily_forecast").upsert(payload, { onConflict:"date" });
  if (error) return setMsg(occMsg, error.message, "err");

  occModalBack.style.display="none";
  await refreshAll();
});

/* =========================
   Restaurant single-select
========================= */
async function onSingleSelectClick(key){
  if (!canEditRestaurants()) return;
  const [date, group, itemId] = key.split("|");
  const current = selectedId(date, group);

  // If already selected, do nothing on single click (avoid accidental clear)
  if (current && current === itemId) return;

  const payload = {
    date,
    group_name: group,
    service_item_id: itemId,
    updated_by: session.user.id,
    updated_at: new Date().toISOString()
  };
  const { error } = await sb.from("daily_service_selection").upsert(payload, { onConflict:"date,group_name" });
  if (error) return setMsg(appMsg, error.message, "err");
  await refreshAll(false);
}

async function onSingleSelectDblClick(key){
  if (!canEditRestaurants()) return;
  const [date, group, itemId] = key.split("|");
  const current = selectedId(date, group);

  // Only clear if the dbl-clicked one is the current selected (green)
  if (!current || current !== itemId) return;

  const payload = {
    date,
    group_name: group,
    service_item_id: null,
    updated_by: session.user.id,
    updated_at: new Date().toISOString()
  };
  const { error } = await sb.from("daily_service_selection").upsert(payload, { onConflict:"date,group_name" });
  if (error) return setMsg(appMsg, error.message, "err");
  await refreshAll(false);
}

/* =========================
   Massimo multi
========================= */
async function onMassimoClick(key){
  if (!canEditRestaurants()) return;
  const [date, itemId] = key.split("|");
  const current = massimoOn(date, itemId);
  const payload = {
    date,
    service_item_id: itemId,
    is_active: !current,
    updated_by: session.user.id,
    updated_at: new Date().toISOString()
  };
  const { error } = await sb.from("daily_massimo_status").upsert(payload, { onConflict:"date,service_item_id" });
  if (error) return setMsg(appMsg, error.message, "err");
  await refreshAll(false);
}
async function onMassimoDblClick(key){
  if (!canEditRestaurants()) return;
  const [date, itemId] = key.split("|");
  if (!massimoOn(date, itemId)) return;
  const payload = {
    date,
    service_item_id: itemId,
    is_active: false,
    updated_by: session.user.id,
    updated_at: new Date().toISOString()
  };
  const { error } = await sb.from("daily_massimo_status").upsert(payload, { onConflict:"date,service_item_id" });
  if (error) return setMsg(appMsg, error.message, "err");
  await refreshAll(false);
}

/* =========================
   Outlets edit
========================= */
function openOutlet(key){
  const [date, name] = key.split("|");
  const isLobby = (name === "LOBBY BAR");
  if (isLobby && !canEditLobbyBar()) return;
  if (!isLobby && !canEditOutlets()) return;

  outEditing = { date, name };
  outTitle.textContent = `Edit ${name} – ${date} (${fmtTorontoDayLabel(date)})`;

  const r = outletRow(date, name);
  const open = r?.is_open ? "true" : "false";
  outOpen.value = open;

  outOpenTime.value = r?.open_time ? String(r.open_time).slice(0,5) : "";
  outCloseTime.value = r?.close_time ? String(r.close_time).slice(0,5) : "";

  setMsg(outMsg,"","");
  outModalBack.style.display = "flex";
}
outClose.addEventListener("click", ()=> outModalBack.style.display="none");
outModalBack.addEventListener("click", (e)=>{ if (e.target===outModalBack) outModalBack.style.display="none"; });

outSave.addEventListener("click", async ()=>{
  setMsg(outMsg,"","");
  const date = outEditing.date;
  const name = outEditing.name;
  if (!date || !name) return;

  const isLobby = (name === "LOBBY BAR");
  if (isLobby && !canEditLobbyBar()) return;
  if (!isLobby && !canEditOutlets()) return;

  const isOpen = (outOpen.value === "true");
  const ot = outOpenTime.value || null;
  const ct = outCloseTime.value || null;

  if (isOpen && (!ot || !ct)) return setMsg(outMsg,"If Open, you must enter both times.","err");

  const payload = {
    date,
    outlet_name: name,
    is_open: isOpen,
    open_time: isOpen ? ot : null,
    close_time: isOpen ? ct : null,
    updated_by: session.user.id,
    updated_at: new Date().toISOString()
  };

  const { error } = await sb.from("daily_outlet_hours").upsert(payload, { onConflict:"date,outlet_name" });
  if (error) return setMsg(outMsg, error.message, "err");

  outModalBack.style.display = "none";
  await refreshAll(false);
});

/* Week edit for outlets (Starbucks, Sweet Jesus, Freshii) */
function openOutWeek(){
  if (!canEditOutlets()) return;
  outWeekTitle.textContent = `Edit outlets week – starting ${days[0]}`;
  const outlets = ["STARBUCKS","SWEET JESUS","FRESHII"];

  let html = `<div class="gridWrap"><table style="min-width:980px;">
    <thead><tr><th style="width:160px;">Date</th>`;
  for (const o of outlets){
    html += `<th>${escapeHtml(o)}<div class="smallMuted">Open + times</div></th>`;
  }
  html += `</tr></thead><tbody>`;

  for (const d of days){
    html += `<tr>
      <td class="label" style="position:static; background:transparent; border-right:none;">
        <div style="font-weight:900;">${escapeHtml(fmtTorontoDayLabel(d))}</div>
        <div class="smallMuted">${escapeHtml(d)}</div>
      </td>`;

    for (const o of outlets){
      const r = outletRow(d,o);
      const open = r?.is_open ? "checked" : "";
      const ot = r?.open_time ? String(r.open_time).slice(0,5) : "";
      const ct = r?.close_time ? String(r.close_time).slice(0,5) : "";
      html += `<td>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <label style="display:flex; gap:8px; align-items:center; font-weight:800; color:var(--text);">
            <input type="checkbox" data-wk-open="${d}|${o}" ${open} style="width:18px; height:18px;" />
            Open
          </label>
          <div style="display:flex; gap:8px;">
            <input type="time" data-wk-ot="${d}|${o}" value="${escapeHtml(ot)}" />
            <input type="time" data-wk-ct="${d}|${o}" value="${escapeHtml(ct)}" />
          </div>
          <div class="smallMuted">If Open is checked, both times required.</div>
        </div>
      </td>`;
    }
    html += `</tr>`;
  }

  html += `</tbody></table></div>
    <div class="msg" id="outWeekMsg" style="display:none;"></div>`;
  outWeekBody.innerHTML = html;

  outWeekBack.style.display = "flex";
}
outWeekClose.addEventListener("click", ()=> outWeekBack.style.display="none");
outWeekBack.addEventListener("click", (e)=>{ if (e.target===outWeekBack) outWeekBack.style.display="none"; });

outWeekSave.addEventListener("click", async ()=>{
  if (!canEditOutlets()) return;
  const msgEl = document.getElementById("outWeekMsg");
  setMsg(msgEl,"","");

  const outlets = ["STARBUCKS","SWEET JESUS","FRESHII"];
  const updates = [];

  for (const d of days){
    for (const o of outlets){
      const openEl = outWeekBody.querySelector(`[data-wk-open="${d}|${o}"]`);
      const otEl = outWeekBody.querySelector(`[data-wk-ot="${d}|${o}"]`);
      const ctEl = outWeekBody.querySelector(`[data-wk-ct="${d}|${o}"]`);
      const isOpen = !!openEl?.checked;
      const ot = otEl?.value || null;
      const ct = ctEl?.value || null;

      // If user didn’t touch anything and it remains empty closed, we still allow saving "closed"
      if (isOpen && (!ot || !ct)){
        return setMsg(msgEl, `Missing times: ${o} on ${d}. If Open, both times are required.`, "err");
      }

      updates.push({
        date: d,
        outlet_name: o,
        is_open: isOpen,
        open_time: isOpen ? ot : null,
        close_time: isOpen ? ct : null,
        updated_by: session.user.id,
        updated_at: new Date().toISOString()
      });
    }
  }

  const { error } = await sb.from("daily_outlet_hours").upsert(updates, { onConflict:"date,outlet_name" });
  if (error) return setMsg(msgEl, error.message, "err");

  setMsg(msgEl, "Saved.", "ok");
  outWeekBack.style.display = "none";
  await refreshAll(false);
});

/* =========================
   Users (admin)
========================= */
function renderUsers(){
  if (role() !== "admin") return;

  // Dropdown
  userSelect.innerHTML = allProfiles.map(p => {
    const label = `${p.name || p.email || p.user_id} (${p.email || ""})`;
    return `<option value="${escapeHtml(String(p.user_id))}">${escapeHtml(label)}</option>`;
  }).join("");

  if (allProfiles.length){
    const firstId = String(allProfiles[0].user_id);
    userSelect.value = firstId;
    fillUserEdit(firstId);
  }

  userSelect.addEventListener("change", ()=> fillUserEdit(userSelect.value));

  // Table
  let t = `<thead><tr>
    <th>Name</th><th>Email</th><th>Role</th><th>Department</th>
  </tr></thead><tbody>`;
  for (const p of allProfiles){
    t += `<tr>
      <td>${escapeHtml(p.name || "")}</td>
      <td>${escapeHtml(p.email || "")}</td>
      <td>${escapeHtml(p.role || "")}</td>
      <td>${escapeHtml(p.department || "")}</td>
    </tr>`;
  }
  t += `</tbody>`;
  usersTable.innerHTML = t;
}
function fillUserEdit(uid){
  const p = profilesById.get(String(uid));
  if (!p) return;
  editName.value = p.name || "";
  editRole.value = (p.role || "viewer").toLowerCase();
  editDept.value = p.department || "";
}

btnSaveUser.addEventListener("click", async ()=>{
  if (role() !== "admin") return;
  setMsg(usersMsg,"","");
  const uid = userSelect.value;
  if (!uid) return;

  const payload = {
    user_id: uid,
    name: editName.value.trim() || null,
    role: editRole.value,
    department: editDept.value || null,
    updated_at: new Date().toISOString()
  };

  const { error } = await sb.from("profiles").upsert(payload, { onConflict:"user_id" });
  if (error) return setMsg(usersMsg, error.message, "err");

  setMsg(usersMsg, "Saved.", "ok");
  await refreshAll();
});

/* =========================
   PDF snapshot (no external libs)
========================= */
function pdfEscape(s){
  return String(s ?? "")
    .replace(/\\/g, "\\\\")
    .replace(/\(/g, "\\(")
    .replace(/\)/g, "\\)")
    .replace(/[^\x09\x0A\x0D\x20-\x7E]/g, "?");
}
function buildSimplePdfFromLines(lines){
  const pageW = 612, pageH = 792;
  const marginL = 48, marginT = 56;
  const lineH = 14;
  const maxLinesPerPage = Math.floor((pageH - marginT - 48) / lineH);

  const pages = [];
  for (let i=0; i<lines.length; i+=maxLinesPerPage){
    pages.push(lines.slice(i, i+maxLinesPerPage));
  }

  const objs = [];
  const add = (s)=>{ objs.push(s); return objs.length; };

  add(`<< /Type /Catalog /Pages 2 0 R >>`); // 1
  add(`<< >>`); // 2 placeholder pages
  const fontId = add(`<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>`); // 3

  const contentIds = [];
  const pageIds = [];

  for (let p=0; p<pages.length; p++){
    const pageLines = pages[p];
    let content = [];
    content.push("BT");
    content.push(`/F1 11 Tf`);
    content.push(`${marginL} ${pageH - marginT} Td`);
    for (let i=0; i<pageLines.length; i++){
      const t = pdfEscape(pageLines[i]);
      if (i === 0) content.push(`(${t}) Tj`);
      else content.push(`0 -${lineH} Td (${t}) Tj`);
    }
    content.push("ET");
    const cs = content.join("\n");
    contentIds.push(add(`<< /Length ${cs.length} >>\nstream\n${cs}\nendstream`));
  }

  for (let p=0; p<pages.length; p++){
    pageIds.push(add(
      `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW} ${pageH}] ` +
      `/Resources << /Font << /F1 ${fontId} 0 R >> >> ` +
      `/Contents ${contentIds[p]} 0 R >>`
    ));
  }

  objs[1] = `<< /Type /Pages /Kids [${pageIds.map(id=>`${id} 0 R`).join(" ")}] /Count ${pageIds.length} >>`;

  let pdf = `%PDF-1.4\n`;
  const xref = [];
  xref.push("0000000000 65535 f \n");
  for (let i=0; i<objs.length; i++){
    const off = pdf.length;
    xref.push(String(off).padStart(10,"0") + " 00000 n \n");
    pdf += `${i+1} 0 obj\n${objs[i]}\nendobj\n`;
  }
  const xrefOff = pdf.length;
  pdf += `xref\n0 ${objs.length+1}\n` + xref.join("") +
         `trailer\n<< /Size ${objs.length+1} /Root 1 0 R >>\nstartxref\n${xrefOff}\n%%EOF`;

  return new Uint8Array(Array.from(pdf).map(ch => ch.charCodeAt(0)));
}

btnPdfSnapshot.addEventListener("click", ()=>{
  try{
    const lines = [];
    lines.push("Sheraton Niagara Falls – 7-Day Snapshot");
    lines.push(`Start date: ${days[0]}  (Toronto time view)`);
    lines.push(`Generated: ${new Intl.DateTimeFormat("en-CA", {
      timeZone:"America/Toronto", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
    }).format(new Date())}`);
    lines.push(" ");

    function selectedNameOrClosed(date, group, label){
      const row = selectionRow(date, group);
      if (!row || !row.service_item_id) return `${label} closed`;
      const it = serviceById.get(String(row.service_item_id));
      return it?.name || `${label} open`;
    }
    function massimoSummary(date){
      const names = serviceByGroup.massimo
        .filter(it => massimoOn(date, it.id))
        .map(it => it.name.replace("MASSIMO ",""));
      return names.length ? names.join(", ") : "Massimo closed";
    }

    for (const d of days){
      lines.push(`${fmtTorontoDayLabel(d)}  [${d}]`);
      const f = forecastByDate.get(d);
      lines.push(`  Occupancy: ${f?.occupancy_percent==null ? "—" : Number(f.occupancy_percent).toFixed(1) + "%"}`);
      if (f?.notes) lines.push(`  Notes: ${String(f.notes).replace(/\s+/g," ").trim()}`);
      lines.push(`  Breakfast: ${selectedNameOrClosed(d,"breakfast","Breakfast")}`);
      lines.push(`  Lunch: ${selectedNameOrClosed(d,"lunch","Lunch")}`);
      lines.push(`  Dinner: ${selectedNameOrClosed(d,"dinner","Dinner")}`);
      lines.push(`  Massimo: ${massimoSummary(d)}`);
      lines.push(`  Lobby Bar: ${outletText(d,"LOBBY BAR")}`);
      lines.push(`  Starbucks: ${outletText(d,"STARBUCKS")}`);
      lines.push(`  Sweet Jesus: ${outletText(d,"SWEET JESUS")}`);
      lines.push(`  Freshii: ${outletText(d,"FRESHII")}`);
      lines.push(" ");
    }

    const bytes = buildSimplePdfFromLines(lines);
    const blob = new Blob([bytes], {type:"application/pdf"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `Sheraton_7Day_Snapshot_${days[0]}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 4000);
  } catch(e){
    console.error(e);
    setMsg(appMsg, e?.message || String(e), "err");
  }
});

/* =========================
   Refresh
========================= */
async function refreshAll(showOk=true){
  try{
    setMsg(appMsg,"","");
    await loadProfiles();
    await loadMyProfile();
    await loadServiceItems();
    await loadWeekData();
    render();
    if (role()==="admin"){
      renderUsers();
    }
    if (showOk) setMsg(appMsg, "Loaded.", "ok");
  } catch(e){
    console.error(e);
    setMsg(appMsg, e?.message || String(e), "err");
  }
}

btnRefresh.addEventListener("click", async ()=>{
  startDate = startDateEl.value || torontoISODateToday();
  await refreshAll(false);
});

startDateEl.value = startDate;

/* =========================
   Bootstrap
========================= */
async function bootstrap(){
  authCard.style.display = "none";
  appView.style.display = "";
  tabs.style.display = "";
  btnLogout.style.display = "";

  await refreshAll(false);

  const displayName = meProfile?.name || session?.user?.email || "User";
  whoPill.textContent = `${displayName} • ${role()}${dept()? " • " + dept() : ""}`;

  // admin tab
  if (role()==="admin"){
    tabUsers.style.display = "";
  } else {
    tabUsers.style.display = "none";
  }

  setTab("dashboard");
}

/* =========================
   Initial session check (handles recovery links too)
========================= */
(async function init(){
  const { data } = await sb.auth.getSession();
  session = data.session;

  // show recovery / invite flows: if user lands here via a link, session may exist
  if (session){
    await bootstrap();
  } else {
    authCard.style.display = "";
  }

  sb.auth.onAuthStateChange(async (event, newSession) => {
    session = newSession;
    if (session){
      await bootstrap();
    } else {
      appView.style.display = "none";
      tabs.style.display = "none";
      authCard.style.display = "";
      btnLogout.style.display = "none";
      whoPill.textContent = "Not signed in";
    }
  });
})();
</script>
</body>
</html>
