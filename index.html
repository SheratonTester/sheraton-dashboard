<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheraton Niagara Falls – Ops Dashboard</title>
  <style>
    :root{
      --bg:#f6f9ff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5b6b86;
      --brand:#2563eb;
      --border:#e6eefc;

      --green:#0f5132;     /* dark green */
      --red:#7a1020;       /* dark red */
      --tileText:#ffffff;

      --shadow: 0 10px 30px rgba(16, 38, 96, .10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg, #eef4ff, #f7fbff 35%, var(--bg));
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(246,249,255,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    .topbar{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      border:1px solid var(--border);
      background: #fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 2px 10px rgba(0,0,0,.03);
    }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    label{font-size:12px;color:var(--muted)}
    input[type="date"], input[type="text"], input[type="password"], select, textarea{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      outline:none;
      width:100%;
    }
    textarea{min-height:140px; resize:vertical}
    .btn{
      border:0;
      background:var(--brand);
      color:white;
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background:#fff;
      color:var(--brand);
      border:1px solid var(--border);
      box-shadow:none;
      font-weight:700;
    }
    .btn.danger{
      background:#ef4444;
      box-shadow: 0 10px 20px rgba(239,68,68,.15);
    }
    .grid{
      display:grid;
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .sectionTitle{
      font-weight:900;
      letter-spacing:.2px;
      margin:0 0 10px 0;
    }
    .subtle{color:var(--muted);font-size:12px}

    .errorBanner{
      margin-top:10px;
      display:none;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#7f1d1d;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
    }
    .errorBanner.show{display:block}

    /* Login */
    .center{
      min-height: calc(100vh - 76px);
      display:flex; align-items:center; justify-content:center;
      padding:22px 16px;
    }
    .loginCard{
      width:min(520px, 100%);
      padding:18px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > div{flex:1 1 220px}

    /* Occupancy cards */
    .occRow{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
    }
    .occTile{
      min-width:170px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: #ffffff;
      scroll-snap-align:start;
      cursor:pointer;
    }
    .occTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:8px;
    }
    .occDay{font-weight:900}
    .occDate{font-size:12px;color:var(--muted)}
    .occPct{font-size:26px;font-weight:950;margin-top:6px}
    .occMeta{font-size:12px;color:var(--muted);margin-top:8px}

    /* Status table */
    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:900px;
      background:#fff;
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    th{
      position:sticky; top:0;
      background:#f3f7ff;
      z-index:2;
      font-size:12px;
      color:var(--muted);
      text-align:left;
    }
    .groupHeader{
      background:#f8fbff;
      font-weight:950;
      color:#1f2a44;
    }
    .svcName{font-weight:800}
    .tile{
      width:100%;
      height:44px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .tile.green{background:var(--green)}
    .tile.red{background:var(--red)}
    .tileInfo{
      position:absolute;
      left:10px; right:10px; bottom:6px;
      font-size:11px;
      color:rgba(255,255,255,.92);
      display:flex;
      justify-content:space-between;
      gap:8px;
      pointer-events:none;
    }
    .tileInfo span{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(6,10,18,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999; /* above everything */
    }
    .modalBack.show{display:flex}
    .modal{
      width:min(820px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow: 0 30px 90px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 16px;
      background:#f7faff;
      border-bottom:1px solid var(--border);
    }
    .modalHead strong{font-size:14px}
    .modalBody{padding:14px 16px}
    .modalFoot{
      padding:14px 16px;
      border-top:1px solid var(--border);
      display:flex; gap:10px; justify-content:flex-end;
      background:#fff;
    }

    .tabs{
      display:flex; gap:8px; margin-top:12px;
    }
    .tabbtn{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:800;
      color:var(--muted);
    }
    .tabbtn.active{
      background: #eaf1ff;
      color:#103a9c;
      border-color:#cfe0ff;
    }

    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    @media (max-width:720px){
      .wrap{padding:12px}
      table{min-width:780px}
      .occTile{min-width:160px}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Sheraton Niagara Falls – Ops Dashboard</h1>
        <div class="pillrow" style="margin-top:8px">
          <div class="pill" id="pillRole">Role: —</div>
          <div class="pill" id="pillDept">Dept: —</div>
          <div class="pill" id="pillUser">User: —</div>
        </div>
      </div>
      <div class="actions">
        <div style="min-width:170px">
          <label>Start date</label>
          <input id="startDate" type="date" />
        </div>
        <button class="btn secondary" id="btnToday">Today</button>
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn secondary" id="btnPdf">Download 7-Day PDF Snapshot</button>
        <button class="btn danger" id="btnLogout" style="display:none">Logout</button>
      </div>
    </div>
    <div id="err" class="errorBanner"></div>

    <div class="tabs">
      <button class="tabbtn active" id="tabDash">Dashboard</button>
      <button class="tabbtn" id="tabUsers" style="display:none">Users</button>
    </div>
  </div>
</header>

<main class="wrap" id="appRoot"></main>

<!-- Modal: occupancy edit -->
<div class="modalBack" id="occModalBack" aria-hidden="true">
  <div class="modal">
    <div class="modalHead">
      <strong id="occModalTitle">Edit occupancy</strong>
      <button class="btn secondary" id="occClose">Close</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <div>
          <label>Occupancy % (0–100)</label>
          <input id="occPct" type="text" placeholder="e.g., 78.5" />
        </div>
        <div>
          <label>Notes (short)</label>
          <input id="occShort" type="text" placeholder="Optional" />
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Notes (long)</label>
        <textarea id="occLong" placeholder="Type your longer notes here…"></textarea>
      </div>
      <div class="hint">Tip: clicking a day card will pre-fill the last saved data for that date.</div>
    </div>
    <div class="modalFoot">
      <button class="btn secondary" id="occCancel">Close</button>
      <button class="btn" id="occSave">Save</button>
    </div>
  </div>
</div>

<!-- Login / Complete Account -->
<div class="center" id="authRoot" style="display:none">
  <div class="card loginCard">
    <h2 style="margin:0 0 8px 0">Sign in</h2>
    <div class="subtle">Use your work email.</div>

    <div style="margin-top:14px" class="row">
      <div>
        <label>Email</label>
        <input id="loginEmail" type="text" placeholder="name@niagarafallshotels.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="loginPass" type="password" placeholder="••••••••" />
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn" id="btnLogin">Sign in</button>
      <button class="btn secondary" id="btnForgot">Send reset email</button>
    </div>

    <hr style="border:0;border-top:1px solid var(--border); margin:16px 0">

    <h3 style="margin:0 0 8px 0">First time / invited?</h3>
    <div class="subtle">If you clicked an invite or reset link, set your name + new password here.</div>

    <div style="margin-top:12px" class="row">
      <div>
        <label>Full name</label>
        <input id="setupName" type="text" placeholder="First Last" />
      </div>
      <div>
        <label>New password</label>
        <input id="setupPass" type="password" placeholder="New password" />
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="btn" id="btnComplete">Save name + password</button>
    </div>

    <div class="hint">If your company network blocks CDNs, you’re doing the right thing using local <b>supabase.js</b>.</div>
  </div>
</div>

<!-- Supabase client (LOCAL) -->
<script src="./supabase.js"></script>

<script>
(() => {
  // ====== CONFIG ======
  const SUPABASE_URL = "https://jiarjsvoumbbilfsqftj.supabase.co";
  const SUPABASE_KEY = "sb_publishable_AB6JsEiTT1V5Bu5ANA0Qmw_yFE8M0NV";
  const TZ = "America/Toronto";
  const DAYS = 7;

  // Make sure we only create the client ONCE.
  const sb = window.supabase?.createClient ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

  // ====== Helpers ======
  const $ = (id) => document.getElementById(id);
  const errBox = $("err");
  function showErr(msg){
    errBox.textContent = msg;
    errBox.classList.add("show");
  }
  function clearErr(){
    errBox.textContent = "";
    errBox.classList.remove("show");
  }
  function fmtToronto(iso){
    if(!iso) return "—";
    try{
      return new Date(iso).toLocaleString("en-CA", { timeZone: TZ, year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return "—"; }
  }
  function toISODate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function addDays(isoDate, n){
    const d = new Date(isoDate + "T12:00:00");
    d.setDate(d.getDate() + n);
    return toISODate(d);
  }
  function dayLabel(isoDate){
    const d = new Date(isoDate + "T12:00:00");
    return d.toLocaleDateString("en-CA", { timeZone: TZ, weekday:"short", month:"short", day:"2-digit" });
  }

  // Permissions
  function canEditOccupancy(profile){
    return profile?.role === "admin" || (profile?.role === "user" && profile?.department === "Guest Service");
  }
  function canEditRestaurants(profile){
    return profile?.role === "admin" || (profile?.role === "user" && profile?.department === "F&B");
  }
  function canEditOutlets(profile){
    return profile?.role === "admin" || (profile?.role === "user" && profile?.department === "Outlets");
  }

  // ====== State ======
  let currentUser = null;
  let profile = null;

  let startDate = toISODate(new Date());
  let serviceItems = [];
  let forecastByDate = new Map(); // date -> row
  let selectionByKey = new Map(); // `${date}|${group}` -> row
  let massimoByKey = new Map(); // `${date}|${service_item_id}` -> row
  let outletByKey = new Map(); // `${date}|${outlet_name}` -> row

  // outlets list
  const OUTLETS = [
    { key:"Lobby Bar", editDept:"F&B" },
    { key:"Starbucks", editDept:"Outlets" },
    { key:"Sweet Jesus", editDept:"Outlets" },
    { key:"Freshii", editDept:"Outlets" },
  ];

  // ====== UI roots ======
  const appRoot = $("appRoot");
  const authRoot = $("authRoot");

  // ====== Tabs ======
  $("tabDash").onclick = () => {
    $("tabDash").classList.add("active");
    $("tabUsers").classList.remove("active");
    renderDashboard();
  };
  $("tabUsers").onclick = () => {
    $("tabUsers").classList.add("active");
    $("tabDash").classList.remove("active");
    renderUsersAdmin();
  };

  // ====== Header actions ======
  $("startDate").value = startDate;
  $("startDate").addEventListener("change", () => {
    startDate = $("startDate").value || startDate;
    loadAll().catch(e => showErr(e?.message || String(e)));
  });
  $("btnToday").onclick = () => {
    startDate = toISODate(new Date());
    $("startDate").value = startDate;
    loadAll().catch(e => showErr(e?.message || String(e)));
  };
  $("btnRefresh").onclick = () => loadAll().catch(e => showErr(e?.message || String(e)));
  $("btnPdf").onclick = () => openPdfSnapshot();

  // ====== Auth buttons ======
  $("btnLogin").onclick = async () => {
    clearErr();
    const email = $("loginEmail").value.trim();
    const password = $("loginPass").value;
    if(!email || !password) return showErr("Enter email + password.");
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return showErr(error.message);
    await onAuthChanged();
  };

  $("btnForgot").onclick = async () => {
    clearErr();
    const email = $("loginEmail").value.trim();
    if(!email) return showErr("Enter your email first.");
    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.href.split("#")[0]
    });
    if(error) return showErr(error.message);
    showErr("Reset email sent. Use the link, then set your new password below.");
  };

  $("btnComplete").onclick = async () => {
    clearErr();
    const name = $("setupName").value.trim();
    const pass = $("setupPass").value;
    if(!name || !pass) return showErr("Enter full name + new password.");
    const { data: u } = await sb.auth.getUser();
    if(!u?.user) return showErr("You must open the invite/reset link first (it signs you in).");
    const { error: e1 } = await sb.auth.updateUser({ password: pass });
    if(e1) return showErr(e1.message);

    // Upsert profile name (email from auth)
    const user_id = u.user.id;
    const email = u.user.email;
    const { error: e2 } = await sb.from("profiles").upsert({
      user_id,
      email,
      name,
      // keep existing role/department if already set; if not, default to viewer
      role: "viewer",
      is_active: true
    }, { onConflict: "user_id" });
    if(e2) return showErr(e2.message);

    showErr("Saved. You can sign in now.");
  };

  $("btnLogout").onclick = async () => {
    await sb.auth.signOut();
    await onAuthChanged();
  };

  // ====== Modals ======
  let occEditDate = null;
  $("occClose").onclick = () => closeOccModal();
  $("occCancel").onclick = () => closeOccModal();
  $("occSave").onclick = async () => {
    clearErr();
    if(!occEditDate) return;
    if(!canEditOccupancy(profile)) return showErr("You don’t have permission to edit occupancy.");

    const pctRaw = $("occPct").value.trim();
    const pct = pctRaw ? Number(pctRaw) : null;
    if(pctRaw && (Number.isNaN(pct) || pct < 0 || pct > 100)) return showErr("Occupancy must be 0–100.");

    const payload = {
      date: occEditDate,                 // IMPORTANT: always send date
      occupancy_pct: pct,
      notes_short: $("occShort").value.trim() || null,
      notes_long: $("occLong").value.trim() || null,
      updated_by: currentUser.id,
      updated_at: new Date().toISOString()
    };

    const { error } = await sb.from("daily_forecast").upsert(payload, { onConflict: "date" });
    if(error) return showErr(error.message);

    closeOccModal();
    await loadAll();
  };

  function openOccModal(dateStr){
    occEditDate = dateStr;
    $("occModalTitle").textContent = "Edit occupancy — " + dateStr;

    const row = forecastByDate.get(dateStr) || {};
    $("occPct").value = (row.occupancy_pct ?? "") === null ? "" : (row.occupancy_pct ?? "");
    $("occShort").value = row.notes_short ?? "";
    $("occLong").value = row.notes_long ?? "";

    $("occModalBack").classList.add("show");
  }
  function closeOccModal(){
    occEditDate = null;
    $("occModalBack").classList.remove("show");
  }

  // ====== Data loading ======
  async function loadProfile(){
    const { data } = await sb.auth.getUser();
    currentUser = data?.user || null;
    if(!currentUser) return null;

    const { data: p, error } = await sb.from("profiles")
      .select("user_id,email,name,role,department,is_active")
      .eq("user_id", currentUser.id)
      .maybeSingle();

    if(error) throw error;
    return p || null;
  }

  async function loadAll(){
    clearErr();
    if(!sb) return showErr("Supabase client not found. Make sure supabase.js is in the repo root.");

    profile = await loadProfile();

    $("pillRole").textContent = "Role: " + (profile?.role || "—");
    $("pillDept").textContent = "Dept: " + (profile?.department || "—");
    $("pillUser").textContent = "User: " + (profile?.name || currentUser?.email || "—");

    // Tabs / buttons
    $("btnLogout").style.display = currentUser ? "inline-flex" : "none";
    $("tabUsers").style.display = (profile?.role === "admin") ? "inline-flex" : "none";

    // Build 7-day window
    const dates = [];
    for(let i=0;i<DAYS;i++) dates.push(addDays(startDate, i));

    // Service items
    {
      const { data, error } = await sb.from("service_items")
        .select("id,name,group_name,sort_order")
        .order("group_name", { ascending:true })
        .order("sort_order", { ascending:true });

      if(error) throw error;
      serviceItems = data || [];
    }

    // Forecast
    {
      const { data, error } = await sb.from("daily_forecast")
        .select("date,occupancy_pct,notes_short,notes_long,updated_at,updated_by_name")
        .in("date", dates);

      if(error) throw error;
      forecastByDate = new Map((data || []).map(r => [r.date, r]));
    }

    // Restaurant selections (breakfast/lunch/dinner)
    {
      const { data, error } = await sb.from("daily_service_selection")
        .select("date,group_name,service_item_id,updated_at,updated_by_name")
        .in("date", dates);

      if(error) throw error;
      selectionByKey = new Map((data || []).map(r => [`${r.date}|${r.group_name}`, r]));
    }

    // Massimo status
    {
      const { data, error } = await sb.from("daily_massimo_status")
        .select("date,service_item_id,is_active,updated_at,updated_by_name")
        .in("date", dates);

      if(error) throw error;
      massimoByKey = new Map((data || []).map(r => [`${r.date}|${r.service_item_id}`, r]));
    }

    // Outlets hours
    {
      const { data, error } = await sb.from("daily_outlet_hours")
        .select("date,outlet_name,is_open,open_time,close_time,updated_at,updated_by_name")
        .in("date", dates);

      if(error) throw error;
      outletByKey = new Map((data || []).map(r => [`${r.date}|${r.outlet_name}`, r]));
    }

    // Render correct tab
    if($("tabUsers").classList.contains("active") && profile?.role === "admin"){
      renderUsersAdmin();
    } else {
      $("tabDash").classList.add("active");
      $("tabUsers").classList.remove("active");
      renderDashboard();
    }
  }

  // ====== Render Dashboard ======
  function renderDashboard(){
    const dates = [];
    for(let i=0;i<DAYS;i++) dates.push(addDays(startDate, i));

    appRoot.innerHTML = `
      <div class="grid">
        <div class="card">
          <h3 class="sectionTitle">7-Day Occupancy Forecast</h3>
          <div class="subtle">Click a day to edit (Guest Service or Admin).</div>
          <div class="occRow" id="occRow"></div>
        </div>

        <div class="card">
          <h3 class="sectionTitle">Restaurant Status</h3>
          <div class="subtle">Dark green = active. Dark red = inactive. (F&B or Admin can edit.)</div>
          <div class="tableWrap" style="margin-top:10px">
            <table id="svcTable"></table>
          </div>
          <div class="hint">Tip: Double-click a green box to clear it (all red for that day/group). Massimo can have multiple greens.</div>
        </div>

        <div class="card">
          <h3 class="sectionTitle">Lobby Bar & Outlets</h3>
          <div class="subtle">Open/Closed + hours (Lobby Bar = F&B. Others = Outlets. Admin can edit all.)</div>
          <div class="tableWrap" style="margin-top:10px">
            <table id="outletTable"></table>
          </div>
        </div>
      </div>
    `;

    // Occupancy row
    const occRow = $("occRow");
    occRow.innerHTML = dates.map(d => {
      const row = forecastByDate.get(d);
      const pct = row?.occupancy_pct;
      const pctText = (pct === null || pct === undefined) ? "—" : (Number(pct).toFixed(1) + "%");
      const meta = row?.updated_at ? `${row.updated_by_name || "—"} • ${fmtToronto(row.updated_at)}` : "—";
      return `
        <div class="occTile" data-date="${d}">
          <div class="occTop">
            <div>
              <div class="occDay">${dayLabel(d)}</div>
              <div class="occDate">${d}</div>
            </div>
          </div>
          <div class="occPct">${pctText}</div>
          <div class="occMeta">Last update: ${meta}</div>
        </div>
      `;
    }).join("");

    [...occRow.querySelectorAll(".occTile")].forEach(el => {
      el.addEventListener("click", () => {
        if(!canEditOccupancy(profile)) return showErr("No permission to edit occupancy.");
        openOccModal(el.getAttribute("data-date"));
      });
    });

    // Service table
    const svcTable = $("svcTable");
    const svcDatesHeader = dates.map(d => `<th>${dayLabel(d)}<div class="subtle">${d}</div></th>`).join("");

    const groups = [
      { key:"breakfast", title:"BREAKFAST", mode:"single" },
      { key:"lunch", title:"LUNCH", mode:"single" },
      { key:"dinner", title:"DINNER", mode:"single" },
      { key:"massimo", title:"MASSIMO", mode:"multi" },
    ];

    const rowsHtml = groups.map(g => {
      const items = serviceItems.filter(x => x.group_name === g.key).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));

      const headerRow = `
        <tr class="groupHeader">
          <td colspan="${1+dates.length}">${g.title}</td>
        </tr>
      `;

      const itemRows = items.map(item => {
        const cells = dates.map(d => {
          const updated = getServiceUpdatedInfo(d, g.key, item.id);
          const isGreen = isServiceGreen(d, g.key, item.id);
          const cls = isGreen ? "green" : "red";
          const infoLeft = updated.name || "—";
          const infoRight = updated.at ? fmtToronto(updated.at) : "—";
          return `
            <td>
              <div class="tile ${cls}" data-group="${g.key}" data-mode="${g.mode}" data-date="${d}" data-item="${item.id}">
                <div class="tileInfo">
                  <span>${infoLeft}</span>
                  <span>${infoRight}</span>
                </div>
              </div>
            </td>
          `;
        }).join("");

        return `
          <tr>
            <td class="svcName">${item.name}</td>
            ${cells}
          </tr>
        `;
      }).join("");

      return headerRow + itemRows;
    }).join("");

    svcTable.innerHTML = `
      <thead>
        <tr>
          <th style="min-width:280px">Service</th>
          ${svcDatesHeader}
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    `;

    // Click handlers for service tiles
    [...svcTable.querySelectorAll(".tile")].forEach(tile => {
      let clickTimer = null;
      tile.addEventListener("click", (e) => {
        // single click = set green (or toggle for massimo)
        if(clickTimer) return;
        clickTimer = setTimeout(async () => {
          clickTimer = null;
          await onServiceClick(tile, false);
        }, 200);
      });
      tile.addEventListener("dblclick", async () => {
        // double click = clear (turn all red for that day/group)
        if(clickTimer){ clearTimeout(clickTimer); clickTimer=null; }
        await onServiceClick(tile, true);
      });
    });

    // Outlet table
    const outletTable = $("outletTable");
    outletTable.innerHTML = `
      <thead>
        <tr>
          <th style="min-width:240px">Outlet</th>
          ${svcDatesHeader}
        </tr>
      </thead>
      <tbody>
        ${OUTLETS.map(o => {
          const cells = dates.map(d => {
            const row = outletByKey.get(`${d}|${o.key}`);
            const isOpen = !!row?.is_open;
            const cls = isOpen ? "green" : "red";

            const infoLeft = row?.updated_by_name || "—";
            const infoRight = row?.updated_at ? fmtToronto(row.updated_at) : "—";
            const hours = isOpen ? `${row?.open_time || "?"}–${row?.close_time || "?"}` : "Closed";

            return `
              <td>
                <div class="tile ${cls}" data-outlet="${o.key}" data-date="${d}">
                  <div class="tileInfo">
                    <span>${hours}</span>
                    <span>${infoRight}</span>
                  </div>
                </div>
                <div class="subtle" style="margin-top:6px">${infoLeft}</div>
              </td>
            `;
          }).join("");

          return `
            <tr>
              <td class="svcName">${o.key} <span class="subtle">(${o.editDept})</span></td>
              ${cells}
            </tr>
          `;
        }).join("")}
      </tbody>
    `;

    [...outletTable.querySelectorAll(".tile")].forEach(tile => {
      tile.addEventListener("click", async () => {
        const outlet = tile.getAttribute("data-outlet");
        const date = tile.getAttribute("data-date");
        await editOutletDay(outlet, date);
      });
    });
  }

  function getServiceUpdatedInfo(date, group, itemId){
    if(group === "massimo"){
      const r = massimoByKey.get(`${date}|${itemId}`);
      return { name: r?.updated_by_name || "—", at: r?.updated_at || null };
    }
    const sel = selectionByKey.get(`${date}|${group}`);
    // show who/when on every tile in that group (since only one selection per day)
    return { name: sel?.updated_by_name || "—", at: sel?.updated_at || null };
  }

  function isServiceGreen(date, group, itemId){
    if(group === "massimo"){
      const r = massimoByKey.get(`${date}|${itemId}`);
      return !!r?.is_active;
    }
    const sel = selectionByKey.get(`${date}|${group}`);
    return sel?.service_item_id === itemId;
  }

  async function onServiceClick(tile, isDouble){
    clearErr();
    if(!canEditRestaurants(profile)) return showErr("No permission to edit restaurant status.");

    const date = tile.getAttribute("data-date");
    const group = tile.getAttribute("data-group");
    const mode = tile.getAttribute("data-mode");
    const itemId = tile.getAttribute("data-item");

    // Massimo: multi select (toggle)
    if(mode === "multi"){
      const key = `${date}|${itemId}`;
      const current = massimoByKey.get(key);
      const next = isDouble ? false : !current?.is_active;

      const payload = {
        date,                     // IMPORTANT: always send date
        service_item_id: itemId,  // IMPORTANT
        is_active: next,
        updated_by: currentUser.id,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb.from("daily_massimo_status")
        .upsert(payload, { onConflict:"date,service_item_id" });

      if(error) return showErr(error.message);
      await loadAll();
      return;
    }

    // Breakfast/Lunch/Dinner: single selection per day
    if(isDouble){
      // clear = delete selection row for that day/group
      const { error } = await sb.from("daily_service_selection")
        .delete()
        .eq("date", date)
        .eq("group_name", group);

      if(error) return showErr(error.message);
      await loadAll();
      return;
    } else {
      // set selection
      const payload = {
        date,                 // IMPORTANT
        group_name: group,
        service_item_id: itemId,
        updated_by: currentUser.id,
        updated_at: new Date().toISOString()
      };

      const { error } = await sb.from("daily_service_selection")
        .upsert(payload, { onConflict:"date,group_name" });

      if(error) return showErr(error.message);
      await loadAll();
    }
  }

  async function editOutletDay(outletName, date){
    clearErr();

    // permission: lobby bar is F&B, others outlets, admin all
    const outletDef = OUTLETS.find(x => x.key === outletName);
    const deptNeeded = outletDef?.editDept;

    const allowed = (profile?.role === "admin")
      || (profile?.role === "user" && profile?.department === deptNeeded);

    if(!allowed) return showErr("No permission to edit this outlet.");

    const existing = outletByKey.get(`${date}|${outletName}`) || null;

    const isOpen = confirm(`${outletName} on ${date}\n\nOK = Open\nCancel = Closed`);
    let open_time = null, close_time = null;

    if(isOpen){
      open_time = prompt("Open time (e.g., 07:00 or 7:00 AM)", existing?.open_time || "");
      if(!open_time) return showErr("If open, you must enter open time.");
      close_time = prompt("Close time (e.g., 22:00 or 10:00 PM)", existing?.close_time || "");
      if(!close_time) return showErr("If open, you must enter close time.");
    }

    const payload = {
      date,                 // IMPORTANT
      outlet_name: outletName,
      is_open: isOpen,
      open_time,
      close_time,
      updated_by: currentUser.id,
      updated_at: new Date().toISOString()
    };

    const { error } = await sb.from("daily_outlet_hours")
      .upsert(payload, { onConflict:"date,outlet_name" });

    if(error) return showErr(error.message);
    await loadAll();
  }

  // ====== Users Admin ======
  async function renderUsersAdmin(){
    if(profile?.role !== "admin"){
      $("tabDash").click();
      return;
    }
    clearErr();

    const { data: users, error } = await sb.from("profiles")
      .select("user_id,email,name,role,department,is_active")
      .order("name", { ascending:true });

    if(error) return showErr(error.message);

    appRoot.innerHTML = `
      <div class="grid">
        <div class="card">
          <h3 class="sectionTitle">Admin – Users</h3>
          <div class="subtle">Select a user, then update name / role / department. (No UID shown.)</div>

          <div style="margin-top:12px" class="row">
            <div style="flex: 2 1 320px">
              <label>Select user</label>
              <select id="userPick">
                <option value="">— choose —</option>
                ${(users||[]).map(u => `<option value="${u.user_id}">${(u.name||u.email)} — ${u.email}</option>`).join("")}
              </select>
            </div>
            <div>
              <label>Role</label>
              <select id="uRole">
                <option value="admin">admin</option>
                <option value="user">user</option>
                <option value="viewer">viewer</option>
              </select>
            </div>
            <div>
              <label>Department</label>
              <select id="uDept">
                <option value="">(none)</option>
                <option value="Guest Service">Guest Service</option>
                <option value="F&B">F&amp;B</option>
                <option value="Outlets">Outlets</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <div style="flex:2 1 320px">
              <label>Full name</label>
              <input id="uName" type="text" placeholder="Full name" />
            </div>
            <div>
              <label>Active</label>
              <select id="uActive">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" id="btnUserSave">Save changes</button>
            <button class="btn secondary" id="btnUserReload">Reload list</button>
          </div>
        </div>

        <div class="card">
          <h3 class="sectionTitle">Current users</h3>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th>Name</th><th>Email</th><th>Role</th><th>Department</th><th>Active</th>
                </tr>
              </thead>
              <tbody>
                ${(users||[]).map(u => `
                  <tr>
                    <td>${u.name || "—"}</td>
                    <td>${u.email || "—"}</td>
                    <td>${u.role || "—"}</td>
                    <td>${u.department || "—"}</td>
                    <td>${String(u.is_active)}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    const userPick = $("userPick");
    function fill(u){
      $("uName").value = u?.name || "";
      $("uRole").value = u?.role || "viewer";
      $("uDept").value = u?.department || "";
      $("uActive").value = String(!!u?.is_active);
    }

    userPick.addEventListener("change", () => {
      const uid = userPick.value;
      const u = (users||[]).find(x => x.user_id === uid);
      fill(u);
    });

    $("btnUserReload").onclick = () => loadAll().catch(e => showErr(e?.message || String(e)));

    $("btnUserSave").onclick = async () => {
      clearErr();
      const uid = userPick.value;
      if(!uid) return showErr("Pick a user first.");

      const payload = {
        user_id: uid,
        name: $("uName").value.trim() || null,
        role: $("uRole").value,
        department: $("uDept").value || null,
        is_active: $("uActive").value === "true",
        updated_at: new Date().toISOString()
      };

      const { error } = await sb.from("profiles").upsert(payload, { onConflict:"user_id" });
      if(error) return showErr(error.message);

      await loadAll();
      $("tabUsers").click();
    };
  }

  // ====== PDF Snapshot (print window) ======
  function openPdfSnapshot(){
    clearErr();
    const dates = [];
    for(let i=0;i<DAYS;i++) dates.push(addDays(startDate, i));

    function pickSingleGroup(groupKey, title){
      const items = serviceItems.filter(x => x.group_name === groupKey).sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      return dates.map(d => {
        const sel = selectionByKey.get(`${d}|${groupKey}`);
        if(!sel?.service_item_id){
          return `<tr><td>${d}</td><td><b>${title} closed</b></td></tr>`;
        }
        const chosen = items.find(i => i.id === sel.service_item_id);
        return `<tr><td>${d}</td><td>${chosen?.name || "—"}</td></tr>`;
      }).join("");
    }

    function pickMassimo(){
      const items = serviceItems.filter(x => x.group_name === "massimo").sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
      return dates.map(d => {
        const actives = items.filter(i => massimoByKey.get(`${d}|${i.id}`)?.is_active);
        const text = actives.length ? actives.map(a => a.name).join(", ") : "Massimo closed";
        return `<tr><td>${d}</td><td>${text}</td></tr>`;
      }).join("");
    }

    function outletLines(){
      return OUTLETS.map(o => {
        const lines = dates.map(d => {
          const r = outletByKey.get(`${d}|${o.key}`);
          const open = !!r?.is_open;
          const txt = open ? `Open (${r?.open_time || "?"}–${r?.close_time || "?"})` : "Closed";
          return `<tr><td>${d}</td><td>${txt}</td></tr>`;
        }).join("");
        return `
          <h3>${o.key}</h3>
          <table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${lines}</tbody></table>
        `;
      }).join("");
    }

    const occLines = dates.map(d => {
      const r = forecastByDate.get(d);
      const pct = (r?.occupancy_pct === null || r?.occupancy_pct === undefined) ? "—" : (Number(r.occupancy_pct).toFixed(1) + "%");
      const ns = r?.notes_short ? ` — ${escapeHtml(r.notes_short)}` : "";
      return `<tr><td>${d}</td><td>${pct}${ns}</td></tr>`;
    }).join("");

    const html = `
      <!doctype html>
      <html><head>
        <meta charset="utf-8">
        <title>7-Day Snapshot</title>
        <style>
          body{font-family:Arial, sans-serif; padding:18px}
          h1{margin:0 0 6px 0}
          .sub{color:#555; margin:0 0 16px 0}
          table{border-collapse:collapse; width:100%; margin:8px 0 18px 0}
          th,td{border:1px solid #ccc; padding:8px; text-align:left; font-size:12px}
          th{background:#f2f2f2}
          h2{margin:18px 0 6px 0}
          h3{margin:14px 0 6px 0}
        </style>
      </head>
      <body>
        <h1>Sheraton Niagara Falls – 7-Day Snapshot</h1>
        <p class="sub">Start date: ${startDate} • Generated: ${new Date().toLocaleString("en-CA",{timeZone:TZ})} (Toronto time)</p>

        <h2>Occupancy</h2>
        <table><thead><tr><th>Date</th><th>Forecast</th></tr></thead><tbody>${occLines}</tbody></table>

        <h2>Restaurants</h2>
        <h3>Breakfast</h3>
        <table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${pickSingleGroup("breakfast","Breakfast")}</tbody></table>

        <h3>Lunch</h3>
        <table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${pickSingleGroup("lunch","Lunch")}</tbody></table>

        <h3>Dinner</h3>
        <table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${pickSingleGroup("dinner","Dinner")}</tbody></table>

        <h3>Massimo</h3>
        <table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${pickMassimo()}</tbody></table>

        <h2>Lobby Bar & Outlets</h2>
        ${outletLines()}

        <script>
          window.onload = () => setTimeout(() => window.print(), 200);
        </script>
      </body></html>
    `;

    const w = window.open("", "_blank");
    if(!w) return showErr("Pop-up blocked. Allow pop-ups for this site.");
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ====== Boot ======
  async function onAuthChanged(){
    clearErr();
    const { data } = await sb.auth.getUser();
    const user = data?.user || null;

    if(!user){
      authRoot.style.display = "flex";
      appRoot.style.display = "none";
      return;
    }
    authRoot.style.display = "none";
    appRoot.style.display = "block";

    startDate = $("startDate").value || startDate;
    await loadAll();
  }

  // Guard: no supabase
  if(!sb){
    authRoot.style.display = "flex";
    appRoot.style.display = "none";
    showErr("Supabase client not found. Make sure supabase.js is in the repo root.");
    return;
  }

  sb.auth.onAuthStateChange(() => onAuthChanged());
  onAuthChanged().catch(e => showErr(e?.message || String(e)));
})();
</script>
</body>
</html>

      
