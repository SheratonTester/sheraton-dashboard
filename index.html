<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheraton Niagara Falls - Dashboard</title>
  <style>
    :root { --bg:#0b0f14; --card:#121925; --muted:#9bb0c8; --text:#e8f0fb; --line:#223247; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .banner { padding:10px 12px; border:1px dashed #3a5d8a; border-radius:12px; color:#bcd3ee; margin-bottom:12px; }
    .card { background: var(--card); border:1px solid var(--line); border-radius: 14px; padding: 14px; }
    .box { max-width: 520px; margin: 16px auto; }
    h2 { margin:0 0 10px; font-size: 18px; }
    .small { font-size: 12px; color: var(--muted); }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, button {
      background:#0f1622; color:var(--text);
      border:1px solid var(--line); border-radius:10px;
      padding:10px 12px; font-size:14px; width:100%;
    }
    button { cursor:pointer; margin-top: 12px; width:auto; padding:10px 14px; }
    .btn-primary { background:#173254; border-color:#2a4d78; }
    .btn-primary:hover { background:#1b3b63; }
    .btn-danger { background:#3a1720; border-color:#6e2a3a; }
    .btn-danger:hover { background:#4a1d28; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .msg { margin-top: 10px; font-size: 13px; color: var(--muted); }
    .err { color:#ff8a8a; }
    .ok { color:#98f5b2; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="banner">
      Password reset should work on this page now.
      <div class="small">If you click a reset link, you should see “Set new password”.</div>
    </div>

    <div id="bootMsg" class="msg"></div>

    <!-- LOGIN -->
    <div id="loginView" class="box card" style="display:none;">
      <h2>Sign in</h2>
      <div class="small">Sheraton Niagara Falls Dashboard</div>

      <label>Email</label>
      <input id="email" type="email" placeholder="name@niagarafallshotels.com" />

      <label>Password</label>
      <input id="password" type="password" placeholder="••••••••" />

      <div class="row">
        <button id="btnLogin" class="btn-primary">Sign in</button>
        <button id="btnForgot" class="btn-danger" title="Send reset email">Forgot password</button>
      </div>

      <div id="loginMsg" class="msg"></div>
    </div>

    <!-- RECOVERY -->
    <div id="recoveryView" class="box card" style="display:none;">
      <h2>Set new password</h2>
      <div class="small">You opened a password reset link. Set the new password below.</div>

      <label>New password</label>
      <input id="newPass" type="password" placeholder="New password" />

      <label>Confirm new password</label>
      <input id="newPass2" type="password" placeholder="Confirm new password" />

      <div class="row">
        <button id="btnSetPass" class="btn-primary">Update password</button>
        <button id="btnCancelRecovery" class="btn-danger">Cancel</button>
      </div>

      <div id="recoveryMsg" class="msg"></div>
    </div>

    <!-- APP (placeholder for now) -->
    <div id="appView" class="box card" style="display:none;">
      <h2>Logged in</h2>
      <div class="small">Auth is working. Next we re-add the full dashboard.</div>

      <div class="row" style="margin-top:12px;">
        <button id="btnLogout" class="btn-danger">Logout</button>
      </div>

      <div id="appMsg" class="msg"></div>
    </div>
  </div>

  <!-- Local Supabase library (must exist in repo root) -->
  <script src="./supabase.js"></script>

  <script>
    const SUPABASE_URL = "https://jiarjsvoumbbilfsqftj.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_AB6JsEiTT1V5Bu5ANA0Qmw_yFE8M0NV";

    const bootMsg = document.getElementById("bootMsg");
    const loginView = document.getElementById("loginView");
    const recoveryView = document.getElementById("recoveryView");
    const appView = document.getElementById("appView");

    const loginMsg = document.getElementById("loginMsg");
    const recoveryMsg = document.getElementById("recoveryMsg");

    function setMsg(el, text, type="") {
      el.className = "msg " + (type === "err" ? "err" : type === "ok" ? "ok" : "");
      el.textContent = text || "";
    }

    function show(view) {
      loginView.style.display = "none";
      recoveryView.style.display = "none";
      appView.style.display = "none";
      view.style.display = "block";
    }

    function cleanUrl() {
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    }

    function parseHashParams() {
      const h = window.location.hash.startsWith("#") ? window.location.hash.slice(1) : window.location.hash;
      const p = new URLSearchParams(h);
      return {
        type: p.get("type"),
        access_token: p.get("access_token"),
        refresh_token: p.get("refresh_token")
      };
    }

    async function handleRecoveryLink(sb) {
      // Old style: #access_token=...&refresh_token=...&type=recovery
      const hp = parseHashParams();
      if (hp.type === "recovery" && hp.access_token && hp.refresh_token) {
        const { error } = await sb.auth.setSession({
          access_token: hp.access_token,
          refresh_token: hp.refresh_token
        });
        if (error) {
          setMsg(bootMsg, "Reset link error: " + error.message, "err");
          show(loginView);
          return true;
        }
        cleanUrl();
        show(recoveryView);
        return true;
      }

      // PKCE style: ?code=...&type=recovery
      const sp = new URLSearchParams(window.location.search);
      const code = sp.get("code");
      const type = sp.get("type");
      if (type === "recovery" && code) {
        const { error } = await sb.auth.exchangeCodeForSession(code);
        if (error) {
          setMsg(bootMsg, "Reset link error: " + error.message, "err");
          show(loginView);
          return true;
        }
        cleanUrl();
        show(recoveryView);
        return true;
      }

      return false;
    }

    async function init() {
      if (!window.supabase || !window.supabase.createClient) {
        setMsg(bootMsg, "Supabase library did not load. Make sure supabase.js is in the repo root.", "err");
        return;
      }

      // IMPORTANT: do NOT name this variable "supabase"
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setMsg(bootMsg, "");

      // If opened from reset link
      const didRecovery = await handleRecoveryLink(sb);
      if (didRecovery) return;

      // Normal session check
      const { data } = await sb.auth.getSession();
      if (data?.session?.user) show(appView);
      else show(loginView);

      // LOGIN
      document.getElementById("btnLogin").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        if (!email || !password) return setMsg(loginMsg, "Enter email and password.", "err");

        try {
          setMsg(loginMsg, "Signing in…");
          const { error } = await sb.auth.signInWithPassword({ email, password });
          if (error) throw error;
          setMsg(loginMsg, "", "");
          show(appView);
        } catch (e) {
          setMsg(loginMsg, e.message || String(e), "err");
        }
      });

      // FORGOT PASSWORD
      document.getElementById("btnForgot").addEventListener("click", async () => {
        const email = document.getElementById("email").value.trim();
        if (!email) return setMsg(loginMsg, "Enter your email first, then click Forgot password.", "err");

        try {
          setMsg(loginMsg, "Sending reset email…");
          const { error } = await sb.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + window.location.pathname
          });
          if (error) throw error;
          setMsg(loginMsg, "Reset email sent. Click the link in the email to set a new password.", "ok");
        } catch (e) {
          setMsg(loginMsg, e.message || String(e), "err");
        }
      });

      // SET NEW PASSWORD
      document.getElementById("btnSetPass").addEventListener("click", async () => {
        const p1 = document.getElementById("newPass").value;
        const p2 = document.getElementById("newPass2").value;

        if (!p1 || p1.length < 6) return setMsg(recoveryMsg, "Password must be at least 6 characters.", "err");
        if (p1 !== p2) return setMsg(recoveryMsg, "Passwords do not match.", "err");

        try {
          setMsg(recoveryMsg, "Updating password…");
          const { error } = await sb.auth.updateUser({ password: p1 });
          if (error) throw error;

          setMsg(recoveryMsg, "Password updated. Please sign in with the new password.", "ok");
          await sb.auth.signOut();
          show(loginView);
        } catch (e) {
          setMsg(recoveryMsg, e.message || String(e), "err");
        }
      });

      document.getElementById("btnCancelRecovery").addEventListener("click", async () => {
        await sb.auth.signOut();
        cleanUrl();
        show(loginView);
      });

      document.getElementById("btnLogout").addEventListener("click", async () => {
        await sb.auth.signOut();
        show(loginView);
      });
    }

    init().catch(err => setMsg(bootMsg, "Startup error: " + (err?.message || String(err)), "err"));
  </script>
</body>
</html>
