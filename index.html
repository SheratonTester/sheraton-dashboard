// =====================
// 7-DAY PDF SNAPSHOT (no external libs)
// =====================

(function attachPdfButton(){
  const btn = document.getElementById("btnPdfSnapshot");
  if (btn) btn.addEventListener("click", download7DaySnapshotPdf);
})();

function torontoNowString(){
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Toronto",
    year: "numeric", month: "short", day: "2-digit",
    hour: "2-digit", minute: "2-digit"
  }).format(new Date());
}

function fmtTorontoDayLabel(yyyy_mm_dd){
  // Treat as date key; show a nice label in Toronto time
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0)); // midday UTC to avoid day shift
  return new Intl.DateTimeFormat("en-CA", {
    timeZone: "America/Toronto",
    weekday: "short", year:"numeric", month:"short", day:"2-digit"
  }).format(dt);
}

function addDays(yyyy_mm_dd, n){
  const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
  const dt = new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  dt.setUTCDate(dt.getUTCDate() + n);
  const yy = dt.getUTCFullYear();
  const mm = String(dt.getUTCMonth()+1).padStart(2,"0");
  const dd = String(dt.getUTCDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}

function fmtTime12(timeStr){
  if (!timeStr) return "";
  // expects "HH:MM" or "HH:MM:SS"
  const parts = timeStr.split(":");
  if (parts.length < 2) return "";
  let hh = parseInt(parts[0],10);
  const mm = parts[1].padStart(2,"0");
  const ampm = hh >= 12 ? "PM" : "AM";
  hh = hh % 12; if (hh === 0) hh = 12;
  return `${hh}:${mm} ${ampm}`;
}

function pdfEscape(s){
  return String(s ?? "")
    .replace(/\\/g, "\\\\")
    .replace(/\(/g, "\\(")
    .replace(/\)/g, "\\)")
    .replace(/[^\x09\x0A\x0D\x20-\x7E]/g, "?");
}

function buildSimplePdfFromLines(lines){
  // Very small PDF generator: text only, multi-page if needed.
  const pageW = 612, pageH = 792;
  const marginL = 48, marginT = 56;
  const lineH = 14;
  const maxLinesPerPage = Math.floor((pageH - marginT - 48) / lineH);

  const pages = [];
  for (let i=0; i<lines.length; i+=maxLinesPerPage){
    pages.push(lines.slice(i, i+maxLinesPerPage));
  }

  let objects = [];
  function addObj(str){ objects.push(str); return objects.length; }

  // 1) Catalog, 2) Pages, 3.. pages, plus font + contents
  const fontObjId = addObj(`<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>`);

  const pageObjIds = [];
  const contentObjIds = [];

  for (let p=0; p<pages.length; p++){
    const pageLines = pages[p];

    // Build content stream
    let content = [];
    content.push("BT");
    content.push(`/F1 11 Tf`);
    // Start near top-left
    content.push(`${marginL} ${pageH - marginT} Td`);

    for (let i=0; i<pageLines.length; i++){
      const t = pdfEscape(pageLines[i]);
      if (i === 0) {
        content.push(`(${t}) Tj`);
      } else {
        content.push(`0 -${lineH} Td (${t}) Tj`);
      }
    }
    content.push("ET");

    const contentStream = content.join("\n");
    const contentObjId = addObj(
      `<< /Length ${contentStream.length} >>\nstream\n${contentStream}\nendstream`
    );
    contentObjIds.push(contentObjId);

    const pageObjId = addObj(
      `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW} ${pageH}] ` +
      `/Resources << /Font << /F1 ${fontObjId} 0 R >> >> ` +
      `/Contents ${contentObjId} 0 R >>`
    );
    pageObjIds.push(pageObjId);
  }

  // Pages object must be #2, so we’ll insert placeholders:
  // Build final object list carefully:
  // We'll rebuild in proper order:
  const fontObj = objects[fontObjId-1];

  // Recreate objects array in correct order:
  const rebuilt = [];
  const offsets = [];

  function pushObj(objStr){ rebuilt.push(objStr); }

  // 1 Catalog (points to 2)
  pushObj(`<< /Type /Catalog /Pages 2 0 R >>`);

  // 2 Pages
  pushObj(`<< /Type /Pages /Kids [${pageObjIds.map(id=>`${id} 0 R`).join(" ")}] /Count ${pageObjIds.length} >>`);

  // Font object (keep same number? We’ll just append; numbering changes, so rebuild ids)
  // To keep it simple: rebuild everything with fresh ids.
  // We'll do a second pass with consistent IDs.

  // ---- Second pass, consistent IDs ----
  const objs2 = [];
  const add2 = (s)=>{ objs2.push(s); return objs2.length; };

  const catalogId = add2(`<< /Type /Catalog /Pages 2 0 R >>`);
  // placeholder pages (#2) after we know kids ids
  add2(`<< >>`);

  const fontId2 = add2(fontObj);

  const contentIds2 = [];
  const pageIds2 = [];

  // contents
  for (let p=0; p<pages.length; p++){
    const pageLines = pages[p];
    let content = [];
    content.push("BT");
    content.push(`/F1 11 Tf`);
    content.push(`${marginL} ${pageH - marginT} Td`);
    for (let i=0; i<pageLines.length; i++){
      const t = pdfEscape(pageLines[i]);
      if (i === 0) content.push(`(${t}) Tj`);
      else content.push(`0 -${lineH} Td (${t}) Tj`);
    }
    content.push("ET");
    const cs = content.join("\n");
    contentIds2.push(add2(`<< /Length ${cs.length} >>\nstream\n${cs}\nendstream`));
  }

  // pages
  for (let p=0; p<pages.length; p++){
    pageIds2.push(add2(
      `<< /Type /Page /Parent 2 0 R /MediaBox [0 0 ${pageW} ${pageH}] ` +
      `/Resources << /Font << /F1 ${fontId2} 0 R >> >> ` +
      `/Contents ${contentIds2[p]} 0 R >>`
    ));
  }

  // fill in Pages object (#2)
  objs2[1] = `<< /Type /Pages /Kids [${pageIds2.map(id=>`${id} 0 R`).join(" ")}] /Count ${pageIds2.length} >>`;

  // Build PDF bytes with xref
  let pdf = `%PDF-1.4\n`;
  const xref = [];
  xref.push("0000000000 65535 f \n");

  for (let i=0; i<objs2.length; i++){
    const offset = pdf.length;
    xref.push(String(offset).padStart(10,"0") + " 00000 n \n");
    pdf += `${i+1} 0 obj\n${objs2[i]}\nendobj\n`;
  }

  const xrefOffset = pdf.length;
  pdf += `xref\n0 ${objs2.length+1}\n` + xref.join("") +
         `trailer\n<< /Size ${objs2.length+1} /Root 1 0 R >>\nstartxref\n${xrefOffset}\n%%EOF`;

  return new Uint8Array(Array.from(pdf).map(ch => ch.charCodeAt(0)));
}

async function download7DaySnapshotPdf(){
  try{
    // You should already have a supabase client in your file.
    // This function expects your existing client variable is named `supabase`.
    if (typeof supabase === "undefined") throw new Error("Supabase client not found.");

    // Start date input: adjust this ID if yours is different
    const startEl = document.getElementById("startDate");
    const startDate = startEl?.value || new Date().toISOString().slice(0,10);

    const days = Array.from({length:7}, (_,i)=>addDays(startDate, i));
    const dayMin = days[0];
    const dayMax = addDays(startDate, 7); // exclusive upper bound for filtering if needed

    // Load service items
    const { data: serviceItems, error: siErr } = await supabase
      .from("service_items")
      .select("id,name,group_name");
    if (siErr) throw siErr;

    const byId = new Map((serviceItems||[]).map(r => [String(r.id), r]));

    // Load selections (breakfast/lunch/dinner)
    const { data: selections, error: selErr } = await supabase
      .from("daily_service_selection")
      .select("date,group_name,service_item_id,updated_at")
      .gte("date", dayMin)
      .lte("date", days[6]);
    if (selErr) throw selErr;

    // Map: (date|group) -> service_item_id
    const selMap = new Map();
    (selections||[]).forEach(r => {
      selMap.set(`${r.date}|${r.group_name}`, r.service_item_id ? String(r.service_item_id) : null);
    });

    // Massimo (multi on)
    const { data: massimo, error: mErr } = await supabase
      .from("daily_massimo_status")
      .select("date,service_item_id,is_active")
      .gte("date", dayMin)
      .lte("date", days[6]);
    if (mErr) throw mErr;

    const massimoOn = new Map(); // date -> [names]
    (massimo||[]).forEach(r=>{
      if (!r.is_active) return;
      const item = byId.get(String(r.service_item_id));
      if (!item) return;
      const arr = massimoOn.get(r.date) || [];
      arr.push(item.name.replace("MASSIMO ",""));
      massimoOn.set(r.date, arr);
    });

    // Outlets/Lobby bar hours
    const { data: outletRows, error: oErr } = await supabase
      .from("daily_outlet_hours")
      .select("date,outlet_name,is_open,open_time,close_time")
      .gte("date", dayMin)
      .lte("date", days[6]);
    if (oErr) throw oErr;

    const outletMap = new Map(); // (date|outlet) -> row
    (outletRows||[]).forEach(r => outletMap.set(`${r.date}|${r.outlet_name}`, r));

    function selectedOrClosed(date, group){
      const id = selMap.get(`${date}|${group}`);
      if (!id) return `${cap(group)} closed`;
      const item = byId.get(String(id));
      return item?.name || `${cap(group)} open`;
    }

    function cap(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }

    function outletStatus(date, name){
      const row = outletMap.get(`${date}|${name}`);
      if (!row) return "Closed";
      if (!row.is_open) return "Closed";
      const ot = fmtTime12(row.open_time);
      const ct = fmtTime12(row.close_time);
      if (!ot || !ct) return "Open (hours missing)";
      return `Open ${ot}–${ct}`;
    }

    // Build PDF lines
    const lines = [];
    lines.push("Sheraton Niagara Falls – 7-Day Snapshot");
    lines.push(`Start date: ${dayMin}`);
    lines.push(`Generated: ${torontoNowString()} (Toronto time)`);
    lines.push(" ");

    for (const d of days){
      lines.push(`${fmtTorontoDayLabel(d)}  [${d}]`);
      lines.push(`  Breakfast: ${selectedOrClosed(d,"breakfast")}`);
      lines.push(`  Lunch: ${selectedOrClosed(d,"lunch")}`);
      lines.push(`  Dinner: ${selectedOrClosed(d,"dinner")}`);

      const m = (massimoOn.get(d) || []);
      lines.push(`  Massimo: ${m.length ? m.join(", ") : "Massimo closed"}`);

      lines.push(`  Lobby Bar: ${outletStatus(d,"LOBBY BAR")}`);
      lines.push(`  Starbucks: ${outletStatus(d,"STARBUCKS")}`);
      lines.push(`  Sweet Jesus: ${outletStatus(d,"SWEET JESUS")}`);
      lines.push(`  Freshii: ${outletStatus(d,"FRESHII")}`);
      lines.push(" ");
    }

    const pdfBytes = buildSimplePdfFromLines(lines);
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `Sheraton_7Day_Snapshot_${dayMin}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  } catch (e){
    console.error(e);
    alert(e?.message || String(e));
  }
}
