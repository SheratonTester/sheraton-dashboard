<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sheraton Tools - Home</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow: 0 14px 40px rgba(15,23,42,.10);
      --radius:18px;
      --blue:#2563eb;
      --green:#16a34a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 10% 0%, #e9efff 0%, rgba(233,239,255,0) 60%),
        radial-gradient(900px 600px at 90% 10%, #e9fff6 0%, rgba(233,255,246,0) 55%),
        var(--bg);
      min-height:100vh;
    }
    header{
      max-width:1100px;
      margin:0 auto;
      padding:22px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      box-shadow: var(--shadow);
    }
    h1{ margin:0; font-size:18px; }
    .subtitle{ margin-top:2px; font-size:12px; color:var(--muted); }

    .pill{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:#fff;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot{ width:8px;height:8px;border-radius:50%; background:#94a3b8; }
    .dot.ok{ background: var(--green); }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:10px 18px 34px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.9);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card-title strong{ font-size:14px; }
    .card-title span{ display:block; font-size:12px; color:var(--muted); margin-top:4px; }

    .card-body{ padding:14px; }

    .error{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#9f1239;
      font-size:13px;
      white-space:pre-wrap;
    }
    .ok{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #bbf7d0;
      background:#f0fdf4;
      color:#166534;
      font-size:13px;
      white-space:pre-wrap;
    }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:11px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus{ border-color: rgba(37,99,235,.55); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 800px){
      .grid{ grid-template-columns: 1fr; }
    }

    button, a.btnlink{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:11px 12px;
      border-radius:12px;
      font-size:14px;
      cursor:pointer;
      transition: transform .04s ease, background .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    button:hover, a.btnlink:hover{ background:#f8fafc; }
    button:active, a.btnlink:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border-color: transparent;
      color:#fff;
      font-weight:650;
    }
    .primary:hover{ background: linear-gradient(135deg, #1d4ed8, #1e40af); }

    .ghost{ color:var(--muted); }
    .linklike{
      background:none;
      border:none;
      padding:0;
      cursor:pointer;
      color:var(--blue);
      font-size:13px;
    }

    .menuBtn{
      padding:16px;
      border-radius:16px;
      align-items:flex-start;
      justify-content:flex-start;
      text-align:left;
      gap:10px;
    }
    .menuBtn strong{ display:block; font-size:14px; }
    .menuBtn span{ display:block; font-size:12px; color:var(--muted); margin-top:3px; }
    .icon{
      width:34px;height:34px;border-radius:12px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(37,99,235,.12);
      border:1px solid rgba(37,99,235,.18);
      color:#1d4ed8;
      flex:0 0 auto;
    }

    .hide{ display:none !important; }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Sheraton Tools</h1>
      <div class="subtitle">Home menu + login</div>
    </div>
  </div>

  <span class="pill" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">Loading‚Ä¶</span></span>
</header>

<div class="wrap">
  <section class="card">
    <div class="card-head">
      <div class="card-title">
        <strong>Account</strong>
        <span id="whoLine">Checking session‚Ä¶</span>
      </div>
      <div class="row">
        <button class="ghost" id="btnSignOut" style="display:none;">Sign out</button>
      </div>
    </div>

    <div class="error" id="errorBox"></div>
    <div class="ok" id="okBox"></div>

    <div class="card-body">
      <!-- LOGGED OUT -->
      <div id="loggedOut">
        <div class="grid">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" autocomplete="username" placeholder="name@company.com">
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="primary" id="btnLogin">Sign in</button>
          <button class="linklike" id="btnForgot" type="button">Forgot password?</button>
        </div>

        <!-- Forgot password panel -->
        <div id="forgotPanel" class="hide" style="margin-top:12px;">
          <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">
            Enter your email and we‚Äôll send a reset link.
          </div>
          <div class="grid">
            <div style="grid-column: 1 / -1;">
              <label for="fpEmail">Email</label>
              <input id="fpEmail" type="email" autocomplete="username" placeholder="name@company.com">
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="primary" id="btnSendReset" type="button">Send reset email</button>
            <button id="btnCancelForgot" type="button">Cancel</button>
          </div>
        </div>
      </div>

      <!-- LOGGED IN -->
      <div id="loggedIn" class="hide">
        <div class="grid">
          <a class="btnlink menuBtn" href="fnb-outlets.html">
            <span class="icon">üçΩÔ∏è</span>
            <div>
              <strong>F&B Outlets</strong>
              <span>Breakfast/Lunch/Dinner selection + outlets hours</span>
            </div>
          </a>

          <button class="menuBtn btnlink" id="btnPlaceholder" type="button">
            <span class="icon">üìä</span>
            <div>
              <strong>Dashboard (coming next)</strong>
              <span>This is a placeholder button for your next pages</span>
            </div>
          </button>
        </div>

        <div style="margin-top:12px; font-size:12px; color:var(--muted);">
          Tip: Use the Home button inside each page to come back here.
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Scripts (order matters) -->
<script src="./vendor/supabase-js.iife.min.js?v=6"></script>
<script src="./supabase.js?v=6"></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function showErr(msg){
    const b = $("errorBox");
    b.textContent = msg;
    b.style.display = "block";
    $("okBox").style.display = "none";
  }
  function showOk(msg){
    const b = $("okBox");
    b.textContent = msg;
    b.style.display = "block";
    $("errorBox").style.display = "none";
  }
  function clearMsgs(){
    $("errorBox").style.display = "none";
    $("okBox").style.display = "none";
  }

  async function waitForSB(){
    const start = Date.now();
    while(!window.sb){
      if(Date.now() - start > 5000) break;
      await new Promise(r => setTimeout(r, 50));
    }
    if(!window.sb) throw new Error("Supabase client not loaded (window.sb). Check ./supabase.js and vendor file paths.");
  }

  function setStatus(text, ok){
    $("statusText").textContent = text;
    $("statusDot").classList.toggle("ok", !!ok);
  }

  async function getSession(){
    const { data, error } = await window.sb.auth.getSession();
    if(error) throw error;
    return data.session || null;
  }

  async function loadProfile(userId){
    const { data, error } = await window.sb
      .from("profiles")
      .select("user_id, full_name, role, department, is_active")
      .eq("user_id", userId)
      .maybeSingle();
    if(error) throw error;
    return data || null;
  }

  function showLoggedInUI(profile, user){
    $("loggedOut").classList.add("hide");
    $("loggedIn").classList.remove("hide");
    $("btnSignOut").style.display = "inline-flex";

    const name = (profile?.full_name || "").trim() || user.email || "Signed in";
    const role = profile?.role || "user";
    const dept = profile?.department ? ` ‚Ä¢ ${profile.department}` : "";
    $("whoLine").textContent = `${name} (${role}${dept})`;
    setStatus("Signed in", true);
  }

  function showLoggedOutUI(){
    $("loggedIn").classList.add("hide");
    $("loggedOut").classList.remove("hide");
    $("btnSignOut").style.display = "none";
    $("whoLine").textContent = "Sign in to continue";
    setStatus("Signed out", false);
  }

  async function init(){
    try{
      setStatus("Loading‚Ä¶", false);
      await waitForSB();

      const session = await getSession();
      if(!session){
        showLoggedOutUI();
        return;
      }

      const profile = await loadProfile(session.user.id);
      showLoggedInUI(profile, session.user);
    }catch(e){
      console.error(e);
      setStatus("Error", false);
      showErr(e.message || String(e));
      showLoggedOutUI();
    }
  }

  // Login
  $("btnLogin").addEventListener("click", async () => {
    try{
      clearMsgs();
      const email = $("email").value.trim();
      const password = $("password").value;

      if(!email || !password){
        showErr("Enter email and password.");
        return;
      }

      const { error } = await window.sb.auth.signInWithPassword({ email, password });
      if(error) throw error;

      showOk("Signed in.");
      await init();
    }catch(e){
      showErr(e.message || String(e));
    }
  });

  // Forgot password
  $("btnForgot").addEventListener("click", () => {
    $("fpEmail").value = $("email").value.trim();
    $("forgotPanel").classList.remove("hide");
  });
  $("btnCancelForgot").addEventListener("click", () => {
    $("forgotPanel").classList.add("hide");
  });

  $("btnSendReset").addEventListener("click", async () => {
    try{
      clearMsgs();
      const email = $("fpEmail").value.trim();
      if(!email){
        showErr("Enter your email.");
        return;
      }

      // Redirect back here after clicking reset link
      const redirectTo = window.location.origin + window.location.pathname;

      const { error } = await window.sb.auth.resetPasswordForEmail(email, { redirectTo });
      if(error) throw error;

      showOk("Reset email sent. Check your inbox.");
    }catch(e){
      showErr(e.message || String(e));
    }
  });

  // If landing from a recovery link, let user set a new password via prompt
  // (simple + fast; we can make a nicer UI later)
  async function handleRecoveryLink(){
    const url = new URL(window.location.href);
    const type = (url.searchParams.get("type") || "").toLowerCase();
    const hash = new URLSearchParams((url.hash || "").replace(/^#/, ""));
    const hType = (hash.get("type") || "").toLowerCase();

    if(type === "recovery" || hType === "recovery"){
      const p1 = prompt("Set your new password (min 6 chars):");
      if(!p1) return;
      if(p1.length < 6){
        showErr("Password must be at least 6 characters.");
        return;
      }
      const p2 = prompt("Confirm new password:");
      if(p1 !== p2){
        showErr("Passwords do not match.");
        return;
      }
      const { error } = await window.sb.auth.updateUser({ password: p1 });
      if(error) throw error;

      // Clean URL
      window.history.replaceState({}, document.title, url.origin + url.pathname);
      showOk("Password updated. You can sign in now.");
    }
  }

  // Sign out
  $("btnSignOut").addEventListener("click", async () => {
    await window.sb.auth.signOut();
    showLoggedOutUI();
    showOk("Signed out.");
  });

  // Placeholder
  $("btnPlaceholder").addEventListener("click", () => {
    alert("Dashboard page coming next.");
  });

  (async () => {
    await init();
    // only after init so sb exists
    try{ await handleRecoveryLink(); }catch(e){ showErr(e.message || String(e)); }
  })();
})();
</script>
</body>
</html>
