<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F&B Outlets</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius:18px;

      --green:#16a34a;
      --greenSoft: rgba(22,163,74,.12);
      --red:#dc2626;
      --redSoft: rgba(220,38,38,.10);
      --blue:#2563eb;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 10% 0%, #e9efff 0%, rgba(233,239,255,0) 60%),
        radial-gradient(900px 600px at 90% 10%, #e9fff6 0%, rgba(233,255,246,0) 55%),
        var(--bg);
    }
    header{ padding:22px 18px 10px; max-width:1320px; margin:0 auto; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      box-shadow: var(--shadow);
    }
    h1{ font-size:18px; margin:0; line-height:1.2; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:2px; }

    .pill{
      font-size:12px; padding:6px 10px; border:1px solid var(--line);
      border-radius:999px; background:#fff; color:var(--muted);
    }
    .wrap{ max-width:1320px; margin:0 auto; padding:10px 18px 34px; }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    input[type="date"]{
      border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; font-size:13px; outline:none; background:#fff;
    }

    button, a.btnlink{
      border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:13px; cursor:pointer;
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    button:hover, a.btnlink:hover{ background:#f8fafc; }
    button:active, a.btnlink:active{ transform: translateY(1px); }
    .primary{
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border-color: transparent; color:#fff; font-weight:650;
    }
    .primary:hover{ background: linear-gradient(135deg, #1d4ed8, #1e40af); }
    .small{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .muted-btn{ color:var(--muted); }

    .grid2{ display:grid; grid-template-columns: 1fr; gap:14px; }

    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.9);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card-title strong{ font-size:14px; }
    .card-title span{ display:block; font-size:12px; color:var(--muted); margin-top:4px; }

    .status{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--muted); }
    .dot{ width:8px; height:8px; border-radius:50%; background:#94a3b8; }
    .dot.ok{ background:#22c55e; }
    .dot.warn{ background:#f59e0b; }

    .error{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#9f1239;
      font-size:13px;
      white-space:pre-wrap;
    }

    .sheet{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:auto;
      max-height: 70vh;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:3;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      padding:10px 10px;
      text-align:center;
      white-space:nowrap;
    }
    thead th:first-child{
      position:sticky;
      left:0;
      z-index:4;
      text-align:left;
    }
    tbody td, tbody th{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:8px;
      vertical-align:middle;
    }
    tbody tr:last-child td, tbody tr:last-child th{ border-bottom:none; }
    tbody td:last-child, thead th:last-child{ border-right:none; }

    tbody th{
      position:sticky;
      left:0;
      z-index:2;
      background:#fff;
      text-align:left;
      font-size:13px;
      font-weight:650;
      min-width: 260px;
    }
    .row-sub{
      font-size:12px;
      font-weight:500;
      color:var(--muted);
      margin-top:2px;
    }

    .cellbtn{
      width:100%;
      min-height:46px;
      border-radius:12px;
      border:1px solid rgba(226,232,240,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 10px;
      user-select:none;
      transition: transform .04s ease, filter .15s ease, border-color .15s ease;
      font-size:12px;
      text-align:center;
      line-height:1.15;
      background:#fff;
    }
    .cellbtn:active{ transform: translateY(1px); }
    .cellbtn.green{
      background: var(--greenSoft);
      border-color: rgba(22,163,74,.45);
      color: #14532d;
    }
    .cellbtn.red{
      background: var(--redSoft);
      border-color: rgba(220,38,38,.35);
      color: #7f1d1d;
    }
    .cellbtn .tiny{
      display:block;
      font-size:11px;
      color: rgba(15,23,42,.65);
      margin-top:3px;
    }

    .section-sep{
      margin:12px 0 8px;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .section-sep:before, .section-sep:after{
      content:"";
      height:1px;
      flex:1;
      background: var(--line);
    }

    /* Modal (shared) */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid rgba(226,232,240,.9);
      box-shadow: 0 30px 80px rgba(15,23,42,.25);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .modal-head strong{ font-size:14px; }
    .modal-head .sub{ font-size:12px; color:var(--muted); margin-top:3px; }
    .modal-body{ padding:12px 14px 14px; }
    .modal-foot{
      padding:12px 14px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      background: linear-gradient(180deg, #ffffff, #fbfdff);
    }
    .field{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    input[type="time"], input[type="number"], textarea{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      width:100%;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    .toggleRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-bottom:12px;
    }
    .switch{ position:relative; width:44px; height:24px; display:inline-block; flex:0 0 auto; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background:#e2e8f0;
      border-radius:999px;
      transition:.15s ease;
      border:1px solid #cbd5e1;
    }
    .slider:before{
      content:"";
      position:absolute;
      height:18px; width:18px;
      left:3px; top:2px;
      background:#fff;
      border-radius:50%;
      box-shadow: 0 4px 10px rgba(15,23,42,.15);
      transition:.15s ease;
    }
    .switch input:checked + .slider{
      background: rgba(22,163,74,.25);
      border-color: rgba(22,163,74,.45);
    }
    .switch input:checked + .slider:before{ transform: translateX(20px); }
    .hint{ font-size:12px; color:var(--muted); }

    .weekGrid{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:auto;
      max-height:55vh;
      background:#fff;
    }
    .weekGrid table{ min-width: 900px; }
    .weekGrid th{ position:sticky; left:0; background:#fff; z-index:2; }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>F&B Outlets</h1>
        <div class="subtitle">Meals: click select, double-click green to clear. Outlets: times required when open. Occupancy: edit day or week.</div>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <!-- cache-busted Home so you don't get old index redirect -->
      <a class="btnlink small" href="./index.html?v=7">← Home</a>
      <span class="pill" id="whoami">Loading…</span>
      <button class="muted-btn small" id="btnSignOut" style="display:none;">Sign out</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="toolbar">
    <div class="controls">
      <button class="small" id="btnPrev">← Prev 7</button>
      <button class="small" id="btnToday">Today</button>
      <button class="small" id="btnNext">Next 7 →</button>
      <input type="date" id="datePick" />
      <button class="small" id="btnEditWeekOcc">Edit 7-day occupancy</button>
    </div>

    <div class="controls">
      <span class="status"><span class="dot" id="dotState"></span><span id="statusText">Loading…</span></span>
      <span class="pill" id="rangeLabel"></span>
      <span class="pill" id="savingPill" style="display:none;">Saving…</span>
    </div>
  </div>

  <div class="grid2">

    <!-- OCCUPANCY -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">
          <strong>Occupancy</strong>
          <span>Each day has an occupancy % and long notes. Click a day to edit (auto loads existing data).</span>
        </div>
        <div class="hint" id="occHint">Guest Service can edit.</div>
      </div>
      <div class="error" id="errorBoxOcc"></div>
      <div style="padding:12px 14px 14px;">
        <div class="sheet" id="sheetOcc"></div>
      </div>
    </section>

    <!-- MEALS -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">
          <strong>Restaurants: Breakfast / Lunch / Dinner</strong>
          <span>Breakfast, Lunch, Dinner = only ONE pick per day. Double click the green selection to clear it.</span>
        </div>
        <div class="hint">Auto-saves after each click.</div>
      </div>
      <div class="error" id="errorBoxMeals"></div>

      <div style="padding:12px 14px 14px;">
        <div class="section-sep">Breakfast</div>
        <div class="sheet" id="sheetBreakfast"></div>

        <div class="section-sep">Lunch</div>
        <div class="sheet" id="sheetLunch"></div>

        <div class="section-sep">Dinner</div>
        <div class="sheet" id="sheetDinner"></div>

        <div class="section-sep">Massimo</div>
        <div class="sheet" id="sheetMassimo"></div>
      </div>
    </section>

    <!-- OUTLETS -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">
          <strong>Outlets</strong>
          <span>Lobby Bar is on top. If open, times are required.</span>
        </div>
        <div class="hint">Outlets open a time/notes editor.</div>
      </div>
      <div class="error" id="errorBoxOutlets"></div>

      <div style="padding:12px 14px 14px;">
        <div class="section-sep">Lobby Bar</div>
        <div class="sheet" id="sheetLobbyBar"></div>

        <div class="section-sep">Other Outlets</div>
        <div class="sheet" id="sheetOutlets"></div>
      </div>
    </section>

  </div>
</div>

<!-- OUTLET MODAL -->
<div class="modal-backdrop" id="modalBackdropOutlet" role="dialog" aria-modal="true">
  <div class="modal" style="width:min(560px,100%);">
    <div class="modal-head">
      <div>
        <strong id="modalTitleOutlet">Outlet</strong>
        <div class="sub" id="modalSubOutlet">Date</div>
      </div>
      <button class="small" id="btnModalCloseOutlet">Close</button>
    </div>
    <div class="modal-body">
      <div class="error" id="errorBoxModalOutlet"></div>

      <div class="toggleRow">
        <label class="switch">
          <input type="checkbox" id="mIsOpen">
          <span class="slider"></span>
        </label>
        <div>
          <div style="font-weight:650" id="mOpenLabel">Closed</div>
          <div class="hint">If open, you must set open & close times.</div>
        </div>
      </div>

      <div class="field">
        <label for="mOpenTime">Open time</label>
        <input type="time" id="mOpenTime" />
      </div>
      <div class="field">
        <label for="mCloseTime">Close time</label>
        <input type="time" id="mCloseTime" />
      </div>
      <div class="field" style="align-items:start;">
        <label for="mNotes" style="padding-top:10px;">Notes</label>
        <textarea id="mNotes" placeholder="Optional"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="muted-btn" id="btnModalCancelOutlet">Cancel</button>
      <button class="primary" id="btnModalSaveOutlet">Save</button>
    </div>
  </div>
</div>

<!-- OCCUPANCY DAY MODAL -->
<div class="modal-backdrop" id="modalBackdropOccDay" role="dialog" aria-modal="true">
  <div class="modal" style="width:min(660px,100%);">
    <div class="modal-head">
      <div>
        <strong id="modalTitleOccDay">Occupancy</strong>
        <div class="sub" id="modalSubOccDay">Date</div>
      </div>
      <button class="small" id="btnModalCloseOccDay">Close</button>
    </div>
    <div class="modal-body">
      <div class="error" id="errorBoxOccDay"></div>

      <div class="field">
        <label for="occPctDay">Occupancy %</label>
        <input type="number" id="occPctDay" min="0" max="100" step="0.01" placeholder="e.g. 74.25" />
      </div>
      <div class="field" style="align-items:start;">
        <label for="occNotesDay" style="padding-top:10px;">Notes</label>
        <textarea id="occNotesDay" placeholder="Long notes (anything important)"></textarea>
      </div>
      <div class="hint" id="occDayHint"></div>
    </div>
    <div class="modal-foot">
      <button class="muted-btn" id="btnModalCancelOccDay">Cancel</button>
      <button class="primary" id="btnModalSaveOccDay">Save</button>
    </div>
  </div>
</div>

<!-- OCCUPANCY WEEK MODAL -->
<div class="modal-backdrop" id="modalBackdropOccWeek" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-head">
      <div>
        <strong>7-day Occupancy Editor</strong>
        <div class="sub" id="modalSubOccWeek">Week</div>
      </div>
      <button class="small" id="btnModalCloseOccWeek">Close</button>
    </div>
    <div class="modal-body">
      <div class="error" id="errorBoxOccWeek"></div>
      <div class="weekGrid" id="occWeekGrid"></div>
      <div class="hint" id="occWeekHint" style="margin-top:10px;"></div>
    </div>
    <div class="modal-foot">
      <button class="muted-btn" id="btnModalCancelOccWeek">Cancel</button>
      <button class="primary" id="btnModalSaveOccWeek">Save week</button>
    </div>
  </div>
</div>

<!-- Scripts (order matters) -->
<script src="./vendor/supabase-js.iife.min.js?v=7"></script>
<script src="./supabase.js?v=7"></script>

<script>
(() => {
  const TZ = "America/Toronto";
  const $ = (id) => document.getElementById(id);

  function errToText(e){
    if(!e) return "Unknown error";
    if(typeof e === "string") return e;
    if(typeof e === "object"){
      const parts = [];
      if(e.message) parts.push(e.message);
      if(e.details) parts.push(e.details);
      if(e.hint) parts.push(e.hint);
      if(e.code) parts.push("Code: " + e.code);
      return parts.filter(Boolean).join("\n");
    }
    return String(e);
  }
  function showErr(msg, boxId){
    const b = $(boxId);
    b.textContent = msg;
    b.style.display = "block";
  }
  function clrErr(boxId){
    const b = $(boxId);
    b.textContent = "";
    b.style.display = "none";
  }

  async function waitForSB(){
    const start = Date.now();
    while(!window.sb){
      if(Date.now() - start > 5000) break;
      await new Promise(r => setTimeout(r, 50));
    }
    if(!window.sb) throw new Error("Supabase client not loaded (window.sb). Check ./supabase.js and vendor file paths.");
  }

  function parseISODate(iso){
    const [y,m,d] = iso.split("-").map(Number);
    return new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  }
  function toISODateUTC(d){
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const day = String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function addDaysUTC(d, days){
    const nd = new Date(d.getTime());
    nd.setUTCDate(nd.getUTCDate() + days);
    return nd;
  }
  function fmtDayLabel(d){
    return new Intl.DateTimeFormat("en-CA", { timeZone: TZ, weekday:"short", month:"short", day:"numeric" }).format(d);
  }
  function todayISO(){
    const parts = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" })
      .formatToParts(new Date());
    const y = parts.find(p=>p.type==="year").value;
    const m = parts.find(p=>p.type==="month").value;
    const d = parts.find(p=>p.type==="day").value;
    return `${y}-${m}-${d}`;
  }
  function normMealGroup(s){
    const t = String(s || "").trim().toLowerCase();
    if(t === "breakfast" || t === "lunch" || t === "dinner") return t;
    if(t.startsWith("massimo")) return t.replace(/\s+/g, "_");
    return t.replace(/\s+/g, "_");
  }

  const state = {
    user: null,
    profile: null,
    startISO: null,
    days: [],
    services: [],
    outlets: [],
    svcMap: new Map(),
    outMap: new Map(),
    occMap: new Map(), // key: occ_date
    saving: 0,
    modalOutlet: null,
    modalOccDay: null,
    canEditOcc: false
  };

  const MEAL_GROUPS = [
    { label:"Breakfast", key:"breakfast", category:"breakfast" },
    { label:"Lunch",     key:"lunch",     category:"lunch" },
    { label:"Dinner",    key:"dinner",    category:"dinner" },
  ];
  const MASSIMO_GROUPS = [
    { label:"Breakfast", key:"massimo_breakfast", item_name:"MASSIMO BREAKFAST" },
    { label:"Lunch",     key:"massimo_lunch", item_name:"MASSIMO LUNCH" },
    { label:"Dinner",    key:"massimo_dinner", item_name:"MASSIMO DINNER" }
  ];

  function keySvc(dateISO, mealGroupKey){ return `${dateISO}|${mealGroupKey}`; }
  function keyOut(dateISO, outletId){ return `${dateISO}|${outletId}`; }

  function setBusy(txt){ $("statusText").textContent = txt; }
  function setSavingUI(){
    const dot = $("dotState");
    dot.classList.remove("ok","warn");
    if(state.saving > 0){
      dot.classList.add("warn");
      $("savingPill").style.display = "inline-flex";
    }else{
      dot.classList.add("ok");
      $("savingPill").style.display = "none";
    }
  }

  async function getSessionUser(){
    const { data, error } = await window.sb.auth.getSession();
    if(error) throw error;
    return data.session?.user || null;
  }
  async function loadProfile(userId){
    const { data, error } = await window.sb
      .from("profiles")
      .select("user_id, full_name, role, department, is_active")
      .eq("user_id", userId)
      .maybeSingle();
    if(error) throw error;
    return data || null;
  }

  async function loadMaster(){
    const [svcRes, outRes] = await Promise.all([
      window.sb.from("service_items")
        .select("id, name, category, sort_order, is_active")
        .eq("is_active", true)
        .order("category", { ascending:true })
        .order("sort_order", { ascending:true })
        .order("name", { ascending:true }),
      window.sb.from("outlet_items")
        .select("id, name, department, sort_order, is_active")
        .eq("is_active", true)
        .order("sort_order", { ascending:true })
        .order("name", { ascending:true })
    ]);
    if(svcRes.error) throw svcRes.error;
    if(outRes.error) throw outRes.error;

    state.services = svcRes.data || [];
    state.outlets  = outRes.data || [];
  }

  function buildDays(startISO){
    const start = parseISODate(startISO);
    state.days = [];
    for(let i=0;i<7;i++){
      const d = addDaysUTC(start, i);
      state.days.push({ iso: toISODateUTC(d), label: fmtDayLabel(d) });
    }
    $("rangeLabel").textContent = `${state.days[0].iso} → ${state.days[6].iso}`;
    $("datePick").value = startISO;
  }

  function servicesByCategory(catLower){
    return state.services.filter(s => String(s.category || "").toLowerCase() === catLower);
  }

  function ensureSvc(dateISO, mealGroupKey){
    const k = keySvc(dateISO, mealGroupKey);
    if(!state.svcMap.has(k)){
      state.svcMap.set(k, { service_date: dateISO, meal_group: mealGroupKey, service_item_id: null, notes: "" });
    }
    return state.svcMap.get(k);
  }
  function ensureOut(dateISO, outletId){
    const k = keyOut(dateISO, outletId);
    if(!state.outMap.has(k)){
      state.outMap.set(k, { outlet_date: dateISO, outlet_item_id: outletId, is_open: false, open_time: null, close_time: null, notes: "" });
    }
    return state.outMap.get(k);
  }
  function ensureOcc(dateISO){
    if(!state.occMap.has(dateISO)){
      state.occMap.set(dateISO, { occ_date: dateISO, occupancy_pct: null, notes: "" });
    }
    return state.occMap.get(dateISO);
  }

  async function loadWeek(){
    clrErr("errorBoxMeals");
    clrErr("errorBoxOutlets");
    clrErr("errorBoxOcc");
    setBusy("Loading week…");

    state.svcMap.clear();
    state.outMap.clear();
    state.occMap.clear();

    const startISO = state.days[0].iso;
    const endISO   = state.days[6].iso;

    const [svcSelRes, outHoursRes, occRes] = await Promise.all([
      window.sb.from("daily_service_selection")
        .select("service_date, meal_group, service_item_id, notes, updated_by, updated_at")
        .gte("service_date", startISO).lte("service_date", endISO),
      window.sb.from("daily_outlet_hours")
        .select("outlet_date, outlet_item_id, is_open, open_time, close_time, notes, updated_by, updated_at")
        .gte("outlet_date", startISO).lte("outlet_date", endISO),
      window.sb.from("daily_occupancy")
        .select("occ_date, occupancy_pct, notes, updated_by, updated_at")
        .gte("occ_date", startISO).lte("occ_date", endISO),
    ]);

    if(svcSelRes.error) throw svcSelRes.error;
    if(outHoursRes.error) throw outHoursRes.error;
    if(occRes.error) throw occRes.error;

    for(const r of (svcSelRes.data || [])){
      const mg = normMealGroup(r.meal_group);
      state.svcMap.set(keySvc(r.service_date, mg), { ...r, meal_group: mg });
    }
    for(const r of (outHoursRes.data || [])){
      state.outMap.set(keyOut(r.outlet_date, r.outlet_item_id), r);
    }
    for(const r of (occRes.data || [])){
      state.occMap.set(r.occ_date, r);
    }

    renderAll();
    setBusy("Ready");
    state.saving = 0;
    setSavingUI();
  }

  function makeTable(headers){
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tr = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.textContent = headers[0];
    tr.appendChild(th0);

    for(let i=1;i<headers.length;i++){
      const th = document.createElement("th");
      th.textContent = headers[i];
      tr.appendChild(th);
    }
    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    table.appendChild(tbody);
    return { table, tbody };
  }

  function cellButton({selected, label, subText, onClick, onDblClick, forceNeutral=false}){
    const btn = document.createElement("div");
    const cls = forceNeutral ? "" : (selected ? "green" : "red");
    btn.className = "cellbtn " + cls;
    btn.innerHTML = `<div><div>${label || ""}</div>${subText ? `<div class="tiny">${subText}</div>` : ""}</div>`;
    btn.addEventListener("click", (e) => { e.preventDefault(); onClick && onClick(); });
    btn.addEventListener("dblclick", (e) => { e.preventDefault(); onDblClick && onDblClick(); });
    return btn;
  }

  // ---- saves
  async function saveServiceOne(dateISO, mealGroupKey){
    try{
      clrErr("errorBoxMeals");
      state.saving++; setSavingUI();

      const rec = ensureSvc(dateISO, mealGroupKey);
      const payload = {
        service_date: dateISO,
        meal_group: mealGroupKey,
        service_item_id: rec.service_item_id || null,
        notes: rec.notes || "",
        updated_by: state.user.id
      };

      const { error } = await window.sb
        .from("daily_service_selection")
        .upsert([payload], { onConflict: "service_date,meal_group" });
      if(error) throw error;
    } catch(e){
      showErr(errToText(e), "errorBoxMeals");
    } finally {
      state.saving = Math.max(0, state.saving - 1);
      setSavingUI();
    }
  }

  async function saveOutletOne(dateISO, outletId){
    try{
      clrErr("errorBoxOutlets");
      state.saving++; setSavingUI();

      const rec = ensureOut(dateISO, outletId);
      const payload = {
        outlet_date: dateISO,
        outlet_item_id: outletId,
        is_open: !!rec.is_open,
        open_time: rec.is_open ? (rec.open_time ? String(rec.open_time).slice(0,5) : null) : null,
        close_time: rec.is_open ? (rec.close_time ? String(rec.close_time).slice(0,5) : null) : null,
        notes: rec.notes || "",
        updated_by: state.user.id
      };

      const { error } = await window.sb
        .from("daily_outlet_hours")
        .upsert([payload], { onConflict: "outlet_date,outlet_item_id" });
      if(error) throw error;
    } catch(e){
      showErr(errToText(e), "errorBoxOutlets");
    } finally {
      state.saving = Math.max(0, state.saving - 1);
      setSavingUI();
    }
  }

  async function saveOccMany(rows){
    try{
      clrErr("errorBoxOcc");
      state.saving++; setSavingUI();

      const payload = rows.map(r => ({
        occ_date: r.occ_date,
        occupancy_pct: (r.occupancy_pct === "" || r.occupancy_pct === null || typeof r.occupancy_pct === "undefined") ? null : Number(r.occupancy_pct),
        notes: r.notes || "",
        updated_by: state.user.id
      }));

      const { error } = await window.sb
        .from("daily_occupancy")
        .upsert(payload, { onConflict: "occ_date" });
      if(error) throw error;
    } catch(e){
      showErr(errToText(e), "errorBoxOcc");
    } finally {
      state.saving = Math.max(0, state.saving - 1);
      setSavingUI();
    }
  }

  // ---- render OCC
  function renderOccSheet(){
    const box = $("sheetOcc");
    box.innerHTML = "";

    const headers = ["Occupancy %", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    const tr = document.createElement("tr");
    const th = document.createElement("th");
    th.innerHTML = `<div>Occupancy</div><div class="row-sub">% + Notes</div>`;
    tr.appendChild(th);

    for(const day of state.days){
      const td = document.createElement("td");
      const rec = ensureOcc(day.iso);
      const pct = (rec.occupancy_pct === null || typeof rec.occupancy_pct === "undefined") ? "" : `${Number(rec.occupancy_pct).toFixed(2)}%`;
      const hasNotes = (rec.notes || "").trim().length > 0;

      td.appendChild(cellButton({
        selected: true,
        forceNeutral: true,
        label: pct || "—",
        subText: hasNotes ? "Has notes" : "No notes",
        onClick: () => openOccDay(day),
        onDblClick: () => openOccDay(day)
      }));
      tr.appendChild(td);
    }

    tbody.appendChild(tr);
    box.appendChild(table);
  }

  // ---- render meals/outlets (same as before)
  function renderMealSheet(containerId, group){
    const box = $(containerId);
    box.innerHTML = "";

    const options = servicesByCategory(group.category);
    const headers = ["Option", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    for(const opt of options){
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.innerHTML = `<div>${opt.name}</div><div class="row-sub">${group.label}</div>`;
      tr.appendChild(th);

      for(const day of state.days){
        const td = document.createElement("td");
        const rec = ensureSvc(day.iso, group.key);
        const isSelected = rec.service_item_id === opt.id;

        td.appendChild(cellButton({
          selected: isSelected,
          label: isSelected ? "Selected" : "Not selected",
          onClick: async () => {
            if(rec.service_item_id !== opt.id){
              rec.service_item_id = opt.id;
              renderMealSheet(containerId, group);
              await saveServiceOne(day.iso, group.key);
            }
          },
          onDblClick: async () => {
            if(rec.service_item_id === opt.id){
              rec.service_item_id = null;
              renderMealSheet(containerId, group);
              await saveServiceOne(day.iso, group.key);
            }
          }
        }));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    box.appendChild(table);
  }

  function renderMassimoSheet(){
    const box = $("sheetMassimo");
    box.innerHTML = "";

    const headers = ["Massimo", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    const nameToItem = new Map();
    for(const s of state.services){
      nameToItem.set(String(s.name || "").toUpperCase(), s);
    }

    for(const row of MASSIMO_GROUPS){
      const item = nameToItem.get(row.item_name);
      if(!item) continue;

      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.innerHTML = `<div>${row.label}</div><div class="row-sub">Massimo (multi-select)</div>`;
      tr.appendChild(th);

      for(const day of state.days){
        const td = document.createElement("td");
        const rec = ensureSvc(day.iso, row.key);
        const selected = rec.service_item_id === item.id;

        td.appendChild(cellButton({
          selected,
          label: selected ? "On" : "Off",
          onClick: async () => {
            rec.service_item_id = selected ? null : item.id;
            renderMassimoSheet();
            await saveServiceOne(day.iso, row.key);
          },
          onDblClick: async () => {
            if(rec.service_item_id === item.id){
              rec.service_item_id = null;
              renderMassimoSheet();
              await saveServiceOne(day.iso, row.key);
            }
          }
        }));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    box.appendChild(table);
  }

  function outletTimeText(rec){
    return (rec.is_open && rec.open_time && rec.close_time)
      ? `${String(rec.open_time).slice(0,5)}–${String(rec.close_time).slice(0,5)}`
      : "";
  }

  function renderOutletsSheet(containerId, outlets){
    const box = $(containerId);
    box.innerHTML = "";

    const headers = ["Outlet", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    for(const outlet of outlets){
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.innerHTML = `<div>${outlet.name}</div><div class="row-sub">${outlet.department || "—"}</div>`;
      tr.appendChild(th);

      for(const day of state.days){
        const td = document.createElement("td");
        const rec = ensureOut(day.iso, outlet.id);
        const selected = !!rec.is_open;

        td.appendChild(cellButton({
          selected,
          label: selected ? "Open" : "Closed",
          subText: outletTimeText(rec),
          onClick: () => openOutletModal(outlet, day),
          onDblClick: () => openOutletModal(outlet, day)
        }));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    box.appendChild(table);
  }

  function renderAll(){
    renderOccSheet();
    renderMealSheet("sheetBreakfast", MEAL_GROUPS[0]);
    renderMealSheet("sheetLunch", MEAL_GROUPS[1]);
    renderMealSheet("sheetDinner", MEAL_GROUPS[2]);
    renderMassimoSheet();

    const lobby = state.outlets.find(o => String(o.name || "").toLowerCase() === "lobby bar");
    const others = state.outlets.filter(o => !lobby || o.id !== lobby.id);

    renderOutletsSheet("sheetLobbyBar", lobby ? [lobby] : []);
    renderOutletsSheet("sheetOutlets", others);
  }

  function setUserUI(){
    const who = $("whoami");
    const btnOut = $("btnSignOut");

    if(!state.user){
      who.textContent = "Not signed in";
      btnOut.style.display = "none";
      return;
    }
    const name = state.profile?.full_name?.trim() || state.user.email || "Signed in";
    const role = state.profile?.role || "user";
    who.textContent = `${name} (${role})`;
    btnOut.style.display = "inline-flex";

    state.canEditOcc = (state.profile?.role === "admin" || state.profile?.role === "manager" || state.profile?.department === "Guest Service");
    $("occHint").textContent = state.canEditOcc ? "You can edit occupancy." : "View only (Guest Service can edit).";
  }

  async function signOut(){
    await window.sb.auth.signOut();
    location.href = "./index.html?v=7";
  }

  // ---------------- OUTLET MODAL ----------------
  function openOutletModal(outlet, day){
    clrErr("errorBoxModalOutlet");
    state.modalOutlet = { outletId: outlet.id, dateISO: day.iso };

    $("modalTitleOutlet").textContent = outlet.name;
    $("modalSubOutlet").textContent = `${day.label} (${day.iso})`;

    const rec = ensureOut(day.iso, outlet.id);

    $("mIsOpen").checked = !!rec.is_open;
    $("mOpenLabel").textContent = rec.is_open ? "Open" : "Closed";
    $("mOpenTime").value = rec.open_time ? String(rec.open_time).slice(0,5) : "";
    $("mCloseTime").value = rec.close_time ? String(rec.close_time).slice(0,5) : "";
    $("mNotes").value = rec.notes || "";

    const setTimesEnabled = (enabled) => {
      $("mOpenTime").disabled = !enabled;
      $("mCloseTime").disabled = !enabled;
    };
    setTimesEnabled(!!rec.is_open);

    $("mIsOpen").onchange = () => {
      const open = $("mIsOpen").checked;
      $("mOpenLabel").textContent = open ? "Open" : "Closed";
      setTimesEnabled(open);
      if(!open){
        $("mOpenTime").value = "";
        $("mCloseTime").value = "";
      }
    };

    $("modalBackdropOutlet").style.display = "flex";
  }

  function closeOutletModal(){ $("modalBackdropOutlet").style.display = "none"; state.modalOutlet = null; }

  function validateOutlet(open, openTime, closeTime){
    if(!open) return null;
    if(!openTime || !closeTime) return "If open, you must enter open time and close time.";
    if(String(closeTime).slice(0,5) <= String(openTime).slice(0,5)) return "Close time must be after open time.";
    return null;
  }

  async function saveOutletModal(){
    clrErr("errorBoxModalOutlet");
    const outletId = state.modalOutlet?.outletId;
    const dateISO = state.modalOutlet?.dateISO;
    if(!outletId || !dateISO) return;

    const open = $("mIsOpen").checked;
    const openTime = $("mOpenTime").value || null;
    const closeTime = $("mCloseTime").value || null;
    const notes = $("mNotes").value || "";

    const msg = validateOutlet(open, openTime, closeTime);
    if(msg){ showErr(msg, "errorBoxModalOutlet"); return; }

    const rec = ensureOut(dateISO, outletId);
    rec.is_open = open;
    rec.open_time = open ? openTime : null;
    rec.close_time = open ? closeTime : null;
    rec.notes = notes;

    closeOutletModal();
    renderAll();
    await saveOutletOne(dateISO, outletId);
  }

  // ---------------- OCCUPANCY (DAY) ----------------
  function openOccDay(day){
    clrErr("errorBoxOccDay");
    state.modalOccDay = { dateISO: day.iso, label: day.label };

    const rec = ensureOcc(day.iso);

    $("modalTitleOccDay").textContent = "Occupancy";
    $("modalSubOccDay").textContent = `${day.label} (${day.iso})`;
    $("occPctDay").value = (rec.occupancy_pct === null || typeof rec.occupancy_pct === "undefined") ? "" : Number(rec.occupancy_pct);
    $("occNotesDay").value = rec.notes || "";

    const ro = !state.canEditOcc;
    $("occPctDay").disabled = ro;
    $("occNotesDay").disabled = ro;
    $("btnModalSaveOccDay").disabled = ro;
    $("occDayHint").textContent = ro ? "View only. Guest Service (or admin/manager) can edit." : "Editing enabled.";

    $("modalBackdropOccDay").style.display = "flex";
  }
  function closeOccDay(){ $("modalBackdropOccDay").style.display = "none"; state.modalOccDay = null; }

  async function saveOccDay(){
    clrErr("errorBoxOccDay");
    if(!state.canEditOcc){ showErr("You do not have permission to edit occupancy.", "errorBoxOccDay"); return; }

    const dateISO = state.modalOccDay?.dateISO;
    if(!dateISO) return;

    const pctRaw = $("occPctDay").value;
    const notes = $("occNotesDay").value || "";
    const pct = (pctRaw === "" ? null : Number(pctRaw));

    if(pct !== null && (isNaN(pct) || pct < 0 || pct > 100)){
      showErr("Occupancy % must be between 0 and 100.", "errorBoxOccDay");
      return;
    }

    const rec = ensureOcc(dateISO);
    rec.occupancy_pct = pct;
    rec.notes = notes;

    closeOccDay();
    renderOccSheet();
    await saveOccMany([rec]);
  }

  // ---------------- OCCUPANCY (WEEK) ----------------
  function openOccWeek(){
    clrErr("errorBoxOccWeek");
    $("modalSubOccWeek").textContent = `${state.days[0].iso} → ${state.days[6].iso}`;

    const ro = !state.canEditOcc;
    $("btnModalSaveOccWeek").disabled = ro;
    $("occWeekHint").textContent = ro ? "View only. Guest Service (or admin/manager) can edit." : "Edit each day, then Save week.";

    const headers = ["Day", "Date", "Occupancy %", "Notes"];
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    headers.forEach(h => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
    thead.appendChild(trh);
    table.appendChild(thead);
    const tbody = document.createElement("tbody");

    for(const day of state.days){
      const rec = ensureOcc(day.iso);

      const tr = document.createElement("tr");
      const tdDay = document.createElement("th");
      tdDay.textContent = day.label;
      tr.appendChild(tdDay);

      const tdDate = document.createElement("td");
      tdDate.textContent = day.iso;
      tr.appendChild(tdDate);

      const tdPct = document.createElement("td");
      const inp = document.createElement("input");
      inp.type = "number";
      inp.min = "0";
      inp.max = "100";
      inp.step = "0.01";
      inp.value = (rec.occupancy_pct === null || typeof rec.occupancy_pct === "undefined") ? "" : Number(rec.occupancy_pct);
      inp.disabled = ro;
      inp.dataset.iso = day.iso;
      inp.className = "occWeekPct";
      tdPct.appendChild(inp);
      tr.appendChild(tdPct);

      const tdNotes = document.createElement("td");
      const ta = document.createElement("textarea");
      ta.value = rec.notes || "";
      ta.disabled = ro;
      ta.dataset.iso = day.iso;
      ta.className = "occWeekNotes";
      tdNotes.appendChild(ta);
      tr.appendChild(tdNotes);

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    const grid = $("occWeekGrid");
    grid.innerHTML = "";
    grid.appendChild(table);

    $("modalBackdropOccWeek").style.display = "flex";
  }
  function closeOccWeek(){ $("modalBackdropOccWeek").style.display = "none"; }

  async function saveOccWeek(){
    clrErr("errorBoxOccWeek");
    if(!state.canEditOcc){ showErr("You do not have permission to edit occupancy.", "errorBoxOccWeek"); return; }

    const pctInputs = Array.from(document.querySelectorAll(".occWeekPct"));
    const noteInputs = Array.from(document.querySelectorAll(".occWeekNotes"));

    const mapPct = new Map(pctInputs.map(i => [i.dataset.iso, i.value]));
    const mapNotes = new Map(noteInputs.map(t => [t.dataset.iso, t.value]));

    const rows = [];
    for(const day of state.days){
      const pctRaw = mapPct.get(day.iso) ?? "";
      const notes = mapNotes.get(day.iso) ?? "";

      const pct = (pctRaw === "" ? null : Number(pctRaw));
      if(pct !== null && (isNaN(pct) || pct < 0 || pct > 100)){
        showErr(`Invalid occupancy % for ${day.iso}. Must be 0–100.`, "errorBoxOccWeek");
        return;
      }

      const rec = ensureOcc(day.iso);
      rec.occupancy_pct = pct;
      rec.notes = notes;
      rows.push(rec);
    }

    closeOccWeek();
    renderOccSheet();
    await saveOccMany(rows);
  }

  // ---- init
  async function init(){
    try{
      await waitForSB();
      setBusy("Checking sign-in…");

      state.user = await getSessionUser();
      if(!state.user){
        location.href = "./index.html?v=7";
        return;
      }

      state.profile = await loadProfile(state.user.id);
      setUserUI();

      setBusy("Loading lists…");
      await loadMaster();

      state.startISO = todayISO();
      buildDays(state.startISO);

      await loadWeek();
      setBusy("Ready");
    } catch(e){
      console.error(e);
      setBusy("Error");
      showErr(errToText(e), "errorBoxMeals");
      $("whoami").textContent = "Error";
    }
  }

  // nav
  $("btnPrev").addEventListener("click", async () => {
    const d = parseISODate(state.startISO);
    state.startISO = toISODateUTC(addDaysUTC(d, -7));
    buildDays(state.startISO);
    await loadWeek();
  });
  $("btnNext").addEventListener("click", async () => {
    const d = parseISODate(state.startISO);
    state.startISO = toISODateUTC(addDaysUTC(d, 7));
    buildDays(state.startISO);
    await loadWeek();
  });
  $("btnToday").addEventListener("click", async () => {
    state.startISO = todayISO();
    buildDays(state.startISO);
    await loadWeek();
  });
  $("datePick").addEventListener("change", async () => {
    const iso = $("datePick").value;
    if(iso){
      state.startISO = iso;
      buildDays(state.startISO);
      await loadWeek();
    }
  });

  // buttons
  $("btnSignOut").addEventListener("click", signOut);
  $("btnEditWeekOcc").addEventListener("click", openOccWeek);

  // outlet modal events
  $("btnModalCloseOutlet").addEventListener("click", closeOutletModal);
  $("btnModalCancelOutlet").addEventListener("click", closeOutletModal);
  $("btnModalSaveOutlet").addEventListener("click", saveOutletModal);
  $("modalBackdropOutlet").addEventListener("click", (e) => { if(e.target === $("modalBackdropOutlet")) closeOutletModal(); });

  // occ day modal events
  $("btnModalCloseOccDay").addEventListener("click", closeOccDay);
  $("btnModalCancelOccDay").addEventListener("click", closeOccDay);
  $("btnModalSaveOccDay").addEventListener("click", saveOccDay);
  $("modalBackdropOccDay").addEventListener("click", (e) => { if(e.target === $("modalBackdropOccDay")) closeOccDay(); });

  // occ week modal events
  $("btnModalCloseOccWeek").addEventListener("click", closeOccWeek);
  $("btnModalCancelOccWeek").addEventListener("click", closeOccWeek);
  $("btnModalSaveOccWeek").addEventListener("click", saveOccWeek);
  $("modalBackdropOccWeek").addEventListener("click", (e) => { if(e.target === $("modalBackdropOccWeek")) closeOccWeek(); });

  init();
})();
</script>
</body>
</html>
