<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>F&B Outlets (Grid)</title>

  <style>
    :root{
      --bg:#f6f8ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius:18px;

      --green:#16a34a;
      --greenSoft: rgba(22,163,74,.12);
      --red:#dc2626;
      --redSoft: rgba(220,38,38,.10);
      --blue:#2563eb;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 10% 0%, #e9efff 0%, rgba(233,239,255,0) 60%),
        radial-gradient(900px 600px at 90% 10%, #e9fff6 0%, rgba(233,255,246,0) 55%),
        var(--bg);
    }
    header{ padding:22px 18px 10px; max-width:1320px; margin:0 auto; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      box-shadow: var(--shadow);
    }
    h1{ font-size:18px; margin:0; line-height:1.2; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:2px; }

    .pill{
      font-size:12px; padding:6px 10px; border:1px solid var(--line);
      border-radius:999px; background:#fff; color:var(--muted);
    }
    .wrap{ max-width:1320px; margin:0 auto; padding:10px 18px 34px; }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    input[type="date"]{
      border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; font-size:13px; outline:none; background:#fff;
    }
    button{
      border:1px solid var(--line); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:13px; cursor:pointer;
      transition: transform .04s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{ background:#f8fafc; }
    button:active{ transform: translateY(1px); }
    .primary{
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border-color: transparent; color:#fff;
    }
    .primary:hover{ background: linear-gradient(135deg, #1d4ed8, #1e40af); }
    .small{ padding:8px 10px; border-radius:10px; font-size:12px; }
    .muted-btn{ color:var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.9);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card-title strong{ font-size:14px; }
    .card-title span{ display:block; font-size:12px; color:var(--muted); margin-top:4px; }

    .status{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#94a3b8; }
    .dot.ok{ background:#22c55e; }
    .dot.warn{ background:#f59e0b; }

    .error{
      display:none;
      margin:12px 14px 0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #fecaca;
      background:#fff1f2;
      color:#9f1239;
      font-size:13px;
      white-space:pre-wrap;
    }

    /* Snapshot area for PDF */
    #snapshot{
      padding:12px 14px 14px;
    }

    /* Spreadsheet-like grid */
    .sheet{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:auto;
      max-height: 70vh;
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px;
    }
    thead th{
      position:sticky;
      top:0;
      z-index:3;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      padding:10px 10px;
      text-align:center;
      white-space:nowrap;
    }
    thead th:first-child{
      position:sticky;
      left:0;
      z-index:4;
      text-align:left;
    }
    tbody td, tbody th{
      border-bottom:1px solid var(--line);
      border-right:1px solid var(--line);
      padding:8px;
      vertical-align:middle;
    }
    tbody tr:last-child td, tbody tr:last-child th{ border-bottom:none; }
    tbody td:last-child, thead th:last-child{ border-right:none; }

    tbody th{
      position:sticky;
      left:0;
      z-index:2;
      background:#fff;
      text-align:left;
      font-size:13px;
      font-weight:650;
      min-width: 260px;
    }
    .row-sub{
      font-size:12px;
      font-weight:500;
      color:var(--muted);
      margin-top:2px;
    }

    .cellbtn{
      width:100%;
      min-height:46px;
      border-radius:12px;
      border:1px solid rgba(226,232,240,.9);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 10px;
      user-select:none;
      transition: transform .04s ease, filter .15s ease, border-color .15s ease;
      font-size:12px;
      text-align:center;
      line-height:1.15;
      background:#fff;
    }
    .cellbtn:active{ transform: translateY(1px); }
    .cellbtn.green{
      background: var(--greenSoft);
      border-color: rgba(22,163,74,.45);
      color: #14532d;
    }
    .cellbtn.red{
      background: var(--redSoft);
      border-color: rgba(220,38,38,.35);
      color: #7f1d1d;
    }
    .cellbtn .tiny{
      display:block;
      font-size:11px;
      color: rgba(15,23,42,.65);
      margin-top:3px;
    }
    .dirty-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:8px;height:8px;
      border-radius:999px;
      background: var(--blue);
      margin-left:6px;
      opacity:.9;
    }

    .section-sep{
      margin:12px 0 8px;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .section-sep:before{
      content:"";
      height:1px;
      flex:1;
      background: var(--line);
    }
    .section-sep:after{
      content:"";
      height:1px;
      flex:1;
      background: var(--line);
    }

    /* Outlet edit modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid rgba(226,232,240,.9);
      box-shadow: 0 30px 80px rgba(15,23,42,.25);
      overflow:hidden;
    }
    .modal-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .modal-head strong{ font-size:14px; }
    .modal-head .sub{ font-size:12px; color:var(--muted); margin-top:3px; }
    .modal-body{ padding:12px 14px 14px; }
    .modal-foot{
      padding:12px 14px 14px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      background: linear-gradient(180deg, #ffffff, #fbfdff);
    }
    .field{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .field label{ font-size:12px; color:var(--muted); }
    input[type="time"], textarea{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
      width:100%;
      background:#fff;
    }
    textarea{ min-height:70px; resize:vertical; }
    .toggleRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-bottom:12px;
    }
    .switch{
      position:relative;
      width:44px; height:24px;
      display:inline-block;
      flex:0 0 auto;
    }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background:#e2e8f0;
      border-radius:999px;
      transition:.15s ease;
      border:1px solid #cbd5e1;
    }
    .slider:before{
      content:"";
      position:absolute;
      height:18px; width:18px;
      left:3px; top:2px;
      background:#fff;
      border-radius:50%;
      box-shadow: 0 4px 10px rgba(15,23,42,.15);
      transition:.15s ease;
    }
    .switch input:checked + .slider{
      background: rgba(22,163,74,.25);
      border-color: rgba(22,163,74,.45);
    }
    .switch input:checked + .slider:before{
      transform: translateX(20px);
    }
    .hint{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>F&B Outlets</h1>
        <div class="subtitle">Click the grid: green = selected/open, red = not selected/closed.</div>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <span class="pill" id="whoami">Loading…</span>
      <button class="muted-btn small" id="btnSignOut" style="display:none;">Sign out</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="toolbar">
    <div class="controls">
      <button class="small" id="btnPrev">← Prev 7</button>
      <button class="small" id="btnToday">Today</button>
      <button class="small" id="btnNext">Next 7 →</button>
      <input type="date" id="datePick" />
    </div>

    <div class="controls">
      <span class="status"><span class="dot" id="dotState"></span><span id="statusText">Loading…</span></span>
      <span class="pill" id="rangeLabel"></span>
      <span class="pill" id="unsavedPill" style="display:none;">Unsaved changes</span>
      <button class="primary" id="btnSaveAll">Save all</button>
      <button class="small" id="btnPdf">Download PDF snapshot</button>
    </div>
  </div>

  <div class="grid2">
    <!-- MEALS -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">
          <strong>Restaurants: Breakfast / Lunch / Dinner</strong>
          <span>Breakfast, Lunch, Dinner = only ONE pick per day.</span>
        </div>
        <div class="hint">Tip: click a different option to switch it.</div>
      </div>
      <div class="error" id="errorBoxMeals"></div>

      <div id="snapshot">
        <div class="section-sep">Breakfast</div>
        <div class="sheet" id="sheetBreakfast"></div>

        <div class="section-sep">Lunch</div>
        <div class="sheet" id="sheetLunch"></div>

        <div class="section-sep">Dinner</div>
        <div class="sheet" id="sheetDinner"></div>

        <div class="section-sep">Massimo</div>
        <div class="sheet" id="sheetMassimo"></div>
      </div>
    </section>

    <!-- OUTLETS -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">
          <strong>Outlets: Open / Closed + Times</strong>
          <span>Click a cell to set open/closed. If open, times are required.</span>
        </div>
        <div class="hint">Green shows times inside the cell.</div>
      </div>
      <div class="error" id="errorBoxOutlets"></div>

      <div style="padding:12px 14px 14px;">
        <div class="sheet" id="sheetOutlets"></div>
      </div>
    </section>
  </div>
</div>

<!-- Outlet modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-head">
      <div>
        <strong id="modalTitle">Outlet</strong>
        <div class="sub" id="modalSub">Date</div>
      </div>
      <button class="small" id="btnModalClose">Close</button>
    </div>
    <div class="modal-body">
      <div class="error" id="errorBoxModal"></div>

      <div class="toggleRow">
        <label class="switch">
          <input type="checkbox" id="mIsOpen">
          <span class="slider"></span>
        </label>
        <div>
          <div style="font-weight:650" id="mOpenLabel">Closed</div>
          <div class="hint">If open, you must set open & close times.</div>
        </div>
      </div>

      <div class="field">
        <label for="mOpenTime">Open time</label>
        <input type="time" id="mOpenTime" />
      </div>
      <div class="field">
        <label for="mCloseTime">Close time</label>
        <input type="time" id="mCloseTime" />
      </div>
      <div class="field" style="align-items:start;">
        <label for="mNotes" style="padding-top:10px;">Notes</label>
        <textarea id="mNotes" placeholder="Optional"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="muted-btn" id="btnModalCancel">Cancel</button>
      <button class="primary" id="btnModalSave">Save</button>
    </div>
  </div>
</div>

<!-- IMPORTANT: scripts load at the END (prevents window.sb timing issues) -->
<script src="vendor/supabase-js.iife.min.js"></script>
<script src="supabase.js"></script>
<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(() => {
  const TZ = "America/Toronto";
  const $ = (id) => document.getElementById(id);

  function showErr(msg, boxId){
    const b = $(boxId);
    b.textContent = msg;
    b.style.display = "block";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function clrErr(boxId){
    const b = $(boxId);
    b.textContent = "";
    b.style.display = "none";
  }

  function parseISODate(iso){
    const [y,m,d] = iso.split("-").map(Number);
    return new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  }
  function toISODateUTC(d){
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const day = String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function addDaysUTC(d, days){
    const nd = new Date(d.getTime());
    nd.setUTCDate(nd.getUTCDate() + days);
    return nd;
  }
  function fmtDayLabel(d){
    return new Intl.DateTimeFormat("en-CA", { timeZone: TZ, weekday:"short", month:"short", day:"numeric" }).format(d);
  }
  function todayISO(){
    const parts = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" })
      .formatToParts(new Date());
    const y = parts.find(p=>p.type==="year").value;
    const m = parts.find(p=>p.type==="month").value;
    const d = parts.find(p=>p.type==="day").value;
    return `${y}-${m}-${d}`;
  }

  async function waitForSB(){
    const start = Date.now();
    while(!window.sb){
      if(Date.now() - start > 4000) break;
      await new Promise(r => setTimeout(r, 50));
    }
    if(!window.sb) throw new Error("Supabase client not found (window.sb). Check supabase.js.");
  }

  const state = {
    user: null,
    profile: null,
    startISO: null,
    days: [],

    services: [],      // service_items
    outlets: [],       // outlet_items

    // Maps for week
    svcMap: new Map(), // key: date|meal_group -> record {service_item_id, notes}
    outMap: new Map(), // key: date|outlet_item_id -> record {is_open, open_time, close_time, notes}

    // Dirty keys
    dirtySvc: new Set(),
    dirtyOut: new Set(),

    // Modal context
    modal: { outletId:null, dateISO:null }
  };

  const MEAL_GROUPS = ["Breakfast", "Lunch", "Dinner"];
  const MASSIMO_GROUPS = [
    { meal_group: "Massimo Breakfast", item_name: "MASSIMO BREAKFAST" },
    { meal_group: "Massimo Lunch",     item_name: "MASSIMO LUNCH" },
    { meal_group: "Massimo Dinner",    item_name: "MASSIMO DINNER" }
  ];

  function keySvc(dateISO, mealGroup){ return `${dateISO}|${mealGroup}`; }
  function keyOut(dateISO, outletId){ return `${dateISO}|${outletId}`; }

  function setBusy(txt){ $("statusText").textContent = txt; }
  function updateDirtyUI(){
    const dirtyCount = state.dirtySvc.size + state.dirtyOut.size;
    $("unsavedPill").style.display = dirtyCount ? "inline-flex" : "none";
    const dot = $("dotState");
    dot.classList.remove("ok","warn");
    dot.classList.add(dirtyCount ? "warn" : "ok");
  }

  async function getSessionUser(){
    const { data, error } = await window.sb.auth.getSession();
    if(error) throw error;
    return data.session?.user || null;
  }
  async function loadProfile(userId){
    const { data, error } = await window.sb
      .from("profiles")
      .select("user_id, full_name, role, department, is_active")
      .eq("user_id", userId)
      .maybeSingle();
    if(error) throw error;
    return data || null;
  }

  async function loadMaster(){
    // Only active
    const [svcRes, outRes] = await Promise.all([
      window.sb.from("service_items")
        .select("id, name, category, sort_order, is_active")
        .eq("is_active", true)
        .order("category", { ascending:true })
        .order("sort_order", { ascending:true })
        .order("name", { ascending:true }),
      window.sb.from("outlet_items")
        .select("id, name, department, sort_order, is_active")
        .eq("is_active", true)
        .order("sort_order", { ascending:true })
        .order("name", { ascending:true })
    ]);
    if(svcRes.error) throw svcRes.error;
    if(outRes.error) throw outRes.error;

    state.services = svcRes.data || [];
    state.outlets  = outRes.data || [];
  }

  function buildDays(startISO){
    const start = parseISODate(startISO);
    state.days = [];
    for(let i=0;i<7;i++){
      const d = addDaysUTC(start, i);
      state.days.push({ iso: toISODateUTC(d), label: fmtDayLabel(d) });
    }
    $("rangeLabel").textContent = `${state.days[0].iso} → ${state.days[6].iso}`;
    $("datePick").value = startISO;
  }

  function ensureSvc(dateISO, meal_group){
    const k = keySvc(dateISO, meal_group);
    if(!state.svcMap.has(k)){
      state.svcMap.set(k, {
        service_date: dateISO,
        meal_group,
        service_item_id: null,
        notes: ""
      });
    }
    return state.svcMap.get(k);
  }

  function ensureOut(dateISO, outletId){
    const k = keyOut(dateISO, outletId);
    if(!state.outMap.has(k)){
      state.outMap.set(k, {
        outlet_date: dateISO,
        outlet_item_id: outletId,
        is_open: false,
        open_time: null,
        close_time: null,
        notes: ""
      });
    }
    return state.outMap.get(k);
  }

  async function loadWeek(){
    clrErr("errorBoxMeals");
    clrErr("errorBoxOutlets");
    setBusy("Loading week…");

    state.svcMap.clear();
    state.outMap.clear();
    state.dirtySvc.clear();
    state.dirtyOut.clear();
    updateDirtyUI();

    const startISO = state.days[0].iso;
    const endISO   = state.days[6].iso;

    const [svcSelRes, outHoursRes] = await Promise.all([
      window.sb.from("daily_service_selection")
        .select("service_date, meal_group, service_item_id, notes, updated_by, updated_at")
        .gte("service_date", startISO).lte("service_date", endISO),
      window.sb.from("daily_outlet_hours")
        .select("outlet_date, outlet_item_id, is_open, open_time, close_time, notes, updated_by, updated_at")
        .gte("outlet_date", startISO).lte("outlet_date", endISO),
    ]);
    if(svcSelRes.error) throw svcSelRes.error;
    if(outHoursRes.error) throw outHoursRes.error;

    for(const r of (svcSelRes.data || [])){
      state.svcMap.set(keySvc(r.service_date, r.meal_group), r);
    }
    for(const r of (outHoursRes.data || [])){
      state.outMap.set(keyOut(r.outlet_date, r.outlet_item_id), r);
    }

    renderAll();
    setBusy("Ready");
    updateDirtyUI();
  }

  function servicesByCategory(cat){
    const lc = cat.toLowerCase();
    return state.services.filter(s => String(s.category || "").toLowerCase() === lc);
  }

  function makeTable(headers){
    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tr = document.createElement("tr");

    // first col header
    const th0 = document.createElement("th");
    th0.textContent = headers[0];
    tr.appendChild(th0);

    for(let i=1;i<headers.length;i++){
      const th = document.createElement("th");
      th.textContent = headers[i];
      tr.appendChild(th);
    }

    thead.appendChild(tr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    table.appendChild(tbody);

    return { table, tbody };
  }

  function cellButton({selected, label, subText, onClick, dirty=false}){
    const btn = document.createElement("div");
    btn.className = "cellbtn " + (selected ? "green" : "red");
    btn.innerHTML = `<div><div>${label || ""}${dirty ? `<span class="dirty-badge" title="Unsaved"></span>` : ""}</div>${subText ? `<div class="tiny">${subText}</div>` : ""}</div>`;
    btn.addEventListener("click", onClick);
    return btn;
  }

  function renderMealSheet(containerId, mealGroup){
    const box = $(containerId);
    box.innerHTML = "";

    const options = servicesByCategory(mealGroup); // category Breakfast/Lunch/Dinner
    const headers = ["Option", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    for(const opt of options){
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.innerHTML = `<div>${opt.name}</div><div class="row-sub">${mealGroup}</div>`;
      tr.appendChild(th);

      for(const day of state.days){
        const td = document.createElement("td");
        const rec = ensureSvc(day.iso, mealGroup);
        const isSelected = rec.service_item_id === opt.id;
        const k = keySvc(day.iso, mealGroup);
        const isDirty = state.dirtySvc.has(k);

        td.appendChild(cellButton({
          selected: isSelected,
          label: isSelected ? "Selected" : "Not selected",
          subText: "",
          dirty: isDirty && isSelected,
          onClick: () => {
            // Only one option per day: just set service_item_id to this option
            rec.service_item_id = opt.id;
            rec.notes = rec.notes || "";
            state.dirtySvc.add(k);
            updateDirtyUI();
            renderMealSheet(containerId, mealGroup); // re-render this sheet so only one stays green
          }
        }));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    box.appendChild(table);
  }

  function renderMassimoSheet(){
    const box = $("sheetMassimo");
    box.innerHTML = "";

    const headers = ["Massimo", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    // Build mapping for Massimo items by name
    const nameToItem = new Map();
    for(const s of state.services){
      nameToItem.set(String(s.name || "").toUpperCase(), s);
    }

    for(const row of MASSIMO_GROUPS){
      const item = nameToItem.get(row.item_name);
      if(!item) continue; // if missing, skip

      const tr = document.createElement("tr");
      const th = document.createElement("th");
      th.innerHTML = `<div>${row.item_name.replace("MASSIMO ","")}</div><div class="row-sub">Massimo (multi-select)</div>`;
      tr.appendChild(th);

      for(const day of state.days){
        const td = document.createElement("td");
        const rec = ensureSvc(day.iso, row.meal_group);
        const selected = rec.service_item_id === item.id;
        const k = keySvc(day.iso, row.meal_group);
        const isDirty = state.dirtySvc.has(k);

        td.appendChild(cellButton({
          selected,
          label: selected ? "On" : "Off",
          subText: "",
          dirty: isDirty,
          onClick: () => {
            // toggle (multi-select across the 3 meal_groups)
            rec.service_item_id = selected ? null : item.id;
            state.dirtySvc.add(k);
            updateDirtyUI();
            renderMassimoSheet();
          }
        }));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    box.appendChild(table);
  }

  function renderOutletsSheet(){
    const box = $("sheetOutlets");
    box.innerHTML = "";

    // Your request: specifically include these. We'll show all active, but the new ones are included.
    // If you only want the F&B ones, uncomment filter.
    // const outlets = state.outlets.filter(o => (o.department || "") === "F&B");
    const outlets = state.outlets;

    const headers = ["Outlet", ...state.days.map(d => d.label)];
    const { table, tbody } = makeTable(headers);

    for(const outlet of outlets){
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.innerHTML = `<div>${outlet.name}</div><div class="row-sub">${outlet.department || "—"}</div>`;
      tr.appendChild(th);

      for(const day of state.days){
        const td = document.createElement("td");
        const rec = ensureOut(day.iso, outlet.id);
        const selected = !!rec.is_open;
        const k = keyOut(day.iso, outlet.id);
        const isDirty = state.dirtyOut.has(k);

        const timeText = (rec.is_open && rec.open_time && rec.close_time)
          ? `${String(rec.open_time).slice(0,5)}–${String(rec.close_time).slice(0,5)}`
          : "";

        td.appendChild(cellButton({
          selected,
          label: selected ? "Open" : "Closed",
          subText: timeText,
          dirty: isDirty,
          onClick: () => {
            // Always open modal (so times are handled right)
            openOutletModal(outlet, day);
          }
        }));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    box.appendChild(table);
  }

  function renderAll(){
    renderMealSheet("sheetBreakfast", "Breakfast");
    renderMealSheet("sheetLunch", "Lunch");
    renderMealSheet("sheetDinner", "Dinner");
    renderMassimoSheet();
    renderOutletsSheet();
  }

  function setUserUI(){
    const who = $("whoami");
    const btnOut = $("btnSignOut");

    if(!state.user){
      who.textContent = "Not signed in";
      btnOut.style.display = "none";
      return;
    }
    const name = state.profile?.full_name?.trim() || state.user.email || "Signed in";
    const role = state.profile?.role || "user";
    who.textContent = `${name} (${role})`;
    btnOut.style.display = "inline-flex";
  }

  async function signOut(){
    await window.sb.auth.signOut();
    location.href = "index.html";
  }

  // ---- Outlet modal logic ----
  function openOutletModal(outlet, day){
    clrErr("errorBoxModal");

    state.modal.outletId = outlet.id;
    state.modal.dateISO = day.iso;

    $("modalTitle").textContent = outlet.name;
    $("modalSub").textContent = `${day.label} (${day.iso})`;

    const rec = ensureOut(day.iso, outlet.id);

    $("mIsOpen").checked = !!rec.is_open;
    $("mOpenLabel").textContent = rec.is_open ? "Open" : "Closed";
    $("mOpenTime").value = rec.open_time ? String(rec.open_time).slice(0,5) : "";
    $("mCloseTime").value = rec.close_time ? String(rec.close_time).slice(0,5) : "";
    $("mNotes").value = rec.notes || "";

    // Disable times when closed
    const setTimesEnabled = (enabled) => {
      $("mOpenTime").disabled = !enabled;
      $("mCloseTime").disabled = !enabled;
    };
    setTimesEnabled(!!rec.is_open);

    $("mIsOpen").onchange = () => {
      const open = $("mIsOpen").checked;
      $("mOpenLabel").textContent = open ? "Open" : "Closed";
      setTimesEnabled(open);
      if(!open){
        $("mOpenTime").value = "";
        $("mCloseTime").value = "";
      }
    };

    $("modalBackdrop").style.display = "flex";
  }

  function closeOutletModal(){
    $("modalBackdrop").style.display = "none";
    state.modal.outletId = null;
    state.modal.dateISO = null;
  }

  function validateOutlet(open, openTime, closeTime){
    if(!open) return null;
    if(!openTime || !closeTime) return "If open, you must enter open time and close time.";
    if(String(closeTime).slice(0,5) <= String(openTime).slice(0,5)) return "Close time must be after open time.";
    return null;
  }

  function saveOutletModal(){
    clrErr("errorBoxModal");
    const outletId = state.modal.outletId;
    const dateISO = state.modal.dateISO;
    if(!outletId || !dateISO) return;

    const open = $("mIsOpen").checked;
    const openTime = $("mOpenTime").value || null;
    const closeTime = $("mCloseTime").value || null;
    const notes = $("mNotes").value || "";

    const msg = validateOutlet(open, openTime, closeTime);
    if(msg){
      showErr(msg, "errorBoxModal");
      return;
    }

    const rec = ensureOut(dateISO, outletId);
    rec.is_open = open;
    rec.open_time = open ? openTime : null;
    rec.close_time = open ? closeTime : null;
    rec.notes = notes;

    state.dirtyOut.add(keyOut(dateISO, outletId));
    updateDirtyUI();

    closeOutletModal();
    renderOutletsSheet();
  }

  // ---- Save to Supabase ----
  async function saveAll(){
    clrErr("errorBoxMeals");
    clrErr("errorBoxOutlets");
    setBusy("Saving…");

    try{
      // Save services
      if(state.dirtySvc.size){
        const rows = [];
        for(const k of state.dirtySvc){
          const [dateISO, mealGroup] = k.split("|");
          const rec = ensureSvc(dateISO, mealGroup);

          rows.push({
            service_date: dateISO,
            meal_group: mealGroup,
            service_item_id: rec.service_item_id || null,
            notes: rec.notes || "",
            updated_by: state.user.id
          });
        }

        const { error } = await window.sb
          .from("daily_service_selection")
          .upsert(rows, { onConflict: "service_date,meal_group" });

        if(error) throw error;
        state.dirtySvc.clear();
      }

      // Save outlets
      if(state.dirtyOut.size){
        const rows = [];
        for(const k of state.dirtyOut){
          const [dateISO, outletId] = k.split("|");
          const rec = ensureOut(dateISO, outletId);

          // UI already validates, DB also has constraint
          rows.push({
            outlet_date: dateISO,
            outlet_item_id: outletId,
            is_open: !!rec.is_open,
            open_time: rec.is_open ? (rec.open_time ? String(rec.open_time).slice(0,5) : null) : null,
            close_time: rec.is_open ? (rec.close_time ? String(rec.close_time).slice(0,5) : null) : null,
            notes: rec.notes || "",
            updated_by: state.user.id
          });
        }

        const { error } = await window.sb
          .from("daily_outlet_hours")
          .upsert(rows, { onConflict: "outlet_date,outlet_item_id" });

        if(error) throw error;
        state.dirtyOut.clear();
      }

      updateDirtyUI();
      setBusy("Saved");
      // Re-load to show final saved data
      await loadWeek();
    } catch(e){
      console.error(e);
      const msg = String(e?.message || e);
      // Split where to show
      showErr(msg, "errorBoxOutlets");
      setBusy("Save failed");
    }
  }

  async function downloadPdf(){
    setBusy("Preparing PDF…");
    await new Promise(r => setTimeout(r, 60));

    const canvas = await window.html2canvas(document.querySelector(".wrap"), {
      backgroundColor: "#ffffff",
      scale: 2,
      useCORS: true
    });

    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "pt", "letter");

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();

    const imgW = pageW;
    const imgH = canvas.height * (imgW / canvas.width);

    let y = 0;
    let remaining = imgH;

    while(remaining > 0){
      pdf.addImage(imgData, "PNG", 0, y, imgW, imgH);
      remaining -= pageH;
      if(remaining > 0){
        pdf.addPage();
        y -= pageH;
      }
    }

    pdf.save(`FNB_Grid_${state.days[0].iso}_to_${state.days[6].iso}.pdf`);
    setBusy("PDF downloaded");
  }

  async function changeStart(newISO){
    state.startISO = newISO;
    buildDays(state.startISO);
    await loadWeek();
  }

  async function init(){
    try{
      setBusy("Checking sign-in…");
      await waitForSB();

      state.user = await getSessionUser();
      if(!state.user){
        setUserUI();
        setBusy("Not signed in");
        showErr("You are not signed in. Go to your home page and sign in first.", "errorBoxMeals");
        return;
      }

      state.profile = await loadProfile(state.user.id);
      setUserUI();

      setBusy("Loading lists…");
      await loadMaster();

      state.startISO = todayISO();
      buildDays(state.startISO);

      await loadWeek();
      setBusy("Ready");
      updateDirtyUI();
    } catch(e){
      console.error(e);
      setBusy("Error");
      showErr(String(e?.message || e), "errorBoxMeals");
      $("whoami").textContent = "Error";
    }
  }

  // Events
  $("btnPrev").addEventListener("click", async () => {
    const d = parseISODate(state.startISO);
    await changeStart(toISODateUTC(addDaysUTC(d, -7)));
  });
  $("btnNext").addEventListener("click", async () => {
    const d = parseISODate(state.startISO);
    await changeStart(toISODateUTC(addDaysUTC(d, 7)));
  });
  $("btnToday").addEventListener("click", async () => changeStart(todayISO()));
  $("datePick").addEventListener("change", async () => {
    const iso = $("datePick").value;
    if(iso) await changeStart(iso);
  });

  $("btnSaveAll").addEventListener("click", saveAll);
  $("btnPdf").addEventListener("click", downloadPdf);
  $("btnSignOut").addEventListener("click", signOut);

  $("btnModalClose").addEventListener("click", closeOutletModal);
  $("btnModalCancel").addEventListener("click", closeOutletModal);
  $("btnModalSave").addEventListener("click", saveOutletModal);
  $("modalBackdrop").addEventListener("click", (e) => {
    if(e.target === $("modalBackdrop")) closeOutletModal();
  });

  init();
})();
</script>
</body>
</html>
