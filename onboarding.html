<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Onboarding</title>

  <!-- Load order matters -->
  <script defer src="vendor/supabase-js.iife.min.js"></script>
  <script defer src="supabase.js"></script>

  <style>
    :root{
      --bg1:#f6f9ff; --bg2:#ffffff; --card:#fff; --text:#0f172a; --muted:#64748b;
      --line:#e2e8f0; --btn:#2563eb; --bad:#b91c1c; --good:#15803d;
      --shadow:0 10px 30px rgba(2,6,23,.10); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #dbeafe 0%, transparent 55%),
                  radial-gradient(1000px 700px at 100% 20%, #e9d5ff 0%, transparent 50%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{width:100%; max-width:720px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .dot{
      width:12px; height:12px; border-radius:999px; background:var(--btn);
      box-shadow: 0 0 0 6px rgba(37,99,235,.15);
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line); background:rgba(255,255,255,.65);
      padding:6px 10px; border-radius:999px;
      max-width:60vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.8);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .header{
      padding:18px 18px 12px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(37,99,235,.10), transparent);
    }
    .header h1{margin:0; font-size:22px;}
    .header p{margin:8px 0 0 0; color:var(--muted); font-size:14px; line-height:1.35;}
    .body{padding:18px;}
    .panel{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:rgba(255,255,255,.7);
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.65);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width: 760px){ .row{grid-template-columns:1fr;} }

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    button{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:900;
      cursor:pointer;
      font-size:14px;
    }
    .btn{background:var(--btn); color:#fff;}
    .ghost{background:transparent; border:1px solid var(--line); color:var(--text); font-weight:900;}
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
      display:none;
      line-height:1.35;
    }
    .msg.bad{border-color: rgba(185,28,28,.35); background: rgba(185,28,28,.06); color: var(--bad);}
    .msg.good{border-color: rgba(21,128,61,.35); background: rgba(21,128,61,.06); color: var(--good);}

    .footer{
      padding:14px 18px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      color:var(--muted); font-size:12px;
    }
    a{color:var(--btn); text-decoration:none; font-weight:900;}
    a:hover{text-decoration:underline;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> PM Maintenance</div>
      <div class="pill" id="whoPill">Checking login…</div>
    </div>

    <div class="card">
      <div class="header">
        <h1>Finish setup</h1>
        <p>Enter your full name, choose your department, and set your password. Role is set to <b>user</b>.</p>
      </div>

      <div class="body">
        <div class="panel">
          <label for="fullName">Full name</label>
          <input id="fullName" type="text" placeholder="First + Last name" />

          <label for="department">Department</label>
          <select id="department">
            <option value="">Select…</option>
            <option>Engineering</option>
            <option>Front Desk</option>
            <option>Housekeeping</option>
            <option>Food &amp; Beverage</option>
            <option>Security</option>
            <option>Sales</option>
            <option>Other</option>
          </select>

          <div class="row">
            <div>
              <label for="newPwd">New password</label>
              <input id="newPwd" type="password" autocomplete="new-password" placeholder="Min 8 characters" />
            </div>
            <div>
              <label for="newPwd2">Confirm password</label>
              <input id="newPwd2" type="password" autocomplete="new-password" placeholder="Repeat password" />
            </div>
          </div>

          <div class="actions">
            <button id="btnComplete" class="btn">Complete Setup</button>
            <button id="btnSignOut" class="ghost" type="button">Sign Out</button>
          </div>

          <div id="msgBox" class="msg"></div>
        </div>
      </div>

      <div class="footer">
        <div>After setup, you’ll go back automatically.</div>
        <div><a href="index.html">Home</a></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const nowIso = () => new Date().toISOString();

    function showMsg(text, kind) {
      const el = $("msgBox");
      el.className = "msg" + (kind ? (" " + kind) : "");
      el.textContent = text;
      el.style.display = "block";
    }
    function clearMsg() {
      const el = $("msgBox");
      el.style.display = "none";
      el.textContent = "";
      el.className = "msg";
    }

    function safeNext() {
      // Only allow same-site relative next (prevents weird redirects)
      const url = new URL(window.location.href);
      const next = url.searchParams.get("next") || "index.html";
      if (next.startsWith("http://") || next.startsWith("https://")) return "index.html";
      if (next.startsWith("//")) return "index.html";
      return next;
    }

    async function getUserOrKick() {
      const { data, error } = await window.sb.auth.getUser();
      if (error || !data?.user) {
        window.location.href = "index.html";
        return null;
      }
      return data.user;
    }

    async function getProfile(userId) {
      const { data, error } = await window.sb
        .from("profiles")
        .select("user_id, full_name, department, onboarding_completed")
        .eq("user_id", userId)
        .maybeSingle();
      if (error) return null;
      return data || null;
    }

    async function markInviteAcceptedIfExists(user) {
      try {
        const email = (user.email || "").toLowerCase();
        if (!email) return;

        const sel = await window.sb
          .from("user_invites")
          .select("id")
          .ilike("email", email)
          .is("accepted_at", null)
          .order("invite_sent_at", { ascending: false })
          .limit(1);

        if (sel.error) return;
        const inviteId = sel.data?.[0]?.id;
        if (!inviteId) return;

        await window.sb
          .from("user_invites")
          .update({ accepted_at: nowIso(), accepted_user_id: user.id })
          .eq("id", inviteId);
      } catch (_) {}
    }

    (async function init() {
      clearMsg();

      if (!window.sb) {
        alert("Supabase client not found. Make sure supabase.js loads and sets window.sb.");
        return;
      }

      const user = await getUserOrKick();
      if (!user) return;

      $("whoPill").textContent = user.email ? `Signed in: ${user.email}` : "Signed in";

      // Prefill if profile exists
      const prof = await getProfile(user.id);
      if (prof?.onboarding_completed) {
        window.location.href = safeNext();
        return;
      }
      if (prof?.full_name) $("fullName").value = prof.full_name;
      if (prof?.department) $("department").value = prof.department;

      $("btnSignOut").addEventListener("click", async () => {
        await window.sb.auth.signOut();
        window.location.href = "index.html";
      });

      $("btnComplete").addEventListener("click", async () => {
        clearMsg();

        const full_name = ($("fullName").value || "").trim();
        const department = ($("department").value || "").trim();
        const p1 = $("newPwd").value || "";
        const p2 = $("newPwd2").value || "";

        if (!full_name) return showMsg("Please enter your full name.", "bad");
        if (!department) return showMsg("Please select your department.", "bad");
        if (p1.length < 8) return showMsg("Password must be at least 8 characters.", "bad");
        if (p1 !== p2) return showMsg("Passwords do not match.", "bad");

        $("btnComplete").disabled = true;

        try {
          // 1) Set password
          const pw = await window.sb.auth.updateUser({ password: p1 });
          if (pw.error) throw pw.error;

          // 2) Save profile (role forced to 'user')
          const row = {
            user_id: user.id,
            email: user.email || null,
            full_name,
            department,
            role: "user",
            is_active: true,
            password_set_at: nowIso(),
            profile_completed_at: nowIso(),
            onboarding_completed: true
          };

          const up = await window.sb
            .from("profiles")
            .upsert(row, { onConflict: "user_id" })
            .select()
            .single();

          if (up.error) throw up.error;

          // Optional invite tracking
          await markInviteAcceptedIfExists(user);

          showMsg("Setup complete. Redirecting…", "good");
          setTimeout(() => (window.location.href = safeNext()), 500);

        } catch (e) {
          console.error(e);
          showMsg(e?.message || "Setup failed.", "bad");
          $("btnComplete").disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
