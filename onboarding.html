<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Onboarding</title>

  <!-- Required (your repo already uses this pattern) -->
  <script defer src="vendor/supabase-js.iife.min.js"></script>
  <script defer src="supabase.js"></script>

  <style>
    :root{
      --bg1:#f6f9ff;
      --bg2:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --btn:#2563eb;
      --btn2:#0f172a;
      --bad:#b91c1c;
      --good:#15803d;
      --shadow: 0 10px 30px rgba(2,6,23,.10);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #dbeafe 0%, transparent 55%),
                  radial-gradient(1000px 700px at 100% 20%, #e9d5ff 0%, transparent 50%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{width:100%; max-width:900px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900;}
    .dot{
      width:12px; height:12px; border-radius:999px; background:var(--btn);
      box-shadow: 0 0 0 6px rgba(37,99,235,.15);
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line); background:rgba(255,255,255,.65);
      padding:6px 10px; border-radius:999px;
      max-width:55vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .card{
      background:var(--card);
      border:1px solid rgba(226,232,240,.8);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .header{
      padding:18px 18px 12px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(37,99,235,.10), transparent);
    }
    .header h1{margin:0; font-size:22px;}
    .header p{margin:8px 0 0 0; color:var(--muted); font-size:14px; line-height:1.35;}
    .steps{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    .step{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.7);
    }
    .step.done{border-color: rgba(21,128,61,.35); color: var(--good); background: rgba(21,128,61,.06);}
    .step.active{border-color: rgba(37,99,235,.45); color: var(--btn); background: rgba(37,99,235,.06);}

    .body{
      padding:18px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }
    @media (max-width: 900px){ .body{grid-template-columns:1fr;} }

    .panel{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:rgba(255,255,255,.7);
    }
    .panel h2{margin:0 0 10px 0; font-size:16px;}
    .small{font-size:12px; color:var(--muted); margin-top:6px;}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.65);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width: 900px){ .row{grid-template-columns:1fr;} }

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    button{
      border:0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:800;
      cursor:pointer;
      font-size:14px;
    }
    .btn{background:var(--btn); color:#fff;}
    .btn2{background:var(--btn2); color:#fff;}
    .ghost{background:transparent; border:1px solid var(--line); color:var(--text); font-weight:800;}
    .btn:disabled, .btn2:disabled{opacity:.55; cursor:not-allowed;}

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      font-size:13px;
      display:none;
      line-height:1.35;
    }
    .msg.good{border-color: rgba(21,128,61,.35); background: rgba(21,128,61,.06); color: var(--good);}
    .msg.bad{border-color: rgba(185,28,28,.35); background: rgba(185,28,28,.06); color: var(--bad);}

    .footer{
      padding:14px 18px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    a{color:var(--btn); text-decoration:none; font-weight:800;}
    a:hover{text-decoration:underline;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> PM Maintenance</div>
      <div class="pill" id="whoPill">Checking login…</div>
    </div>

    <div class="card">
      <div class="header">
        <h1>Welcome — quick setup</h1>
        <p>Set a new password and fill in your profile. Then you’ll be sent to the home page.</p>

        <div class="steps">
          <span id="chipPwd" class="step active">1) Password</span>
          <span id="chipProfile" class="step">2) Profile</span>
          <span id="chipDone" class="step">Done</span>
        </div>
      </div>

      <div class="body">
        <!-- Password -->
        <div class="panel">
          <h2>Step 1 — Set a new password</h2>
          <div class="small">This updates your Supabase Auth password.</div>

          <label for="newPwd">New password</label>
          <input id="newPwd" type="password" autocomplete="new-password" placeholder="Min 8 characters" />

          <label for="newPwd2">Confirm password</label>
          <input id="newPwd2" type="password" autocomplete="new-password" placeholder="Repeat password" />

          <div class="actions">
            <button id="btnSetPwd" class="btn">Save Password</button>
            <button id="btnSignOut" class="ghost" title="Sign out and go back to login">Sign Out</button>
          </div>

          <div id="msgPwd" class="msg"></div>
        </div>

        <!-- Profile -->
        <div class="panel">
          <h2>Step 2 — Complete your profile</h2>
          <div class="small">This saves into <b>public.profiles</b> (user_id, full_name, role, department, phone).</div>

          <div class="row">
            <div>
              <label for="fullName">Full name</label>
              <input id="fullName" type="text" placeholder="First + Last name" />
            </div>
            <div>
              <label for="phone">Phone (optional)</label>
              <input id="phone" type="tel" placeholder="(###) ###-####" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="role">Role</label>
              <select id="role">
                <option value="">Select…</option>
                <option>Admin</option>
                <option>Manager</option>
                <option>Engineer</option>
                <option>Front Desk</option>
                <option>F&amp;B</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="dept">Department</label>
              <select id="dept">
                <option value="">Select…</option>
                <option>Engineering</option>
                <option>Front Desk</option>
                <option>Housekeeping</option>
                <option>Food &amp; Beverage</option>
                <option>Security</option>
                <option>Sales</option>
                <option>Other</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button id="btnSaveProfile" class="btn2" disabled>Save Profile</button>
            <a class="ghost" style="padding:11px 14px; border-radius:12px; display:inline-block;" href="index.html">Back to Home</a>
          </div>

          <div id="msgProfile" class="msg"></div>
        </div>
      </div>

      <div class="footer">
        <div>Tip: add <b>onboarding.html</b> to Supabase Auth Redirect URLs.</div>
        <div><a href="index.html">Home</a></div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // Helpers
    // -------------------------
    const $ = (id) => document.getElementById(id);

    function showMsg(boxId, text, kind) {
      const el = $(boxId);
      el.className = "msg" + (kind ? (" " + kind) : "");
      el.textContent = text;
      el.style.display = "block";
    }
    function clearMsg(boxId) {
      const el = $(boxId);
      el.style.display = "none";
      el.textContent = "";
      el.className = "msg";
    }

    function setChips(state) {
      // state: "pwd" | "profile" | "done"
      const cPwd = $("chipPwd");
      const cPro = $("chipProfile");
      const cDone = $("chipDone");

      cPwd.className = "step";
      cPro.className = "step";
      cDone.className = "step";

      if (state === "pwd") cPwd.className = "step active";
      if (state === "profile") cPro.className = "step active";
      if (state === "done") cDone.className = "step active";
    }

    function markDone(chipId) {
      const el = $(chipId);
      el.className = "step done";
    }

    function nowIso() {
      return new Date().toISOString();
    }

    // -------------------------
    // Supabase
    // -------------------------
    function getClient() {
      // Your supabase.js should set window.sb
      if (!window.sb) throw new Error("Supabase client not found. Make sure supabase.js loads and sets window.sb.");
      return window.sb;
    }

    async function getUserOrRedirect(sb) {
      const { data, error } = await sb.auth.getUser();
      if (error || !data?.user) {
        window.location.href = "index.html";
        return null;
      }
      return data.user;
    }

    async function loadProfile(sb, user) {
      const { data, error } = await sb
        .from("profiles")
        .select("user_id,email,full_name,role,department,is_active,phone,onboarding_completed,password_set_at,profile_completed_at")
        .eq("user_id", user.id)
        .maybeSingle();

      // If no row yet, that’s fine
      if (error) {
        // If table exists but RLS blocks, you’ll see it here
        console.warn("loadProfile error:", error);
        return null;
      }
      return data || null;
    }

    async function upsertProfile(sb, row) {
      // Uses your existing key: user_id
      return sb
        .from("profiles")
        .upsert(row, { onConflict: "user_id" })
        .select()
        .single();
    }

    async function markInviteAcceptedIfExists(sb, user) {
      // If user_invites table exists, mark the latest pending invite as accepted.
      // If the table doesn't exist, just ignore.
      try {
        const email = (user.email || "").toLowerCase();
        if (!email) return;

        const sel = await sb
          .from("user_invites")
          .select("id")
          .ilike("email", email)
          .is("accepted_at", null)
          .order("invite_sent_at", { ascending: false })
          .limit(1);

        if (sel.error) {
          // Probably table not there or RLS blocks it
          return;
        }
        const inviteId = sel.data?.[0]?.id;
        if (!inviteId) return;

        await sb
          .from("user_invites")
          .update({ accepted_at: nowIso(), accepted_user_id: user.id })
          .eq("id", inviteId);

      } catch (e) {
        // ignore
      }
    }

    // -------------------------
    // Page logic
    // -------------------------
    (async function init() {
      let sb;
      try {
        sb = getClient();
      } catch (e) {
        alert(e.message);
        return;
      }

      const user = await getUserOrRedirect(sb);
      if (!user) return;

      $("whoPill").textContent = user.email ? `Signed in: ${user.email}` : `Signed in`;

      // Load existing profile (if any)
      const profile = await loadProfile(sb, user);

      // If already onboarded, just go home
      if (profile?.onboarding_completed) {
        window.location.href = "index.html";
        return;
      }

      // Prefill profile fields if already exists
      if (profile) {
        $("fullName").value = profile.full_name || "";
        $("phone").value = profile.phone || "";
        $("role").value = profile.role || "";
        $("dept").value = profile.department || "";
      }

      // If password was already set earlier, allow profile step
      if (profile?.password_set_at) {
        markDone("chipPwd");
        setChips("profile");
        $("btnSaveProfile").disabled = false;
      } else {
        setChips("pwd");
      }

      // Hook buttons
      $("btnSignOut").addEventListener("click", async () => {
        await sb.auth.signOut();
        window.location.href = "index.html";
      });

      $("btnSetPwd").addEventListener("click", async () => {
        clearMsg("msgPwd");

        const p1 = $("newPwd").value || "";
        const p2 = $("newPwd2").value || "";

        if (p1.length < 8) {
          showMsg("msgPwd", "Password must be at least 8 characters.", "bad");
          return;
        }
        if (p1 !== p2) {
          showMsg("msgPwd", "Passwords do not match.", "bad");
          return;
        }

        $("btnSetPwd").disabled = true;

        try {
          const res = await sb.auth.updateUser({ password: p1 });
          if (res.error) throw res.error;

          // Save password_set_at in profiles
          const row = {
            user_id: user.id,
            email: user.email || null,
            password_set_at: nowIso(),
            onboarding_completed: false
          };

          const up = await upsertProfile(sb, row);
          if (up.error) throw up.error;

          showMsg("msgPwd", "Password saved. Now complete your profile.", "good");
          markDone("chipPwd");
          setChips("profile");
          $("btnSaveProfile").disabled = false;

          // Clear password fields
          $("newPwd").value = "";
          $("newPwd2").value = "";

        } catch (e) {
          console.error(e);
          showMsg("msgPwd", (e?.message || "Failed to save password."), "bad");
        } finally {
          $("btnSetPwd").disabled = false;
        }
      });

      $("btnSaveProfile").addEventListener("click", async () => {
        clearMsg("msgProfile");

        const full_name = ($("fullName").value || "").trim();
        const phone = ($("phone").value || "").trim();
        const role = ($("role").value || "").trim();
        const department = ($("dept").value || "").trim();

        if (!full_name) {
          showMsg("msgProfile", "Please enter your full name.", "bad");
          return;
        }
        if (!role) {
          showMsg("msgProfile", "Please select a role.", "bad");
          return;
        }
        if (!department) {
          showMsg("msgProfile", "Please select a department.", "bad");
          return;
        }

        $("btnSaveProfile").disabled = true;

        try {
          const row = {
            user_id: user.id,
            email: user.email || null,
            full_name,
            role,
            department,
            phone: phone || null,
            is_active: true,
            profile_completed_at: nowIso(),
            onboarding_completed: true
          };

          const up = await upsertProfile(sb, row);
          if (up.error) throw up.error;

          // Invite tracking (if table exists)
          await markInviteAcceptedIfExists(sb, user);

          showMsg("msgProfile", "Profile saved. Sending you to the home page…", "good");
          markDone("chipProfile");
          setChips("done");
          markDone("chipDone");

          setTimeout(() => {
            window.location.href = "index.html";
          }, 900);

        } catch (e) {
          console.error(e);
          showMsg("msgProfile", (e?.message || "Failed to save profile."), "bad");
          $("btnSaveProfile").disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
